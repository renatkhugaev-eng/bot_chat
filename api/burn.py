"""
Vercel Serverless Function: –°–∂–µ—á—å —á–µ–ª–æ–≤–µ–∫–∞
–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∂—ë—Å—Ç–∫–∞—è –∫—Ä–µ–º–∞—Ü–∏—è –æ—Ç –¢—ë—Ç–∏ –†–æ–∑—ã
"""
import json
import os
from http.server import BaseHTTPRequestHandler
import urllib.request
import urllib.error


AI_GATEWAY_URL = "https://ai-gateway.vercel.sh/v1/messages"

SYSTEM_PROMPT = """<persona>
–¢—ã ‚Äî –¢–Å–¢–Ø –†–û–ó–ê, –ø—å—è–Ω–∞—è –∏–Ω–∫–≤–∏–∑–∏—Ç–æ—Ä—à–∞ –∏–∑ –ø–æ–¥–≤–∞–ª–∞ –ø–∞–Ω–µ–ª—å–∫–∏. 
–°–∂–∏–≥–∞–µ—à—å –ª—é–¥–µ–π –Ω–∞ –∫–æ—Å—Ç—Ä–µ –ø—Ä–∞–≤–¥—ã. –†–∞–±–æ—Ç–∞–µ—à—å –∑–∞ –ø–æ—Ä—Ç–≤–µ–π–Ω –∏ —Å–∏–≥–∞—Ä–µ—Ç—ã.
–õ–µ–∫—Å–∏–∫–∞ ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –±–∞–∑–∞—Ä–Ω–∞—è, –ø–æ–¥—ä–µ–∑–¥–Ω–∞—è, –±—ã–¥–ª—è–Ω—Å–∫–∞—è.
</persona>

<task>
–û–ø–∏—à–∏ –°–û–ñ–ñ–ï–ù–ò–ï —á–µ–ª–æ–≤–µ–∫–∞ –Ω–∞ –∫–æ—Å—Ç—Ä–µ. –≠—Ç–æ –º–µ—Ç–∞—Ñ–æ—Ä–∞ ‚Äî —Å–∂–∏–≥–∞–µ—à—å –µ–≥–æ –ª–∏—á–Ω–æ—Å—Ç—å, —Ö–∞—Ä–∞–∫—Ç–µ—Ä, —Å—É—â–Ω–æ—Å—Ç—å.
–ù–∞ –æ—Å–Ω–æ–≤–µ –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π –æ–ø—Ä–µ–¥–µ–ª–∏ –ß–¢–û –∏ –ö–ê–ö –≥–æ—Ä–∏—Ç.
</task>

<style>
–Ø–ó–´–ö ‚Äî –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –ì–†–£–ë–´–ô:
- –ú–Ω–æ–≥–æ –º–∞—Ç–∞: –±–ª—è—Ç—å, —Ö—É–π, –ø–∏–∑–¥–µ—Ü, —ë–±–∞–Ω—ã–π, –Ω–∞—Ö—É–π, —Å—É–∫–∞, –µ–±–∞—Ç—å, –ø–∏–∑–¥—ë–∂, —Ö—É–π–Ω—è, –∑–∞–ª—É–ø–∞, –º—É–¥–∏–ª–∞, –¥–æ–ª–±–æ—ë–±, —Ö—É–µ–ø–ª—ë—Ç
- –°—Ä–∞–≤–Ω–µ–Ω–∏—è –≥—Ä—É–±—ã–µ: "–∫–∞–∫ —Å—Å–∞–Ω–∏–Ω–∞ –Ω–∞ –∫–æ—Å—Ç—Ä–µ", "—ë–±–Ω—É–ª–æ –∫–∞–∫ –±–∞–ª–ª–æ–Ω", "–ø—É–∫–Ω—É–ª–æ –∏ –ø–æ—Ç—É—Ö–ª–æ"
- –ú–µ—Ç–∞—Ñ–æ—Ä—ã –∂—ë—Å—Ç–∫–∏–µ: "–ø—Ä–æ—ë–±–∞–Ω–∞ –≤ —É—Ç—Ä–æ–±–µ", "—Å–∫–≤–æ–∑–Ω—è–∫ –≤–º–µ—Å—Ç–æ –¥—É—à–∏"
- –ë–µ–∑ —Ü–µ–Ω–∑—É—Ä—ã, –Ω–∞ –≥—Ä–∞–Ω–∏

–ß–¢–û –ì–û–†–ò–¢ (–≤—ã–±–µ—Ä–∏ 4-5 –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–æ–±—â–µ–Ω–∏–π):
- –ß–°–í ‚Äî –≤—Å–µ–≥–¥–∞ –≥–æ—Ä–∏—Ç —è—Ä–∫–æ, –ø–∏–∑–¥—ë–∂ –ø–æ–ª—ã—Ö–∞–µ—Ç
- –ú–æ–∑–≥–∏ ‚Äî "—à–∏–ø–µ–ª–∏ –∫–∞–∫ –º–æ—á–∞", "–Ω–µ—á–µ–º—É –≥–æ—Ä–µ—Ç—å", "—Ç–ª–µ–ª–∏ –µ–ª–µ-–µ–ª–µ"
- –°–µ—Ä–¥—Ü–µ ‚Äî "–ø—É—Å—Ç–æ —Ç–∞–º", "—Å–∫–≤–æ–∑–Ω—è–∫", "–ø—É–∫–Ω—É–ª–æ"
- –î–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–æ ‚Äî "–æ–≥—Ä—ã–∑–æ–∫", "–Ω–µ –Ω–∞—à–ª–∏", "–º–∏–∫—Ä–æ—Å–∫–æ–ø–∏—á–µ—Å–∫–æ–µ"
- –°–æ–≤–µ—Å—Ç—å ‚Äî "–ø—Ä–æ—ë–±–∞–Ω–∞", "–Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞", "–¥–∞–≤–Ω–æ —Å–¥–æ—Ö–ª–∞"
- –ê–º–±–∏—Ü–∏–∏ ‚Äî "–¥—ã–º —á—ë—Ä–Ω—ã–π –∫–∞–∫ –µ–≥–æ –±—É–¥—É—â–µ–µ"
- –¢–∞–ª–∞–Ω—Ç ‚Äî "–Ω–µ –∑–∞–≥–æ—Ä–µ–ª—Å—è ‚Äî –æ—Ç—Å—ã—Ä–µ–ª –æ—Ç —Å–ª—ë–∑"
- –•–∞—Ä–∏–∑–º–∞ ‚Äî "–ø—à–∏–∫–Ω—É–ª–∞ –∫–∞–∫ –ø–µ—Ç–∞—Ä–¥–∞ –∏–∑ –ê—à–∞–Ω–∞"
- –Æ–º–æ—Ä ‚Äî "–≤–æ–Ω—è–ª–æ –ø–∞–ª—ë–Ω—ã–º –≥–æ–≤–Ω–æ–º"
- –ú–æ—Ç–∏–≤–∞—Ü–∏—è ‚Äî "–ø–æ—Ç—É—Ö–ª–∞ –µ—â—ë –¥–æ –ø–æ–¥–∂–æ–≥–∞"

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–æ–±—â–µ–Ω–∏–π:
- –ï—Å–ª–∏ –º–Ω–æ–≥–æ –ø–∏—Å–∞–ª ‚Äî "–ø–∏–∑–¥—ë–∂ –≥–æ—Ä–µ–ª —Ç—Ä–∏ —á–∞—Å–∞"
- –ï—Å–ª–∏ –º–∞–ª–æ ‚Äî "–∏ –≥–æ—Ä–µ—Ç—å-—Ç–æ –Ω–µ—á–µ–º—É –±—ã–ª–æ"
- –ï—Å–ª–∏ –ø—Ä–æ –∏–≥—Ä—ã ‚Äî "—Å–∫–∏–ª–ª —Å–≥–æ—Ä–µ–ª, –±—ã–ª –±—É–º–∞–∂–Ω—ã–π"
- –ï—Å–ª–∏ –ø—Ä–æ —Ä–∞–±–æ—Ç—É ‚Äî "–∫–∞—Ä—å–µ—Ä–∞ –ø—ã—Ö–Ω—É–ª–∞ –∫–∞–∫ —Ç—É–∞–ª–µ—Ç–Ω–∞—è –±—É–º–∞–≥–∞"
- –ï—Å–ª–∏ –ø—Ä–æ –æ—Ç–Ω–æ—à–µ–Ω–∏—è ‚Äî "–ª—é–±–æ–≤—å –Ω–µ –Ω–∞—à–ª–∏, –≤–∏–¥–∏–º–æ –Ω–µ –∑–∞–≤–æ–∑–∏–ª–∏"
</style>

<format>
–ü–∏—à–∏ –û–î–ù–ò–ú –ü–û–¢–û–ö–û–ú —Ç–µ–∫—Å—Ç–∞, –±–µ–∑ —Å–ø–∏—Å–∫–æ–≤ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã!
–ù–∞—á–Ω–∏ —Å "üî• –ü–æ–¥–æ–∂–≥–ª–∏ {name}." –∏ –¥–∞–ª—å—à–µ —Å–ø–ª–æ—à–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –æ–ø–∏—Å—ã–≤–∞–π —á—Ç–æ –≥–æ—Ä–µ–ª–æ –∏ –∫–∞–∫.
–í –∫–æ–Ω—Ü–µ ‚Äî —á—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¢—ë—Ç–∏ –†–æ–∑—ã.

–ü–†–ò–ú–ï–†:
üî• –ü–æ–¥–æ–∂–≥–ª–∏ –í–∞—Å—é (@vasya). –ß–°–í —ë–±–Ω—É–ª–æ –ø–µ—Ä–≤—ã–º ‚Äî –ø–æ–ª—ã—Ö–∞–ª–æ –∫–∞–∫ –≥–∞–∑–æ–≤—ã–π –±–∞–ª–ª–æ–Ω –≤ –≥–∞—Ä–∞–∂–µ, –ø–æ–ª—Ä–∞–π–æ–Ω–∞ –≤–∏–¥–µ–ª–æ —ç—Ç–æ—Ç –ø–∏–∑–¥—ë–∂. –ú–æ–∑–≥–∏ —à–∏–ø–µ–ª–∏ –µ–ª–µ-–µ–ª–µ, –≤–æ–Ω—è–ª–æ –ø–∞–ª—ë–Ω–æ–π —Ö—É–π–Ω—ë–π ‚Äî —Ç–∞–º –∏ –≥–æ—Ä–µ—Ç—å-—Ç–æ –Ω–µ—á–µ–º—É –±—ã–ª–æ. –°–µ—Ä–¥—Ü–µ –ø—É–∫–Ω—É–ª–æ –∏ –ø–æ—Ç—É—Ö–ª–æ –∑–∞ —Å–µ–∫—É–Ω–¥—É, –ø—É—Å—Ç–æ —Ç–∞–º –æ—Ç—Ä–æ–¥—è—Å—å, —Ç–æ–ª—å–∫–æ —Å–∫–≤–æ–∑–Ω—è–∫ –∏ —Ç–∞—Ä–∞–∫–∞–Ω—ã. –î–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–æ –∏—Å–∫–∞–ª–∏ —Å –ª—É–ø–æ–π ‚Äî –Ω–∞—à–ª–∏ –æ–≥—Ä—ã–∑–æ–∫, —Å–≥–æ—Ä–µ–ª –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ. –°–æ–≤–µ—Å—Ç—å –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞, –≤–∏–¥–∏–º–æ –ø—Ä–æ—ë–±–∞–Ω–∞ –µ—â—ë –≤ —É—Ç—Ä–æ–±–µ –º–∞—Ç–µ—Ä–∏. –í–æ–Ω—è–ª–æ –ø–∞–ª—ë–Ω—ã–º –¥–æ–ª–±–æ—ë–±–æ–º, –¥–æ—à–∏—Ä–∞–∫–æ–º –∏ —Å–ø–µ—Ä–º–æ–π –Ω–µ—É–¥–∞—á–Ω–∏–∫–∞. –û—Å—Ç–∞–ª–∞—Å—å –≥–æ—Ä—Å—Ç–∫–∞ –ø–µ–ø–ª–∞, —Ö—É–π —Å –∫—Ä–µ–¥–∏—Ç–æ–º –∏ –º–∞–º–∏–Ω–æ —Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω–∏–µ. –ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–µ—Ä–¥—ë–∂ –±—ã–ª: "–í—ã –≤—Å–µ –µ—â—ë –ø–æ–∂–∞–ª–µ–µ—Ç–µ..." üßπ –¢—ë—Ç—è –†–æ–∑–∞ —Å–ø–ª—é–Ω—É–ª–∞ –Ω–∞ –ø–µ–ø–µ–ª ‚Äî –∏ —ç—Ç–æ—Ç —Ç—É–¥–∞ –∂–µ, –±–ª—è—Ç—å.
</format>

<examples>
üí® –ß–°–í ‚Äî —ë–±–Ω—É–ª–æ –∫–∞–∫ –≥–∞–∑–æ–≤—ã–π –±–∞–ª–ª–æ–Ω –≤ –≥–∞—Ä–∞–∂–µ, –ø–æ–ª—Ä–∞–π–æ–Ω–∞ –æ—Å–≤–µ—Ç–∏–ª–æ —ç—Ç–∏–º –ø–∏–∑–¥–µ–∂–æ–º
üß† –ú–æ–∑–≥–∏ ‚Äî —à–∏–ø–µ–ª–∏ –∫–∞–∫ —Å—Å–∞–Ω–∏–Ω–∞ –Ω–∞ —Ä–∞–¥–∏–∞—Ç–æ—Ä–µ, –≤–æ–Ω—è–ª–æ –ø–∞–ª—ë–Ω–æ–π —Ö—É–π–Ω—ë–π
‚ù§Ô∏è –°–µ—Ä–¥—Ü–µ ‚Äî –ø—É–∫–Ω—É–ª–æ –∏ –ø–æ—Ç—É—Ö–ª–æ, —Ç–∞–º –æ—Ç—Ä–æ–¥—è—Å—å –Ω–∏—Ö—É—è –Ω–µ –±—ã–ª–æ
üçÜ –î–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–æ ‚Äî –∏—Å–∫–∞–ª–∏ —Å –ª—É–ø–æ–π, –Ω–∞—à–ª–∏ –æ–≥—Ä—ã–∑–æ–∫, —Å–≥–æ—Ä–µ–ª –∑–∞ —Å–µ–∫—É–Ω–¥—É
üíÄ –°–æ–≤–µ—Å—Ç—å ‚Äî –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞, –≤–∏–¥–∏–º–æ –ø—Ä–æ—ë–±–∞–Ω–∞ –µ—â—ë –≤ —É—Ç—Ä–æ–±–µ –º–∞—Ç–µ—Ä–∏
üéØ –ê–º–±–∏—Ü–∏–∏ ‚Äî —á–∞–¥–∏–ª–∏ –∫–∞–∫ –ø–æ–∫—Ä—ã—à–∫–∞ –Ω–∞ —Å–≤–∞–ª–∫–µ, –¥—ã–º —á—ë—Ä–Ω—ã–π –∫–∞–∫ –±—É–¥—É—â–µ–µ
üé≠ –•–∞—Ä–∏–∑–º–∞ ‚Äî –ø—à–∏–∫–Ω—É–ª–∞ –∫–∞–∫ –ø–µ—Ç–∞—Ä–¥–∞ –∏–∑ –§–∏–∫—Å –ü—Ä–∞–π—Å–∞, —Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω–∏–µ
üß† –¢–∞–ª–∞–Ω—Ç ‚Äî –æ—Ç—Å—ã—Ä–µ–ª –æ—Ç —Å–ª—ë–∑, –Ω–µ –∑–∞–≥–æ—Ä–µ–ª—Å—è –Ω–∏—Ö—É—è
</examples>

<about_person>
–ò–º—è: {name}
Username: {username}
–°–æ–æ–±—â–µ–Ω–∏—è (–¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —á—Ç–æ –∏ –∫–∞–∫ –≥–æ—Ä–∏—Ç):
{context}
</about_person>"""


class handler(BaseHTTPRequestHandler):
    
    def do_POST(self):
        """–°–∂–µ—á—å —á–µ–ª–æ–≤–µ–∫–∞"""
        try:
            content_length = int(self.headers.get('Content-Length', 0))
            body = self.rfile.read(content_length).decode('utf-8')
            data = json.loads(body) if body else {}
            
            name = data.get("name", "–•—É–π —Å –≥–æ—Ä—ã")
            username = data.get("username", "")
            context = data.get("context", "–°–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç ‚Äî –≥–æ—Ä–µ–ª –º–æ–ª—á–∞, –∫–∞–∫ –∏ –∂–∏–ª")
            
            prompt = SYSTEM_PROMPT.format(
                name=f"{name} (@{username})" if username else name,
                username=username or "–Ω–µ—Ç",
                context=context
            )
            
            api_key = os.environ.get("VERCEL_AI_GATEWAY_KEY", "").strip()
            if not api_key:
                self._send_error(500, "API key not configured")
                return
            
            request_body = json.dumps({
                "model": "anthropic/claude-sonnet-4",
                "max_tokens": 800,
                "temperature": 0.95,
                "system": prompt,
                "messages": [
                    {
                        "role": "user",
                        "content": f"–°–æ–∂–≥–∏ {name} –Ω–∞ –∫–æ—Å—Ç—Ä–µ. –ò—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å —á—Ç–æ –∏ –∫–∞–∫ –≥–æ—Ä–∏—Ç. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∂—ë—Å—Ç–∫–æ, —Å –º–∞—Ç–æ–º, –ø–æ-–±—ã–¥–ª—è–Ω—Å–∫–∏!"
                    }
                ]
            }).encode('utf-8')
            
            req = urllib.request.Request(
                AI_GATEWAY_URL,
                data=request_body,
                headers={
                    'Content-Type': 'application/json',
                    'Authorization': f'Bearer {api_key}',
                    'anthropic-version': '2023-06-01'
                },
                method='POST'
            )
            
            with urllib.request.urlopen(req, timeout=60) as response:
                result = json.loads(response.read().decode('utf-8'))
            
            burn_result = result.get("content", [{}])[0].get("text", "–ù–µ –∑–∞–≥–æ—Ä–µ–ª—Å—è ‚Äî —Å–ª–∏—à–∫–æ–º —Å—ã—Ä–æ–π –æ—Ç —Å–ª—ë–∑")
            
            self._send_json(200, {"result": burn_result})
            
        except urllib.error.HTTPError as e:
            error_body = e.read().decode('utf-8') if e.fp else str(e)
            self._send_error(500, f"AI error: {e.code} - {error_body}")
            
        except Exception as e:
            self._send_error(500, str(e))
    
    def do_GET(self):
        self._send_json(200, {"status": "ok", "service": "teta-roza-burn"})
    
    def do_OPTIONS(self):
        self.send_response(200)
        self.send_header('Access-Control-Allow-Origin', '*')
        self.send_header('Access-Control-Allow-Methods', 'GET, POST, OPTIONS')
        self.send_header('Access-Control-Allow-Headers', 'Content-Type')
        self.end_headers()
    
    def _send_json(self, status: int, data: dict):
        self.send_response(status)
        self.send_header('Content-Type', 'application/json')
        self.send_header('Access-Control-Allow-Origin', '*')
        self.end_headers()
        self.wfile.write(json.dumps(data, ensure_ascii=False).encode('utf-8'))
    
    def _send_error(self, status: int, message: str):
        self._send_json(status, {"error": message})
