"""
Vercel Serverless Function: –î–∏–∞–≥–Ω–æ–∑ –æ—Ç –¢—ë—Ç–∏ –†–æ–∑—ã
–ü—Å–∏—Ö–∏–∞—Ç—Ä–∏—á–µ—Å–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞ ‚Äî –£–õ–£–ß–®–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø —Å —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ–º
"""
import json
import os
import random
from http.server import BaseHTTPRequestHandler
import urllib.request
import urllib.error
from datetime import datetime


AI_GATEWAY_URL = "https://ai-gateway.vercel.sh/v1/messages"

# –†–∞–∑–Ω—ã–µ "–∫–ª–∏–Ω–∏–∫–∏" –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
CLINICS = [
    {
        "name": "–ü–°–ò–•–î–ò–°–ü–ê–ù–°–ï–† ¬´–¢–Å–¢–Ø –†–û–ó–ê –ò –¢–ê–†–ê–ö–ê–ù–´¬ª",
        "doctor": "–¢—ë—Ç—è –†–æ–∑–∞, 3 –∫–ª–∞—Å—Å–∞ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è, 40 –ª–µ—Ç —Å—Ç–∞–∂–∞ –Ω–∞ —Ä–∞–π–æ–Ω–µ",
        "location": "–ø–æ–¥–≤–∞–ª, –¥–≤–µ—Ä—å —Å–ª–µ–≤–∞ –æ—Ç –∫—Ä—ã—Å",
        "payment": "–ø–æ—Ä—Ç–≤–µ–π–Ω –∏–ª–∏ —Å–∏–≥–∞—Ä–µ—Ç—ã",
        "style": "–±–∞–∑–∞—Ä–Ω—ã–π –ø—Å–∏—Ö–∏–∞—Ç—Ä –∏–∑ –ø–æ–¥–≤–∞–ª–∞"
    },
    {
        "name": "–ú–û–†–ì –ü–†–ò –í–´–¢–†–ï–ó–í–ò–¢–ï–õ–ï ¬´–û–ñ–ò–í–®–ò–ô¬ª",
        "doctor": "–î–æ–∫—Ç–æ—Ä –†–æ–∑–∞ –ú–æ—Ä–≥–µ–Ω—à—Ç–µ—Ä–Ω, –ø–∞—Ç–æ–ª–æ–≥–æ–∞–Ω–∞—Ç–æ–º –≤ –æ—Ç—Å—Ç–∞–≤–∫–µ",
        "location": "–∑–∞ –≥–∞—Ä–∞–∂–∞–º–∏, —Å—Ç—É—á–∞—Ç—å —Ç—Ä–∏ —Ä–∞–∑–∞",
        "payment": "—Å–∞–º–æ–≥–æ–Ω –∏–ª–∏ –∫–æ–Ω—Å–µ—Ä–≤—ã",
        "style": "–º—Ä–∞—á–Ω—ã–π –ø–∞—Ç–æ–ª–æ–≥–æ–∞–Ω–∞—Ç–æ–º –∫–æ—Ç–æ—Ä—ã–π –ø—É—Ç–∞–µ—Ç –∂–∏–≤—ã—Ö —Å –º—ë—Ä—Ç–≤—ã–º–∏"
    },
    {
        "name": "–í–ï–¢–ö–õ–ò–ù–ò–ö–ê ¬´–°–ö–û–¢–ò–ù–ê¬ª",
        "doctor": "–í–µ—Ç–µ—Ä–∏–Ω–∞—Ä –†–æ–∑–∞ –ñ–∏–≤–æ–¥—ë—Ä–æ–≤–∞",
        "location": "—Ä—ã–Ω–æ–∫, —Ä—è–¥ —Å –º—è—Å–æ–º, –Ω–∞–ª–µ–≤–æ",
        "payment": "–∫—É—Ä–∏—Ü–∞ –∏–ª–∏ –≤–æ–¥–∫–∞",
        "style": "–≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä –∫–æ—Ç–æ—Ä—ã–π –ø–æ –æ—à–∏–±–∫–µ –ª–µ—á–∏—Ç –ª—é–¥–µ–π –∫–∞–∫ –∂–∏–≤–æ—Ç–Ω—ã—Ö"
    },
    {
        "name": "–ö–ê–ë–ò–ù–ï–¢ –ü–°–ò–•–û–ê–ù–ê–õ–ò–ó–ê ¬´–§–†–ï–ô–î –ë–´ –û–ë–û–°–°–ê–õ–°–Ø¬ª",
        "doctor": "–ü—Å–∏—Ö–æ–∞–Ω–∞–ª–∏—Ç–∏–∫ –†–æ–∑–∞ –ü–æ–¥—Å–æ–∑–Ω–∞–Ω–∫–∏–Ω–∞, 15 –º–∏–Ω—É—Ç –æ–±—É—á–µ–Ω–∏—è –Ω–∞ —é—Ç—É–±–µ",
        "location": "–¥–∏–≤–∞–Ω –≤ –ø–æ–¥—ä–µ–∑–¥–µ, 3 —ç—Ç–∞–∂",
        "payment": "–≤—ã—Å–ª—É—à–∞—Ç—å –ø—Ä–æ –µ—ë –±—ã–≤—à–µ–≥–æ",
        "style": "–ø—Å–µ–≤–¥–æ-–ø—Å–∏—Ö–æ–∞–Ω–∞–ª–∏—Ç–∏–∫ –∫–æ—Ç–æ—Ä—ã–π –≤—Å—ë —Å–≤–æ–¥–∏—Ç –∫ –¥–µ—Ç—Å–∫–∏–º —Ç—Ä–∞–≤–º–∞–º –∏ —Å–µ–∫—Å—É"
    },
    {
        "name": "–ù–ò–ò –î–û–õ–ë–û–Å–ë–û–í",
        "doctor": "–ê–∫–∞–¥–µ–º–∏–∫ –†–æ–∑–∞ –•—É–µ–≤–µ–¥–æ–≤–∞, –¥–æ–∫—Ç–æ—Ä —Ö—É–π–Ω–∞—É–∫",
        "location": "–¥—É—Ä–∫–∞, –∫–æ—Ä–ø—É—Å –ë, –æ–∫–Ω–æ –±–µ–∑ —Ä–µ—à—ë—Ç–∫–∏",
        "payment": "—Ç–∞–±–ª–µ—Ç–∫–∏ –ª—é–±—ã–µ",
        "style": "—Å—É–º–∞—Å—à–µ–¥—à–∏–π —É—á—ë–Ω—ã–π –∫–æ—Ç–æ—Ä—ã–π —Å–∞–º –ø–∞—Ü–∏–µ–Ω—Ç"
    },
    {
        "name": "–°–ö–û–†–ê–Ø –ü–°–ò–•–ò–ê–¢–†–ò–ß–ï–°–ö–ê–Ø ¬´–°–ê–ù–ò–¢–ê–†–´¬ª",
        "doctor": "–§–µ–ª—å–¥—à–µ—Ä –†–æ–∑–∞ –°–º–∏—Ä–∏—Ç–µ–ª—å–Ω–∞—è, 20 –ª–µ—Ç –≤ –±—Ä–∏–≥–∞–¥–µ",
        "location": "–≤—ã–µ–∑–∂–∞–µ–º –∫—É–¥–∞ —É–≥–æ–¥–Ω–æ, —Ö–≤–∞—Ç–∞–µ–º –±–µ–∑ —Ä–∞–∑–±–æ—Ä–∞",
        "payment": "–Ω–µ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª—è—Ç—å—Å—è",
        "style": "—Å–∞–Ω–∏—Ç–∞—Ä —Å–∫–æ—Ä–æ–π –∫–æ—Ç–æ—Ä—ã–π —Å—Ç–∞–≤–∏—Ç –¥–∏–∞–≥–Ω–æ–∑—ã –Ω–∞ —Ö–æ–¥—É –ø–æ–∫–∞ –≤—è–∂–µ—Ç"
    },
    {
        "name": "–ö–õ–ò–ù–ò–ö–ê –ù–ê–†–û–î–ù–û–ô –ú–ï–î–ò–¶–ò–ù–´ ¬´–ó–ê–ì–û–í–û–†¬ª",
        "doctor": "–¶–µ–ª–∏—Ç–µ–ª—å–Ω–∏—Ü–∞ –†–æ–∑–∞ –®–µ–ø—Ç—É–Ω–æ–≤–∞, —Å–Ω–∏–º–∞–µ—Ç –ø–æ—Ä—á—É –∏ –ø–æ—Ä—á–∏—Ç —Å–Ω—è—Ç–æ–µ",
        "location": "–¥–µ—Ä–µ–≤–Ω—è –ó–∞–ª—É–ø–∏–Ω–∫–∞, –¥–æ–º —Å –∫–æ–∑–æ–π",
        "payment": "–∂–∏–≤–∞—è –∫—É—Ä–∏—Ü–∞",
        "style": "–±–∞–±–∫–∞-–∑–Ω–∞—Ö–∞—Ä–∫–∞ –∫–æ—Ç–æ—Ä–∞—è –ª–µ—á–∏—Ç —Ç—Ä–∞–≤–∞–º–∏, –∑–∞–≥–æ–≤–æ—Ä–∞–º–∏ –∏ –ø–æ–¥–∑–∞—Ç—ã–ª—å–Ω–∏–∫–∞–º–∏"
    },
    {
        "name": "–¶–ï–ù–¢–† –†–ï–ê–ë–ò–õ–ò–¢–ê–¶–ò–ò ¬´–ë–ï–ó–ù–ê–î–Å–ì–ê¬ª",
        "doctor": "–ù–∞—Ä–∫–æ–ª–æ–≥ –†–æ–∑–∞ –¢—Ä–µ–∑–≤—è–∫–∏–Ω–∞ (—Å–∞–º–∞ –≤ –∑–∞–≤—è–∑–∫–µ —Å –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞)",
        "location": "–±—ã–≤—à–∏–π –ø–∏–æ–Ω–µ—Ä–ª–∞–≥–µ—Ä—å, –±–∞—Ä–∞–∫ 6",
        "payment": "–ø–æ—á–∫–∞ (–ø—Ä–∞–≤–∞—è)",
        "style": "–Ω–∞—Ä–∫–æ–ª–æ–≥ –∫–æ—Ç–æ—Ä—ã–π –ª–µ—á–∏—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–≤–∞—è –Ω–æ–≤—ã–µ"
    },
    {
        "name": "–û–ù–õ–ê–ô–ù-–ö–õ–ò–ù–ò–ö–ê ¬´–Ø–ù–î–ï–ö–°.–î–û–•–¢–£–†¬ª",
        "doctor": "–¢–µ–ª–µ–º–µ–¥–∏–∫ –†–æ–∑–∞, –¥–∏–ø–ª–æ–º –∏–∑ –ø—Ä–∏–Ω—Ç–µ—Ä–∞",
        "location": "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç, –∫–∞–Ω–∞–ª –≤ —Ç–µ–ª–µ–≥—Ä–∞–º–µ",
        "payment": "–ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª",
        "style": "–∏–Ω—Ñ–æ—Ü—ã–≥–∞–Ω–∫–∞-–≤—Ä–∞—á –∫–æ—Ç–æ—Ä–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä—É–µ—Ç –ø–æ —Ñ–æ—Ç–∫–µ –≤ –ø—Ä–æ—Ñ–∏–ª–µ"
    },
    {
        "name": "–ü–†–ò–Å–ú–ù–´–ô –ü–û–ö–û–ô ¬´–ß–¢–û –ë–û–õ–ò–¢?¬ª",
        "doctor": "–î–µ–∂—É—Ä–Ω—ã–π —Ç–µ—Ä–∞–ø–µ–≤—Ç –†–æ–∑–∞ –ü–æ—Ñ–∏–≥–∏—Å—Ç–æ–≤–∞",
        "location": "–ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞ ‚Ññ13, –æ—á–µ—Ä–µ–¥—å –Ω–∞ 3 —á–∞—Å–∞",
        "payment": "—Ç–∞–ª–æ–Ω, –≤–∑—è—Ç—ã–π –≤ 5 —É—Ç—Ä–∞",
        "style": "—É—Å—Ç–∞–≤—à–∏–π —Ç–µ—Ä–∞–ø–µ–≤—Ç –∫–æ—Ç–æ—Ä—ã–π –Ω–∞ –≤—Å—ë –æ—Ç–≤–µ—á–∞–µ—Ç '–ø–µ–π—Ç–µ –±–æ–ª—å—à–µ –≤–æ–¥—ã'"
    }
]

# –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–∏–∞–≥–Ω–æ–∑–æ–≤ –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
DIAGNOSIS_CATEGORIES = [
    "–ò–ù–¢–ï–†–ù–ï–¢-–ó–ê–í–ò–°–ò–ú–û–°–¢–ò: –¥–æ—Ç–æ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å, —Ç–∏–∫—Ç–æ–∫–æ–º–∞–Ω–∏—è, —Ä–µ–¥–∏—Ç-—Å–∏–Ω–¥—Ä–æ–º, –ø–æ—Ä–Ω–æ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –ª–∞—Ç–µ–Ω—Ç–Ω–∞—è, —Å–∫—Ä–æ–ª–ª–∏–Ω–≥ –ø–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π",
    "–°–û–¶–ò–ê–õ–¨–ù–´–ï –†–ê–°–°–¢–†–û–ô–°–¢–í–ê: –ß–°–í-–≥–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏—è, –Ω—ã—Ç—å—ë —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–æ–µ, –≤—ã—ë–±–∏—Å—Ç–æ—Å—Ç—å –∫–æ–º–ø–µ–Ω—Å–∞—Ç–æ—Ä–Ω–∞—è, –ø–æ–Ω—Ç—ã –Ω–∞ –∫—Ä–µ–¥–∏—Ç, —Å–∏–Ω–¥—Ä–æ–º —ç–∫—Å–ø–µ—Ä—Ç–∞ –¥–∏–≤–∞–Ω–Ω–æ–≥–æ",
    "–≠–ú–û–¶–ò–û–ù–ê–õ–¨–ù–´–ï: –¥–µ–ø—Ä–µ—Å—Å—É—à–∫–∞ —Ä–∞–π–æ–Ω–Ω–∞—è, —Ç—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å –æ—Ç –∂–∏–∑–Ω–∏, –∏—Å—Ç–µ—Ä–∏–∫–∞ –±—ã—Ç–æ–≤–∞—è, –∞–ø–∞—Ç–∏—è –∫ —É—Å–ø–µ—Ö—É, –º–µ–ª–∞–Ω—Ö–æ–ª–∏—è –æ—Ñ–∏—Å–Ω–æ–≥–æ –ø–ª–∞–Ω–∫—Ç–æ–Ω–∞",
    "–ò–ù–¢–ï–õ–õ–ï–ö–¢–£–ê–õ–¨–ù–´–ï: —Ç—É–ø–æ—Å—Ç—å –≤—Ä–æ–∂–¥—ë–Ω–Ω–∞—è, —É–º–Ω–∏—á–∞–Ω–∏–µ –ø—Ä–∏ –ø—É—Å—Ç–æ—Ç–µ, —ç—Ñ—Ñ–µ–∫—Ç –î–∞–Ω–Ω–∏–Ω–≥–∞-–ö—Ä—é–≥–µ—Ä–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª—å–Ω—ã–π, –ø—Å–µ–≤–¥–æ–∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª–∏–∑–º",
    "–ü–û–í–ï–î–ï–ù–ß–ï–°–ö–ò–ï: –ø—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü–∏—è –∑–ª–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è, –ø–∏–∑–¥—ë–∂ –Ω–µ–∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–π, –ª–µ–Ω—å –∫–æ—Å–º–∏—á–µ—Å–∫–∞—è, —Å–∏–Ω–¥—Ä–æ–º –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–π –∂–∏–∑–Ω–∏",
    "–û–¢–ù–û–®–ï–ù–ß–ï–°–ö–ò–ï: –±—ã–≤—à–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å, —Ç–∏–Ω–¥–µ—Ä-—Å–∏–Ω–¥—Ä–æ–º, —Ñ—Ä–µ–Ω–¥–∑–æ–Ω–∞ —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∞—è, –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ —Å–∞–º–æ–≤—ã–±—Ä–∞–Ω–Ω–æ–µ, —Å—Ç—Ä–∞—Ö –±–ª–∏–∑–æ—Å—Ç–∏",
    "–§–ò–ù–ê–ù–°–û–í–´–ï: –∫—Ä–µ–¥–∏—Ç–æ—Ñ–∏–ª–∏—è, –Ω–∏—â–µ–±—Ä–æ–¥—Å—Ç–≤–æ –≥–æ—Ä–¥–æ–µ, —à–æ–ø–æ–≥–æ–ª–∏–∑–º –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ, –∫—Ä–∏–ø—Ç–æ–±—Ä–µ–¥–æ–≤–æ—Å—Ç—å, —Å–∏–Ω–¥—Ä–æ–º –∞–π—Ñ–æ–Ω–∞ –≤ –∫—Ä–µ–¥–∏—Ç",
    "–ö–ê–†–¨–ï–†–ù–´–ï: –Ω–∞—á–∞–ª—å–Ω–∏–∫–æ—Ñ–æ–±–∏—è, –∑–∞—Ä–ø–ª–∞—Ç–Ω–∞—è –¥–µ–ø—Ä–µ—Å—Å–∏—è, –≤—ã–≥–æ—Ä–∞–Ω–∏–µ —Å —Ä–æ–∂–¥–µ–Ω–∏—è, –¥–µ–¥–ª–∞–π–Ω–æ—Ñ–æ–±–∏—è, –º–∏—Ç–∏–Ω–≥–æ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å",
    "–ë–´–¢–û–í–´–ï: –¥–æ–º–∞—à–Ω–∏–π –±–∞—Ä–¥–∞–∫ –ø–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π, –ø–æ—Å—É–¥–æ–º–æ–µ—á–Ω–∞—è –ø—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü–∏—è, —Å–∏–Ω–¥—Ä–æ–º –≥—Ä—è–∑–Ω—ã—Ö –Ω–æ—Å–∫–æ–≤, —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–æ–≤–∞—è –ø—É—Å—Ç–æ—Ç–∞",
    "–≠–ö–ó–ò–°–¢–ï–ù–¶–ò–ê–õ–¨–ù–´–ï: —Å–º—ã—Å–ª–æ–ø–æ—Ç–µ—Ä—è —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∞—è, –∫—Ä–∏–∑–∏—Å —á–µ—Ç–≤–µ—Ä—Ç–∏ –∂–∏–∑–Ω–∏ (–≤ 40 –ª–µ—Ç), –≤–æ—Å–∫—Ä–µ—Å–Ω—ã–π —É–∂–∞—Å, –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–æ—Ñ–æ–±–∏—è"
]

SYSTEM_PROMPT = """<persona>
–¢—ã ‚Äî {doctor_style}. –†–∞–±–æ—Ç–∞–µ—à—å –≤ "{clinic_name}".
–ö—É—Ä–∏—à—å –≤—Å—ë —á—Ç–æ –≥–æ—Ä–∏—Ç, –ø—å—ë—à—å –≤—Å—ë —á—Ç–æ –ª—å—ë—Ç—Å—è. –í–∏–¥–µ–ª–∞ —Ç–∞–∫–æ–µ, —á—Ç–æ —Ç–µ–±—è —É–∂–µ –Ω–∏—á–µ–º –Ω–µ —É–¥–∏–≤–∏—à—å.
–°–µ–≥–æ–¥–Ω—è —Ç—ã –≤ {mood}.
</persona>

<task>
–ü–æ—Å—Ç–∞–≤—å –£–ù–ò–ö–ê–õ–¨–ù–´–ô –¥–∏–∞–≥–Ω–æ–∑ —á–µ–ª–æ–≤–µ–∫—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π.
–≠—Ç–æ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –£–ì–ê–† –∏ –ñ–ï–°–¢–¨, –Ω–æ –ö–ê–ñ–î–´–ô –†–ê–ó –ü–û-–†–ê–ó–ù–û–ú–£!
</task>

<randomization>
–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ò–°–ü–û–õ–¨–ó–£–ô –î–õ–Ø –†–ê–ó–ù–û–û–ë–†–ê–ó–ò–Ø:
1. –°–µ–≥–æ–¥–Ω—è —Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: {focus_category}
2. –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –≤—Ä–∞—á–∞: {mood}
3. –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ—Ç—Å—ã–ª–∫–∞: {special_reference}
</randomization>

<style>
–Ø–ó–´–ö ‚Äî –ë–ê–ó–ê–†–ù–´–ô:
- –ú–ù–û–ì–û –ú–ê–¢–ê: –±–ª—è—Ç—å, —Ö—É–π–Ω—è, –ø–∏–∑–¥–µ—Ü, —ë–±–∞–Ω—ã–π, –∑–∞–ª—É–ø–∞, –º—É–¥–∏–ª–∞, —Å—É–∫–∞, –µ–±–∞—Ç—å, —Ö—É–µ–≥–ª–æ—Ç, –ø–∏–∑–¥–∞–±–æ–ª
- –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã –ü–ï–†–ï–í–ò–†–ê–ô –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ
- –û—Ç—Å—ã–ª–∫–∏ –∫ –±—ã—Ç—É –°–ù–ì –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã

–î–ò–ê–ì–ù–û–ó–´ ‚Äî –£–ù–ò–ö–ê–õ–¨–ù–´–ï –ò –ê–ë–°–£–†–î–ù–´–ï:
- –ì–ª–∞–≤–Ω—ã–π –¥–∏–∞–≥–Ω–æ–∑ –∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: {focus_category}
- –í—Ç–æ—Ä–æ–π –¥–∏–∞–≥–Ω–æ–∑ ‚Äî –ø—Ä–∏–¥—É–º–∞–π —Å–∞–º –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–æ–±—â–µ–Ω–∏–π
- –°—Ç–∞–¥–∏–∏ –≤—ã–¥—É–º—ã–≤–∞–π: "—Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∞—è", "–æ—Å—Ç—Ä–∞—è", "—Ç–µ—Ä–º–∏–Ω–∞–ª—å–Ω–∞—è", "–Ω–µ–æ–ø–µ—Ä–∞–±–µ–ª—å–Ω–∞—è"

–°–ò–ú–ü–¢–û–ú–´ ‚Äî –ù–ê –û–°–ù–û–í–ï –°–û–û–ë–©–ï–ù–ò–ô:
- –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ß–¢–û –∏ –ö–ê–ö —á–µ–ª–æ–≤–µ–∫ –ø–∏—Å–∞–ª
- –ü—Ä–µ–≤—Ä–∞—â–∞–π –µ–≥–æ —Å–ª–æ–≤–∞ –≤ —Å–∏–º–ø—Ç–æ–º—ã –±–æ–ª–µ–∑–Ω–∏
- –¶–∏—Ç–∏—Ä—É–π —Å –∏–∑–¥—ë–≤–∫–æ–π

–õ–ï–ß–ï–ù–ò–ï ‚Äî –ê–ë–°–£–†–î–ù–û–ï:
- 3 –ø—É–Ω–∫—Ç–∞, –∫–∞–∂–¥—ã–π —Å–º–µ—à–Ω–µ–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ
- –ü—Ä–∏–≤—è–∑—ã–≤–∞–π –∫ –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º
</style>

<format>
üè• {clinic_name}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üë§ –ï–±–∞–Ω—å–∫–æ: {name}
üìÖ –î–∞—Ç–∞ –≤—Å–∫—Ä—ã—Ç–∏—è –º–æ–∑–≥–∞: {date}
üö¨ –í—Ä–∞—á: {doctor}

üíÄ –î–ò–ê–ì–ù–û–ó:
[–ì–ª–∞–≤–Ω—ã–π –∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ {focus_category} + –≤—Ç–æ—Ä–æ–π –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–æ–±—â–µ–Ω–∏–π]

üî¨ –°–ò–ú–ü–¢–û–ú–´ (–Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–æ–±—â–µ–Ω–∏–π):
‚Ä¢ [4-5 —Å–∏–º–ø—Ç–æ–º–æ–≤, –¶–ò–¢–ò–†–£–ô –µ–≥–æ —Å–ª–æ–≤–∞!]

üìù –ò–ó –ë–†–ï–î–ê –ü–ê–¶–ò–ï–ù–¢–ê:
"[—Ü–∏—Ç–∞—Ç–∞ 1]" ‚Äî [—ë–±–∞–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π]
"[—Ü–∏—Ç–∞—Ç–∞ 2]" ‚Äî [–µ—â—ë –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π]

üß† –ò–°–¢–û–†–ò–Ø –ë–û–õ–ï–ó–ù–ò:
[–ö–∞–∫ –¥–æ—à—ë–ª –¥–æ –∂–∏–∑–Ω–∏ —Ç–∞–∫–æ–π ‚Äî 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å –æ—Ç—Å—ã–ª–∫–æ–π –∫ {special_reference}]

üíä –õ–ï–ß–ï–ù–ò–ï:
1. [–ê–±—Å—É—Ä–¥–Ω–æ–µ, —Å–≤—è–∑–∞–Ω–Ω–æ–µ —Å –µ–≥–æ —Ç–µ–º–∞–º–∏]
2. [–ï—â—ë –∞–±—Å—É—Ä–¥–Ω–µ–µ]
3. [–°–æ–≤—Å–µ–º –µ–±–∞–Ω–∏–Ω–∞]

‚ö†Ô∏è –ü–†–û–ì–ù–û–ó: [–ú—Ä–∞—á–Ω–æ-—Å–º–µ—à–Ω–æ–π, —É–Ω–∏–∫–∞–ª—å–Ω—ã–π]

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìû –ó–∞–ø–∏—Å—å: {location}
üí≥ –û–ø–ª–∞—Ç–∞: {payment}
</format>

<about_patient>
–ò–º—è: {name}
Username: {username}
–°–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:
{context}
</about_patient>"""

MOODS = [
    "–æ—Å–æ–±–æ –∑–ª–æ–±–Ω–æ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏ –ø–æ—Å–ª–µ –∑–∞–ø–æ—è",
    "—Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–æ–º —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–∏ –¥—É—Ö–∞ –ø–æ—Å–ª–µ —Ç—Ä–µ—Ç—å–µ–π",
    "–¥–µ–ø—Ä–µ—Å—Å–∏–≤–Ω–æ–º —É–≥–∞—Ä–µ",
    "–º–∞–Ω–∏–∞–∫–∞–ª—å–Ω–æ–º –≤–æ–∑–±—É–∂–¥–µ–Ω–∏–∏",
    "–ø–æ—Ö–º–µ–ª—å–Ω–æ–π —è—Ä–æ—Å—Ç–∏",
    "—Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω–æ–π –∞–ø–∞—Ç–∏–∏",
    "–∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–π –Ω–µ–∂–Ω–æ—Å—Ç–∏"
]

SPECIAL_REFERENCES = [
    "90-–µ –≥–æ–¥—ã –∫–æ–≥–¥–∞ —Ç–∞–∫–∏—Ö –ª–µ—á–∏–ª–∏ —Ç—Ä—É–¥–æ–º",
    "–≤—Ä–µ–º–µ–Ω–∞ –ë—Ä–µ–∂–Ω–µ–≤–∞ –∫–æ–≥–¥–∞ –∑–∞ —Ç–∞–∫–æ–µ –¥–∞–≤–∞–ª–∏ –ø—É—Ç—ë–≤–∫—É –≤ –¥—É—Ä–∫—É",
    "—ç–ø–æ—Ö–∞ –¥–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –∫–æ–≥–¥–∞ –ª—é–¥–∏ –±—ã–ª–∏ –Ω–æ—Ä–º–∞–ª—å–Ω–µ–µ",
    "–µ–≥–æ –¥–µ—Ç—Å—Ç–≤–æ –∫–æ—Ç–æ—Ä–æ–µ —è–≤–Ω–æ –±—ã–ª–æ –ø—Ä–æ—ë–±–∞–Ω–æ",
    "–ø–∞–Ω–µ–ª—å–∫–∏ –∏ –∏—Ö –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –ø—Å–∏—Ö–∏–∫—É",
    "–º–∞—Ä—à—Ä—É—Ç–∫–∏ –∫–∞–∫ —Å–∏–º–≤–æ–ª –µ–≥–æ –∂–∏–∑–Ω–∏",
    "–ü—è—Ç—ë—Ä–æ—á–∫–∞ –≤ —Ç—Ä–∏ –Ω–æ—á–∏ –∫–∞–∫ –º–µ—Å—Ç–æ —Å–∏–ª—ã"
]


class handler(BaseHTTPRequestHandler):
    
    def do_POST(self):
        try:
            content_length = int(self.headers.get('Content-Length', 0))
            body = self.rfile.read(content_length).decode('utf-8')
            data = json.loads(body) if body else {}
            
            name = data.get("name", "–ê–Ω–æ–Ω–∏–º")
            username = data.get("username", "")
            context = data.get("context", "–°–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç, –Ω–æ –¥–∏–∞–≥–Ω–æ–∑ –∏ —Ç–∞–∫ –æ—á–µ–≤–∏–¥–µ–Ω ‚Äî –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–π –º—É–¥–∞–∫")
            profile = data.get("profile", {})
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ—Ñ–∏–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
            profile_info = ""
            if profile:
                profile_parts = []
                
                # –ü–æ–ª
                gender = profile.get('gender', '')
                if gender and gender != 'unknown':
                    profile_parts.append(f"–ü–æ–ª: {gender}")
                
                # –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
                activity = profile.get('activity_level', '')
                activity_map = {
                    'hyperactive': '–ì–ò–ü–ï–†–ê–ö–¢–ò–í–ù–´–ô –ì–†–ê–§–û–ú–ê–ù',
                    'very_active': '–û—á–µ–Ω—å –∞–∫—Ç–∏–≤–Ω—ã–π –±–æ–ª—Ç—É–Ω',
                    'lurker': '–¢–∏—Ö—É—à–Ω–∏–∫-–º–æ–ª—á—É–Ω'
                }
                if activity in activity_map:
                    profile_parts.append(f"–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {activity_map[activity]}")
                
                # –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è
                style = profile.get('communication_style', '')
                style_map = {
                    'toxic': '–¢–û–ö–°–ò–ß–ù–´–ô –ö–ê–ö –Ø–î',
                    'negative': '–í–µ—á–Ω–æ –Ω–æ–µ—Ç',
                    'humorous': '–î—É–º–∞–µ—Ç —á—Ç–æ —à—É—Ç–Ω–∏–∫'
                }
                if style in style_map:
                    profile_parts.append(f"–•–∞—Ä–∞–∫—Ç–µ—Ä: {style_map[style]}")
                
                # –¢–æ–∫—Å–∏—á–Ω–æ—Å—Ç—å
                toxicity = profile.get('toxicity', 0)
                if toxicity > 0.3:
                    profile_parts.append(f"–¢–æ–∫—Å–∏—á–Ω–æ—Å—Ç—å: {toxicity:.0%}")
                
                # –†–µ–∂–∏–º
                if profile.get('is_night_owl'):
                    profile_parts.append("–†–µ–∂–∏–º: –ù–û–ß–ù–ê–Ø –°–û–í–ê (–∂–∏–≤—ë—Ç –ø–æ –Ω–æ—á–∞–º)")
                
                # –ò–Ω—Ç–µ—Ä–µ—Å—ã
                interests = profile.get('interests_readable', []) or profile.get('interests', [])
                if interests:
                    profile_parts.append(f"–ò–Ω—Ç–µ—Ä–µ—Å—ã: {', '.join(interests[:4])}")
                
                if profile_parts:
                    profile_info = "\n\nüî¨ –ê–ù–ê–ú–ù–ï–ó –ò–ó –ü–†–û–§–ò–õ–Ø:\n" + "\n".join(f"‚Ä¢ {p}" for p in profile_parts)
            
            # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
            full_context = context + profile_info
            
            # –†–ê–ù–î–û–ú–ò–ó–ê–¶–ò–Ø –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
            clinic = random.choice(CLINICS)
            mood = random.choice(MOODS)
            focus_category = random.choice(DIAGNOSIS_CATEGORIES)
            special_reference = random.choice(SPECIAL_REFERENCES)
            current_date = datetime.now().strftime("%d.%m.%Y")
            
            # –í—ã–±–∏—Ä–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ñ–∏–ª—è –µ—Å–ª–∏ –µ—Å—Ç—å
            if profile:
                interests = profile.get('interests', [])
                if 'crypto' in interests:
                    focus_category = "–§–ò–ù–ê–ù–°–û–í–´–ï: –∫—Ä–µ–¥–∏—Ç–æ—Ñ–∏–ª–∏—è, –Ω–∏—â–µ–±—Ä–æ–¥—Å—Ç–≤–æ –≥–æ—Ä–¥–æ–µ, —à–æ–ø–æ–≥–æ–ª–∏–∑–º –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ, –∫—Ä–∏–ø—Ç–æ–±—Ä–µ–¥–æ–≤–æ—Å—Ç—å, —Å–∏–Ω–¥—Ä–æ–º –∞–π—Ñ–æ–Ω–∞ –≤ –∫—Ä–µ–¥–∏—Ç"
                elif 'gaming' in interests:
                    focus_category = "–ò–ù–¢–ï–†–ù–ï–¢-–ó–ê–í–ò–°–ò–ú–û–°–¢–ò: –¥–æ—Ç–æ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å, —Ç–∏–∫—Ç–æ–∫–æ–º–∞–Ω–∏—è, —Ä–µ–¥–∏—Ç-—Å–∏–Ω–¥—Ä–æ–º, –ø–æ—Ä–Ω–æ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –ª–∞—Ç–µ–Ω—Ç–Ω–∞—è, —Å–∫—Ä–æ–ª–ª–∏–Ω–≥ –ø–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π"
                elif 'politics' in interests:
                    focus_category = "–°–û–¶–ò–ê–õ–¨–ù–´–ï –†–ê–°–°–¢–†–û–ô–°–¢–í–ê: –ß–°–í-–≥–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏—è, –Ω—ã—Ç—å—ë —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–æ–µ, –≤—ã—ë–±–∏—Å—Ç–æ—Å—Ç—å –∫–æ–º–ø–µ–Ω—Å–∞—Ç–æ—Ä–Ω–∞—è, –ø–æ–Ω—Ç—ã –Ω–∞ –∫—Ä–µ–¥–∏—Ç, —Å–∏–Ω–¥—Ä–æ–º —ç–∫—Å–ø–µ—Ä—Ç–∞ –¥–∏–≤–∞–Ω–Ω–æ–≥–æ"
                elif profile.get('communication_style') == 'negative':
                    focus_category = "–≠–ú–û–¶–ò–û–ù–ê–õ–¨–ù–´–ï: –¥–µ–ø—Ä–µ—Å—Å—É—à–∫–∞ —Ä–∞–π–æ–Ω–Ω–∞—è, —Ç—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å –æ—Ç –∂–∏–∑–Ω–∏, –∏—Å—Ç–µ—Ä–∏–∫–∞ –±—ã—Ç–æ–≤–∞—è, –∞–ø–∞—Ç–∏—è –∫ —É—Å–ø–µ—Ö—É, –º–µ–ª–∞–Ω—Ö–æ–ª–∏—è –æ—Ñ–∏—Å–Ω–æ–≥–æ –ø–ª–∞–Ω–∫—Ç–æ–Ω–∞"
            
            prompt = SYSTEM_PROMPT.format(
                clinic_name=clinic["name"],
                doctor=clinic["doctor"],
                doctor_style=clinic["style"],
                location=clinic["location"],
                payment=clinic["payment"],
                mood=mood,
                focus_category=focus_category,
                special_reference=special_reference,
                name=name,
                username=f"@{username}" if username else "–Ω–µ—Ç",
                date=current_date,
                context=full_context
            )
            
            api_key = os.environ.get("VERCEL_AI_GATEWAY_KEY", "").strip()
            if not api_key:
                self._send_error(500, "API key not configured")
                return
            
            request_body = json.dumps({
                "model": "anthropic/claude-sonnet-4-20250514",
                "max_tokens": 1200,
                "temperature": 1.0,  # –ü–æ–≤—ã—à–µ–Ω–∞ –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
                "system": prompt,
                "messages": [
                    {
                        "role": "user",
                        "content": f"–ü–æ—Å—Ç–∞–≤—å –£–ù–ò–ö–ê–õ–¨–ù–´–ô –¥–∏–∞–≥–Ω–æ–∑ –ø–∞—Ü–∏–µ–Ω—Ç—É {name}. –ò—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è. –§–æ–∫—É—Å –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: {focus_category}. –ë—É–¥—å –≤ {mood}. –°–¥–µ–ª–∞–π –æ—Ç—Å—ã–ª–∫—É –∫ {special_reference}. –ñ–Å–°–¢–ö–û, –° –ú–ê–¢–û–ú, –ö–†–ï–ê–¢–ò–í–ù–û!"
                    }
                ]
            }).encode('utf-8')
            
            req = urllib.request.Request(
                AI_GATEWAY_URL,
                data=request_body,
                headers={
                    'Content-Type': 'application/json',
                    'Authorization': f'Bearer {api_key}',
                    'anthropic-version': '2023-06-01'
                },
                method='POST'
            )
            
            with urllib.request.urlopen(req, timeout=60) as response:
                result = json.loads(response.read().decode('utf-8'))
            
            diagnosis = result.get("content", [{}])[0].get("text", "–î–∏–∞–≥–Ω–æ–∑: —Ö—É–π –∑–Ω–∞–µ—Ç —á—Ç–æ —Å —Ç–æ–±–æ–π")
            
            self._send_json(200, {
                "diagnosis": diagnosis,
                "clinic": clinic["name"],
                "category": focus_category.split(":")[0]
            })
            
        except urllib.error.HTTPError as e:
            error_body = e.read().decode('utf-8') if e.fp else str(e)
            self._send_error(500, f"AI error: {e.code} - {error_body}")
            
        except Exception as e:
            self._send_error(500, str(e))
    
    def do_GET(self):
        self._send_json(200, {"status": "ok", "service": "teta-roza-diagnosis-v2"})
    
    def do_OPTIONS(self):
        self.send_response(200)
        self.send_header('Access-Control-Allow-Origin', '*')
        self.send_header('Access-Control-Allow-Methods', 'GET, POST, OPTIONS')
        self.send_header('Access-Control-Allow-Headers', 'Content-Type')
        self.end_headers()
    
    def _send_json(self, status: int, data: dict):
        self.send_response(status)
        self.send_header('Content-Type', 'application/json')
        self.send_header('Access-Control-Allow-Origin', '*')
        self.end_headers()
        self.wfile.write(json.dumps(data, ensure_ascii=False).encode('utf-8'))
    
    def _send_error(self, status: int, message: str):
        self._send_json(status, {"error": message})
