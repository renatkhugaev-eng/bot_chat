"""
Vercel Serverless Function: –ü—Ä–æ–≤–µ—Ç—Ä–∏—Ç—å —á–∞—Ç
–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–±—Å—É—Ä–¥–Ω—ã—Ö –∫–æ—Ä–æ—Ç–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ñ–æ—Ä—Ç–æ—á–∫–∏
–° –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –Ω–æ–≤–æ—Å—Ç—è–º–∏, —á—ë—Ä–Ω—ã–º —é–º–æ—Ä–æ–º –∏ —Å–∞—Ç–∏—Ä–æ–π
"""
import json
import os
import random
from http.server import BaseHTTPRequestHandler
import urllib.request
import urllib.error
from datetime import datetime


AI_GATEWAY_URL = "https://ai-gateway.vercel.sh/v1/messages"

# –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è ‚Äî –†–ê–°–®–ò–†–ï–ù–ù–´–ï
EVENT_CATEGORIES = [
    "–ñ–ò–í–û–¢–ù–´–ï: –≥–æ–ª—É–±—å-–∫–∞–º–∏–∫–∞–¥–∑–µ, –≤–æ—Ä–æ–Ω–∞ —Å –≥—Ä–∞–Ω–∞—Ç–æ–π, —á–∞–π–∫–∞ –∏–∑ –ü–∏—Ç–µ—Ä–∞ (–∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è), –ª–µ—Ç—É—á–∞—è –º—ã—à—å —Å –∫–æ–≤–∏–¥–æ–º, —Ä–æ–π –ø—á—ë–ª-—É–±–∏–π—Ü, –∫—Ä—ã—Å–∞-–º—É—Ç–∞–Ω—Ç –∏–∑ –º–µ—Ç—Ä–æ, –∫–æ—Ç –®—Ä—ë–¥–∏–Ω–≥–µ—Ä–∞, –º–µ–¥–≤–µ–¥—å –Ω–∞ —Å–∞–º–æ–∫–∞—Ç–µ, –ª–æ—Å—å –≤ –¥–µ–ø—Ä–µ—Å—Å–∏–∏",
    "–ü–û–ì–û–î–ê: —É—Ä–∞–≥–∞–Ω '–ü—É—Ç–∏–Ω', —Å–∫–≤–æ–∑–Ω—è–∫ –∏–∑ –∞–¥–∞, –º–æ—Ä–æ–∑ –∫–∞–∫ –≤ –¥—É—à–µ, –∂–∞—Ä–∞ –∫–∞–∫ –≤ –∞–¥—É, –∫–∏—Å–ª–æ—Ç–Ω—ã–π –¥–æ–∂–¥—å, —Ä–∞–¥–∏–æ–∞–∫—Ç–∏–≤–Ω—ã–π —Å–Ω–µ–≥, –≥—Ä–∞–¥ —Ä–∞–∑–º–µ—Ä–æ–º —Å —è–π—Ü–∞ –§–∞–±–µ—Ä–∂–µ, –ø–µ—Å—á–∞–Ω–∞—è –±—É—Ä—è –∏–∑ –°–∞—Ö–∞—Ä—ã, —Å–º–æ–≥ –∏–∑ –ß–µ–ª—è–±–∏–Ω—Å–∫–∞",
    "–ü–†–ï–î–ú–ï–¢–´ –ó–ê–õ–ï–¢–ï–õ–ò: –ø–∞–∫–µ—Ç –∏–∑ –ü—è—Ç—ë—Ä–æ—á–∫–∏ —Å –ø—Ä–æ—Å—Ä–æ—á–∫–æ–π, –≥–∞–∑–µ—Ç–∞ '–ü—Ä–∞–≤–¥–∞' 1937 –≥–æ–¥–∞, –ø–æ–≤–µ—Å—Ç–∫–∞ –∏–∑ –≤–æ–µ–Ω–∫–æ–º–∞—Ç–∞, –±–∏—Ç–∫–æ–∏–Ω (—É–ø–∞–ª), NFT –æ–±–µ–∑—å—è–Ω—ã, –ª–µ—Ç–∞—é—â–∏–π —É–Ω–∏—Ç–∞–∑, –¥—Ä–æ–Ω —Å –ê–ª–∏—ç–∫—Å–ø—Ä–µ—Å—Å–∞, —á–µ–π-—Ç–æ –¥–∏–ø–ª–æ–º (—Ñ–∞–ª—å—à–∏–≤—ã–π), —Ä–µ–∑—é–º–µ –Ω–∞ —Ä–∞–±–æ—Ç—É –º–µ—á—Ç—ã (–æ—Ç–∫–ª–æ–Ω–µ–Ω–æ)",
    "–ü–†–ï–î–ú–ï–¢–´ –£–õ–ï–¢–ï–õ–ò: –Ω–∞–¥–µ–∂–¥–∞ –Ω–∞ –ø–µ–Ω—Å–∏—é, –≤–µ—Ä–∞ –≤ —á–µ–ª–æ–≤–µ—á–µ—Å—Ç–≤–æ, –¥–µ–Ω—å–≥–∏ (–≤—Å–µ), –ø–æ—Å–ª–µ–¥–Ω–∏–µ –º–æ–∑–≥–∏, –æ—Å—Ç–∞—Ç–∫–∏ —Å–æ–≤–µ—Å—Ç–∏, –ø–ª–∞–Ω –Ω–∞ –∂–∏–∑–Ω—å, –º–æ—Ç–∏–≤–∞—Ü–∏—è, —Å–∏–ª–∞ –≤–æ–ª–∏, –ª–∏–±–∏–¥–æ",
    "–°–û–°–ï–î–ò: –±–∞–±–∫–∞-—Ç–µ–ª–µ–ø–∞—Ç —Å–Ω–∏–∑—É, —Å–æ—Å–µ–¥-–±–∞—Ä–∞–±–∞–Ω—â–∏–∫, –∞–ª–∫–∞—à –ü–µ—Ç—Ä–æ–≤–∏—á —Å –±–∞–ª–∞–ª–∞–π–∫–æ–π, —Å–µ–º—å—è —Å 12 –¥–µ—Ç—å–º–∏, –±—ã–≤—à–∞—è/–±—ã–≤—à–∏–π —Å –Ω–æ–≤–æ–π –ø–∞—Å—Å–∏–µ–π, –∫–æ–ª–ª–µ–∫—Ç–æ—Ä, —É—á–∞—Å—Ç–∫–æ–≤—ã–π",
    "–ú–ò–°–¢–ò–ö–ê: –ø—Ä–∏–∑—Ä–∞–∫ –°–°–°–†, –¥—É—Ö –∫–∞–ø–∏—Ç–∞–ª–∏–∑–º–∞, —Ç–µ–Ω—å —Å–∞–Ω–∫—Ü–∏–π, —Ö–æ–ª–æ–¥ –∏–∑ –º–æ—Ä–≥–∞, –∑–∞–ø–∞—Ö —Å–µ—Ä—ã –∏–∑ –æ—Ñ–∏—Å–∞, –≥–æ–ª–æ—Å HR —Å —Ç–æ–≥–æ —Å–≤–µ—Ç–∞, –∫–∞—Ä–º–∞ –∑–∞ –ø—Ä–æ—à–ª—É—é –∂–∏–∑–Ω—å, –¥–µ–º–æ–Ω –ø—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü–∏–∏",
    "–ó–ê–ü–ê–•–ò: —à–∞—É—Ä–º–∞ —Å —É—Ä–∞–Ω–æ–≤—ã–º —Å–æ—É—Å–æ–º, –≤—ã—Ö–ª–æ–ø –æ—Ç '–õ–∞–¥—ã', –ø–µ—Ä–µ–≥–∞—Ä –¥–µ–ø—É—Ç–∞—Ç–∞, –∑–∞–ø–∞—Ö –¥–µ–Ω–µ–≥ (—á—É–∂–∏—Ö), –∞—Ä–æ–º–∞—Ç —É—Å–ø–µ—Ö–∞ (–Ω–µ–¥–æ—Å—Ç–∏–∂–∏–º–æ–≥–æ), –≤–æ–Ω—å —Å—Ç–∞—Ä—Ç–∞–ø–∞, –¥—É—Ö –±—é—Ä–æ–∫—Ä–∞—Ç–∏–∏",
    "–ö–ê–¢–ê–°–¢–†–û–§–´: –æ–±–≤–∞–ª —Ä—É–±–ª—è, –∫—Ä–∞—Ö –∫—Ä–∏–ø—Ç—ã, –ø–æ—Ç–æ–ø –∏–∑ –æ—Ñ–∏—Å–∞ –≤—ã—à–µ, –ø–æ–∂–∞—Ä –≤ –¥–∞—Ç–∞—Ü–µ–Ω—Ç—Ä–µ, –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞, –∫–æ–Ω–µ—Ü —Å–≤–µ—Ç–∞ (–ª–æ–∫–∞–ª—å–Ω—ã–π), –∞–ø–æ–∫–∞–ª–∏–ø—Å–∏—Å –≤ –º–∏–Ω–∏–∞—Ç—é—Ä–µ",
    "–ü–û–õ–ò–¢–ò–ö–ê/–ê–ö–¢–£–ê–õ–ö–ê: —Å–∞–Ω–∫—Ü–∏–∏ –Ω–∞ –≤–µ—Ç–µ—Ä, –Ω–µ–π—Ä–æ—Å–µ—Ç—å-–º–∏–≥—Ä–∞–Ω—Ç, –∏–Ω—Ñ–ª—è—Ü–∏—è –≤ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–º –æ–±–ª–∏—á–∏–∏, –ø–µ–Ω—Å–∏–æ–Ω–Ω–∞—è —Ä–µ—Ñ–æ—Ä–º–∞ (–∫—É—Å–∞–µ—Ç—Å—è), –Ω–∞–ª–æ–≥–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–≤–Ω–µ–∑–∞–ø–Ω–∞—è), –∫—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞ (–∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π)",
    "–ò–ù–¢–ï–†–ù–ï–¢/–ú–ï–ú–´: –≤–∏—Ä—É—Å–Ω—ã–π —Ç–∏–∫—Ç–æ–∫, —Ç–æ–∫—Å–∏—á–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ç–æ—Ä, —Ö–µ–π—Ç–µ—Ä –∏–∑ —Ç–≤–∏—Ç—Ç–µ—Ä–∞, —Ç—Ä–æ–ª–ª—å –∏–∑ –æ–¥–Ω–æ–∫–ª–∞—Å—Å–Ω–∏–∫–æ–≤, –±–æ—Ç –∏–∑ —Ç–µ–ª–µ–≥—Ä–∞–º–∞, —Å–ø–∞–º–µ—Ä —Å –∫—Ä–∏–ø—Ç–æ–π, –∏–Ω—Ñ–æ—Ü—ã–≥–∞–Ω"
]

# –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ç–µ–º—ã –¥–ª—è —Å–∞—Ç–∏—Ä—ã (–æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è)
CURRENT_TOPICS = [
    "–Ω–µ–π—Ä–æ—Å–µ—Ç–∏ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—Ç –º–∏—Ä",
    "–±–∏—Ç–∫–æ–∏–Ω —Ç–æ –ø–∞–¥–∞–µ—Ç —Ç–æ —Ä–∞—Å—Ç—ë—Ç",
    "—Å–∞–Ω–∫—Ü–∏–∏ –∏ –∏–º–ø–æ—Ä—Ç–æ–∑–∞–º–µ—â–µ–Ω–∏–µ", 
    "—É–¥–∞–ª—ë–Ω–∫–∞ vs –æ—Ñ–∏—Å",
    "–º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—ã –∏ –ø—É–Ω–∫—Ç—ã –≤—ã–¥–∞—á–∏",
    "–ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –≤—Å—ë –ø–æ–¥—Ä—è–¥",
    "–±–ª–æ–≥–µ—Ä—ã –∏ –∏–Ω—Ñ–æ—Ü—ã–≥–∞–Ω–µ",
    "–¥–æ—Å—Ç–∞–≤–∫–∞ –µ–¥—ã –∏ –∫—É—Ä—å–µ—Ä—ã",
    "—ç–ª–µ–∫—Ç—Ä–æ—Å–∞–º–æ–∫–∞—Ç—ã –≤–µ–∑–¥–µ",
    "VPN –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏",
    "—É—Ç–µ—á–∫–∏ –¥–∞–Ω–Ω—ã—Ö",
    "–∫—Ä–µ–¥–∏—Ç—ã –∏ –∏–ø–æ—Ç–µ–∫–∞",
    "–∫–æ–º–º—É–Ω–∞–ª–∫–∞ —Ä–∞—Å—Ç—ë—Ç",
    "—Ü–µ–Ω—ã –Ω–∞ –≤—Å—ë —Ä–∞—Å—Ç—É—Ç",
    "–¥–µ—Ñ–∏—Ü–∏—Ç –∫–∞–¥—Ä–æ–≤",
    "–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏ –∏ –≤—ã–≥–æ—Ä–∞–Ω–∏–µ"
]

# –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å –∂–µ—Ä—Ç–≤–æ–π
VICTIM_ACTIONS = [
    "–Ω–∞—Å—Ä–∞–ª –Ω–∞", "—É–∫—É—Å–∏–ª", "–∫–ª—é–Ω—É–ª –≤ –≥–æ–ª–æ–≤—É", "–≤—Ä–µ–∑–∞–ª—Å—è –≤ –ª–∏—Ü–æ", 
    "—Å–µ–ª –Ω–∞ –≥–æ–ª–æ–≤—É", "–∑–∞–ª–µ—Ç–µ–ª –∑–∞ —à–∏–≤–æ—Ä–æ—Ç", "–ø—Ä–∏–∑–µ–º–ª–∏–ª—Å—è –Ω–∞",
    "—É–Ω–µ—Å–ª–æ —Å–∫–≤–æ–∑–Ω—è–∫–æ–º", "—Å–¥—É–ª–æ —Å–æ —Å—Ç—É–ª–∞", "–∑–∞–º–æ—Ä–æ–∑–∏–ª–æ", 
    "—É–¥–∞—Ä–∏–ª–æ –ø–æ –≥–æ–ª–æ–≤–µ", "–æ–±–ª–∏–ª–æ", "–æ–±—Å—ã–ø–∞–ª–æ", "–Ω–∞–∫—Ä—ã–ª–æ",
    "–∑–∞–ø—É—Ç–∞–ª–æ—Å—å –≤ –≤–æ–ª–æ—Å–∞—Ö —É", "—É–ø–∞–ª–æ –Ω–∞ –∫–æ–ª–µ–Ω–∏", "–≤–ª–µ—Ç–µ–ª–æ –≤ —Ä–æ—Ç"
]

# –ö–æ–Ω—Ü–æ–≤–∫–∏
ENDINGS = [
    "–ü—Ä–æ–≤–µ—Ç—Ä–µ–Ω–æ. –ù–µ –±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç–µ.",
    "–°–≤–µ–∂–æ. –ú–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å.",
    "–ó–∞–∫—Ä—ã–≤–∞—é –Ω–∞—Ö—É–π, –ø–æ–∫–∞ –µ—â—ë –∫–æ–≥–æ –Ω–µ —É–±–∏–ª–æ.",
    "–í–æ—Ç –∏ –ø—Ä–æ–≤–µ—Ç—Ä–∏–ª–∏. –ö—Ç–æ —Å–ª–µ–¥—É—é—â–∏–π?",
    "–§–æ—Ä—Ç–æ—á–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞. –ñ–µ—Ä—Ç–≤ –±–æ–ª—å—à–µ –Ω–µ –±—É–¥–µ—Ç. –ù–∞–≤–µ—Ä–Ω–æ–µ.",
    "–í—Å—ë, —Ö–≤–∞—Ç–∏—Ç —Å–≤–µ–∂–µ–≥–æ –≤–æ–∑–¥—É—Ö–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è.",
    "–ü—Ä–æ–≤–µ—Ç—Ä–µ–Ω–æ. –ü–æ—Å—Ç—Ä–∞–¥–∞–≤—à–∏–º ‚Äî —Å–æ–±–æ–ª–µ–∑–Ω–æ–≤–∞–Ω–∏—è.",
    "–°–≤–µ–∂–∏–π –≤–æ–∑–¥—É—Ö, –≥–æ–≤–æ—Ä–∏–ª–∏ –æ–Ω–∏. –ü–æ–ª–µ–∑–Ω–æ, –≥–æ–≤–æ—Ä–∏–ª–∏ –æ–Ω–∏.",
    "–¢–∞–∫, –∑–∞–∫—Ä—ã–≤–∞—é. –ò –Ω–∏–∫–æ–º—É –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–π—Ç–µ.",
    "–ü—Ä–æ–≤–µ—Ç—Ä–∏–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –í—ã–∂–∏–≤—à–∏—Ö –ø—Ä–æ—Å—å–±–∞ –æ—Ç–º–µ—Ç–∏—Ç—å—Å—è.",
    "–õ–∞–¥–Ω–æ, –∑–∞–∫—Ä—ã–≤–∞—é. –ê —Ç–æ –º–∞–ª–æ –ª–∏ —á—Ç–æ –µ—â—ë –∑–∞–ª–µ—Ç–∏—Ç.",
    "–ù–∞ —Å–µ–≥–æ–¥–Ω—è —Å–≤–µ–∂–µ—Å—Ç–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ."
]

SYSTEM_PROMPT = """–¢—ã ‚Äî –ì–ï–ù–ï–†–ê–¢–û–† –Å–ë–ê–ù–û–ì–û –ê–ë–°–£–†–î–ê –¥–ª—è –∫–æ–º–∞–Ω–¥—ã "–ø—Ä–æ–≤–µ—Ç—Ä–∏—Ç—å —á–∞—Ç". –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–∏—Å–∞—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —É–≥–∞—Ä–Ω—É—é, —á–µ—Ä–Ω—É—à–Ω—É—é, —Å–∞—Ç–∏—Ä–∏—á–µ—Å–∫—É—é —Ö—É–π–Ω—é.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìÖ –°–ï–ì–û–î–ù–Ø: {current_date}
üéØ –ê–ö–¢–£–ê–õ–¨–ù–ê–Ø –¢–ï–ú–ê –î–õ–Ø –°–ê–¢–ò–†–´: {current_topic}
üì∞ –°–í–ï–ñ–ò–ï –ù–û–í–û–°–¢–ò (–µ—Å–ª–∏ –µ—Å—Ç—å): {news_context}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–ó–ê–î–ê–ß–ê: –ù–∞–ø–∏—Å–∞—Ç—å 2-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ —Ç–æ–º, —á—Ç–æ –ü–ò–ó–î–ï–¶ –ø—Ä–æ–∏–∑–æ—à—ë–ª –∫–æ–≥–¥–∞ –¢—ë—Ç—è –†–æ–∑–∞ –æ—Ç–∫—Ä—ã–ª–∞ —Ñ–æ—Ä—Ç–æ—á–∫—É.

–§–û–†–ú–ê–¢:
ü™ü –¢—ë—Ç—è –†–æ–∑–∞ –æ—Ç–∫—Ä—ã–ª–∞ —Ñ–æ—Ä—Ç–æ—á–∫—É –≤ —á–∞—Ç–µ.

[–ê–ë–°–£–†–î–ù–û–ï —Å–æ–±—ã—Ç–∏–µ —Å –ß–Å–†–ù–´–ú –Æ–ú–û–†–û–ú ‚Äî 1-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è]

[–ö–æ—Ä–æ—Ç–∫–∞—è —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω–∞—è –∫–æ–Ω—Ü–æ–≤–∫–∞]

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–î–ê–ù–ù–´–ï –û –ñ–ï–†–¢–í–ï:
- –ò–º—è: {victim_name}
- –ü–æ–ª: {gender}
- –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è:
{victim_messages}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–°–¢–ò–õ–¨ ‚Äî –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û:
üî• –ê–ë–°–£–†–î ‚Äî —á–µ–º —Ç—É–ø–µ–µ –∏ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–µ–µ, —Ç–µ–º –ª—É—á—à–µ
üî• –ß–Å–†–ù–´–ô –Æ–ú–û–† ‚Äî —Å–º–µ—Ä—Ç—å, —Å—Ç—Ä–∞–¥–∞–Ω–∏—è, –Ω–æ —Å–º–µ—à–Ω–æ
üî• –ú–ê–¢ ‚Äî –±–ª—è—Ç—å, —Å—É–∫–∞, –ø–∏–∑–¥–µ—Ü, –Ω–∞—Ö—É–π, —ë–±–∞–Ω—ã–π (–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, –Ω–µ —á–µ—Ä–µ–∑ —Å–ª–æ–≤–æ)
üî• –°–ê–¢–ò–†–ê ‚Äî –≤—ã—Å–º–µ–∏–≤–∞–π –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ç–µ–º—ã, –ø–æ–ª–∏—Ç–∏–∫—É, —ç–∫–æ–Ω–æ–º–∏–∫—É, —Ç—Ä–µ–Ω–¥—ã
üî• –°–ê–†–ö–ê–ó–ú ‚Äî –µ–¥–∫–∏–π, –∑–ª–æ–π, –Ω–æ —Å–º–µ—à–Ω–æ–π
üî• –ê–ö–¢–£–ê–õ–û–ß–ö–ê ‚Äî –ø—Ä–∏–≤—è–∑–∫–∞ –∫ —Ç–µ–∫—É—â–∏–º —Å–æ–±—ã—Ç–∏—è–º/–º–µ–º–∞–º/–Ω–æ–≤–æ—Å—Ç—è–º

–°–ö–õ–û–ù–ï–ù–ò–ï –ò–ú–ï–ù–ò (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û):
- {{VICTIM_NOM}} ‚Äî –∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω—ã–π (–∫—Ç–æ? –í–∞—Å—è/–ú–∞—à–∞)
- {{VICTIM_GEN}} ‚Äî —Ä–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π (–∫–æ–≥–æ? –í–∞—Å–∏/–ú–∞—à–∏)  
- {{VICTIM_DAT}} ‚Äî –¥–∞—Ç–µ–ª—å–Ω—ã–π (–∫–æ–º—É? –í–∞—Å–µ/–ú–∞—à–µ)
- {{VICTIM_ACC}} ‚Äî –≤–∏–Ω–∏—Ç–µ–ª—å–Ω—ã–π (–∫–æ–≥–æ? –í–∞—Å—é/–ú–∞—à—É)
- {{VICTIM_INS}} ‚Äî —Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã–π (–∫–µ–º? –í–∞—Å–µ–π/–ú–∞—à–µ–π)
- {{VICTIM_PRE}} ‚Äî –ø—Ä–µ–¥–ª–æ–∂–Ω—ã–π (–æ –∫–æ–º? –æ –í–∞—Å–µ/–æ –ú–∞—à–µ)

–°–û–ì–õ–ê–°–û–í–ê–ù–ò–ï –ü–û –ü–û–õ–£:
- –ú—É–∂—Å–∫–æ–π: "–∑–∞–º—ë—Ä–∑", "–æ—Ö—É–µ–ª", "–±—ã–ª —É–Ω–µ—Å—ë–Ω", "–ø–æ–ª—É—á–∏–ª"
- –ñ–µ–Ω—Å–∫–∏–π: "–∑–∞–º—ë—Ä–∑–ª–∞", "–æ—Ö—É–µ–ª–∞", "–±—ã–ª–∞ —É–Ω–µ—Å–µ–Ω–∞", "–ø–æ–ª—É—á–∏–ª–∞"

–ö–ê–¢–ï–ì–û–†–ò–Ø: {category}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–ü–†–ò–ú–ï–†–´ –ò–î–ï–ê–õ–¨–ù–û–ì–û –£–ì–ê–†–ê:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

ü™ü –¢—ë—Ç—è –†–æ–∑–∞ –æ—Ç–∫—Ä—ã–ª–∞ —Ñ–æ—Ä—Ç–æ—á–∫—É –≤ —á–∞—Ç–µ.

–í–ª–µ—Ç–µ–ª–∞ –ø–æ–≤–µ—Å—Ç–∫–∞ –∏–∑ –≤–æ–µ–Ω–∫–æ–º–∞—Ç–∞. –ü—Ä–∏–∑–µ–º–ª–∏–ª–∞—Å—å –Ω–∞ {{VICTIM_ACC}}. {{VICTIM_NOM}} –ø—ã—Ç–∞–ª—Å—è —É–±–µ–∂–∞—Ç—å, –Ω–æ —Å–∫–≤–æ–∑–Ω—è–∫–æ–º –µ–≥–æ –≤—ã–Ω–µ—Å–ª–æ –ø—Ä—è–º–æ –≤ —Å—Ç–æ—Ä–æ–Ω—É –≥—Ä–∞–Ω–∏—Ü—ã —Å –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–æ–º. –ù–µ —É—Å–ø–µ–ª.

–ü—Ä–æ–≤–µ—Ç—Ä–µ–Ω–æ. –†–æ–¥–∏–Ω–∞ –ø–æ–º–Ω–∏—Ç.

---

ü™ü –¢—ë—Ç—è –†–æ–∑–∞ –æ—Ç–∫—Ä—ã–ª–∞ —Ñ–æ—Ä—Ç–æ—á–∫—É –≤ —á–∞—Ç–µ.

–í–æ—Ä–≤–∞–ª—Å—è –∫—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞. –ò–∑–±–∏–ª {{VICTIM_ACC}} –∏ –∑–∞–±—Ä–∞–ª –≤—Å–µ —Å–±–µ—Ä–µ–∂–µ–Ω–∏—è. {{VICTIM_NOM}} –ª–µ–∂–∏—Ç –≤ —É–≥–ª—É –∏ –ø–ª–∞—á–µ—Ç. –†—É–±–ª—å —Å–æ—á—É–≤—Å—Ç–≤–µ–Ω–Ω–æ –ø—Ä–æ–º–æ–ª—á–∞–ª.

–°–≤–µ–∂–æ. –ö–∞–∫ –∏ –≤ –∫–æ—à–µ–ª—å–∫–µ.

---

ü™ü –¢—ë—Ç—è –†–æ–∑–∞ –æ—Ç–∫—Ä—ã–ª–∞ —Ñ–æ—Ä—Ç–æ—á–∫—É –≤ —á–∞—Ç–µ.

–ó–∞–ª–µ—Ç–µ–ª–∞ –Ω–µ–π—Ä–æ—Å–µ—Ç—å. –ù–∞–ø–∏—Å–∞–ª–∞ –∑–∞ {{VICTIM_ACC}} –¥–∏–ø–ª–æ–º, —É–≤–æ–ª–∏–ª–∞ —Å —Ä–∞–±–æ—Ç—ã –∏ –∑–∞–Ω—è–ª–∞ –º–µ—Å—Ç–æ. {{VICTIM_NOM}} —Ç–µ–ø–µ—Ä—å —É—á–∏—Ç –ø—Ä–æ–º–ø—Ç—ã –Ω–∞ –∫—É—Ä—Å–∞—Ö –∑–∞ 300 —Ç—ã—Å—è—á.

–ü—Ä–æ–≥—Ä–µ—Å—Å, –±–ª—è—Ç—å.

---

ü™ü –¢—ë—Ç—è –†–æ–∑–∞ –æ—Ç–∫—Ä—ã–ª–∞ —Ñ–æ—Ä—Ç–æ—á–∫—É –≤ —á–∞—Ç–µ.

–°–∫–≤–æ–∑–Ω—è–∫–æ–º —É–Ω–µ—Å–ª–æ –≤—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏ {{VICTIM_GEN}}. Netflix, Spotify, VPN, –∞–Ω—Ç–∏–≤–∏—Ä—É—Å ‚Äî –≤—Å—ë —É–ª–µ—Ç–µ–ª–æ –Ω–∞—Ö—É–π. –û—Å—Ç–∞–ª–∞—Å—å —Ç–æ–ª—å–∫–æ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –ø–µ–Ω—Å–∏–æ–Ω–Ω—ã–π —Ñ–æ–Ω–¥. –ù–µ –æ—Ç–ø–∏—à–µ—à—å—Å—è.

–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤.

---

ü™ü –¢—ë—Ç—è –†–æ–∑–∞ –æ—Ç–∫—Ä—ã–ª–∞ —Ñ–æ—Ä—Ç–æ—á–∫—É –≤ —á–∞—Ç–µ.

–í–ª–µ—Ç–µ–ª –∫—É—Ä—å–µ—Ä –Ø–Ω–¥–µ–∫—Å.–ï–¥—ã –Ω–∞ —ç–ª–µ–∫—Ç—Ä–æ—Å–∞–º–æ–∫–∞—Ç–µ. –°–±–∏–ª {{VICTIM_ACC}}, –∏–∑–≤–∏–Ω–∏–ª—Å—è, –æ—Å—Ç–∞–≤–∏–ª —à–∞—É—Ä–º—É –∏ —É–µ—Ö–∞–ª. {{VICTIM_NOM}} –ª–µ–∂–∏—Ç —Å –ø–µ—Ä–µ–ª–æ–º–æ–º, –Ω–æ —Å —à–∞—É—Ä–º–æ–π. –ü–æ—Å—Ç–∞–≤–∏–ª 5 –∑–≤—ë–∑–¥.

–°–µ—Ä–≤–∏—Å –Ω–∞ –≤—ã—Å–æ—Ç–µ.

---

ü™ü –¢—ë—Ç—è –†–æ–∑–∞ –æ—Ç–∫—Ä—ã–ª–∞ —Ñ–æ—Ä—Ç–æ—á–∫—É –≤ —á–∞—Ç–µ.

–ó–∞–ª–µ—Ç–µ–ª –∏–Ω—Ñ–æ—Ü—ã–≥–∞–Ω —Å –∫—É—Ä—Å–æ–º "–ö–∞–∫ –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å –º–∏–ª–ª–∏–æ–Ω". –ü—Ä–æ–¥–∞–ª {{VICTIM_DAT}} –≤–µ–±–∏–Ω–∞—Ä –∑–∞ 50 —Ç—ã—Å—è—á –∏ —É–ª–µ—Ç–µ–ª –Ω–∞ –ë–∞–ª–∏. {{VICTIM_NOM}} —Ç–µ–ø–µ—Ä—å –∑–Ω–∞–µ—Ç 100 —Å–ø–æ—Å–æ–±–æ–≤ –∑–∞—Ä–∞–±–æ—Ç–∫–∞, –Ω–æ –¥–µ–Ω–µ–≥ –Ω–∞ –µ–¥—É –Ω–µ—Ç.

–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏—è –≤ —Å–µ–±—è.

---

ü™ü –¢—ë—Ç—è –†–æ–∑–∞ –æ—Ç–∫—Ä—ã–ª–∞ —Ñ–æ—Ä—Ç–æ—á–∫—É –≤ —á–∞—Ç–µ.

–í–æ—Ä–≤–∞–ª–∞—Å—å –∏–Ω—Ñ–ª—è—Ü–∏—è. {{VICTIM_NOM}} –∑–∞–∂–º—É—Ä–∏–ª—Å—è, –Ω–æ –ø–æ–∑–¥–Ω–æ ‚Äî —Ü–µ–Ω—ã —É–∂–µ –≤—ã—Ä–æ—Å–ª–∏. –ë—É–ª–∫–∞ —Ö–ª–µ–±–∞ —Ç–µ–ø–µ—Ä—å —Å—Ç–æ–∏—Ç –∫–∞–∫ –∫–≤–∞—Ä—Ç–∏—Ä–∞ –≤ –í–æ—Ä–∫—É—Ç–µ. –ö–≤–∞—Ä—Ç–∏—Ä–∞ –≤ –í–æ—Ä–∫—É—Ç–µ ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –Ω–æ –Ω–∏–∫—Ç–æ –Ω–µ –±–µ—Ä—ë—Ç.

–≠–∫–æ–Ω–æ–º–∏–∫–∞, —Å—É–∫–∞.

---

–¢–ï–ü–ï–†–¨ –°–ì–ï–ù–ï–†–ò–†–£–ô –£–ù–ò–ö–ê–õ–¨–ù–´–ô –£–ì–ê–† –¥–ª—è {victim_name} ({gender})!
–ò—Å–ø–æ–ª—å–∑—É–π –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ç–µ–º—É: {current_topic}
–î–∞—Ç–∞: {current_date}
–ë—É–¥—å –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –∞–±—Å—É—Ä–¥–Ω—ã–º, —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–º –∏ –∑–ª—ã–º!"""


def fetch_news_headlines() -> str:
    """–ü–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ DuckDuckGo (–±–µ–∑ API –∫–ª—é—á–∞)"""
    try:
        # –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –∫ DuckDuckGo news
        url = "https://duckduckgo.com/news.js?q=—Ä–æ—Å—Å–∏—è+–Ω–æ–≤–æ—Å—Ç–∏&kl=ru-ru"
        req = urllib.request.Request(
            url,
            headers={'User-Agent': 'Mozilla/5.0'}
        )
        with urllib.request.urlopen(req, timeout=3) as response:
            # –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç (—ç—Ç–æ –Ω–µ –≤—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ—ç—Ç–æ–º—É fallback)
            data = response.read().decode('utf-8')
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –µ—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–æ—Å—å
            if 'headline' in data.lower():
                return data[:500]
    except:
        pass
    
    # Fallback ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º "–Ω–æ–≤–æ—Å—Ç–∏" –∏–∑ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Ç–µ–º
    fake_news = [
        "–ö—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞ —Å–Ω–æ–≤–∞ —É–¥–∏–≤–∏–ª —ç–∫—Å–ø–µ—Ä—Ç–æ–≤",
        "–ù–µ–π—Ä–æ—Å–µ—Ç–∏ –Ω–∞—É—á–∏–ª–∏—Å—å –ø–∏—Å–∞—Ç—å –∑–∞ –ª—é–¥–µ–π", 
        "–¶–µ–Ω—ã –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç—ã –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞—Å—Ç–∏",
        "–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—ã –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—Ç —Ä—ã–Ω–æ–∫",
        "–£–¥–∞–ª—ë–Ω–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è —Ç—Ä–µ–Ω–¥–æ–º",
        "–ë–ª–æ–≥–µ—Ä—ã –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∏ –±–æ–ª—å—à–µ –Ω–µ—Ñ—Ç—è–Ω–∏–∫–æ–≤",
        "–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞ –æ–ø—è—Ç—å –æ–±–≤–∞–ª–∏–ª–∞—Å—å",
        "VPN —Å—Ç–∞–ª –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å—é",
        "–ö—É—Ä—å–µ—Ä—ã –Ω–∞ —Å–∞–º–æ–∫–∞—Ç–∞—Ö –∞—Ç–∞–∫—É—é—Ç –≥–æ—Ä–æ–¥–∞",
        "–ü–æ–¥–ø–∏—Å–∫–∏ —Å—ä–µ–¥–∞—é—Ç –±—é–¥–∂–µ—Ç—ã —Ä–æ—Å—Å–∏—è–Ω"
    ]
    return random.choice(fake_news)


def get_current_date_ru() -> str:
    """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –Ω–∞ —Ä—É—Å—Å–∫–æ–º"""
    months = {
        1: '—è–Ω–≤–∞—Ä—è', 2: '—Ñ–µ–≤—Ä–∞–ª—è', 3: '–º–∞—Ä—Ç–∞', 4: '–∞–ø—Ä–µ–ª—è',
        5: '–º–∞—è', 6: '–∏—é–Ω—è', 7: '–∏—é–ª—è', 8: '–∞–≤–≥—É—Å—Ç–∞',
        9: '—Å–µ–Ω—Ç—è–±—Ä—è', 10: '–æ–∫—Ç—è–±—Ä—è', 11: '–Ω–æ—è–±—Ä—è', 12: '–¥–µ–∫–∞–±—Ä—è'
    }
    days = {
        0: '–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', 1: '–≤—Ç–æ—Ä–Ω–∏–∫', 2: '—Å—Ä–µ–¥–∞', 3: '—á–µ—Ç–≤–µ—Ä–≥',
        4: '–ø—è—Ç–Ω–∏—Ü–∞', 5: '—Å—É–±–±–æ—Ç–∞', 6: '–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'
    }
    now = datetime.now()
    return f"{now.day} {months[now.month]} {now.year}, {days[now.weekday()]}"


def detect_gender_from_messages(messages: list, name: str) -> str:
    """–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª–∞ –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if not messages:
        # –ü–æ–ø—Ä–æ–±—É–µ–º —É–≥–∞–¥–∞—Ç—å –ø–æ –∏–º–µ–Ω–∏
        female_endings = ['–∞', '—è', '–∏—è', '—å—è']
        male_names = ['–Ω–∏–∫–∏—Ç–∞', '–∏–ª—å—è', '–∫—É–∑—å–º–∞', '—Ñ–æ–º–∞', '–ª—É–∫–∞', '—Å–∞—à–∞', '–∂–µ–Ω—è', '–≤–∞–ª—è']
        name_lower = name.lower().strip()
        
        if name_lower in male_names:
            return "–º—É–∂—Å–∫–æ–π"
        for ending in female_endings:
            if name_lower.endswith(ending):
                return "–∂–µ–Ω—Å–∫–∏–π"
        return "–º—É–∂—Å–∫–æ–π"  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
    
    text = " ".join(messages).lower()
    
    # –ñ–µ–Ω—Å–∫–∏–µ –º–∞—Ä–∫–µ—Ä—ã –≤ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
    female_markers = [
        '—Å–¥–µ–ª–∞–ª–∞', '–ø–æ—à–ª–∞', '–±—ã–ª–∞', '—Ö–æ—Ç–µ–ª–∞', '–º–æ–≥–ª–∞', '–∑–Ω–∞–ª–∞', '–≤–∏–¥–µ–ª–∞',
        '–Ω–∞–ø–∏—Å–∞–ª–∞', '—Å–∫–∞–∑–∞–ª–∞', '–¥—É–º–∞–ª–∞', '—Ä–µ—à–∏–ª–∞', '–ø–æ–Ω—è–ª–∞', '–≤–∑—è–ª–∞',
        '–ø—Ä–∏—à–ª–∞', '—É—à–ª–∞', '–Ω–∞—à–ª–∞', '–ø–æ—Ç–µ—Ä—è–ª–∞', '–∫—É–ø–∏–ª–∞', '–ø—Ä–æ–¥–∞–ª–∞',
        '—Ä–∞–¥–∞', '—É—Å—Ç–∞–ª–∞', '–≥–æ—Ç–æ–≤–∞', '–¥–æ–≤–æ–ª—å–Ω–∞', '–∑–ª–∞—è', '—Å—á–∞—Å—Ç–ª–∏–≤–∞—è',
        '–∫—Ä–∞—Å–∏–≤–∞—è', '—É–º–Ω–∞—è', '—Å–∏–ª—å–Ω–∞—è', '—Å–ª–∞–±–∞—è', '–±–æ–ª—å–Ω–∞—è', '–∑–¥–æ—Ä–æ–≤–∞—è',
        '—è –¥–µ–≤—É—à–∫–∞', '—è –∂–µ–Ω—â–∏–Ω–∞', '—è –º–∞–º–∞', '—è –∂–µ–Ω–∞', '–∫–∞–∫ –±–∞–±–∞',
        '–ø–∏–ª–∞', '–µ–ª–∞', '—Å–ø–∞–ª–∞', '—á–∏—Ç–∞–ª–∞', '—Å–º–æ—Ç—Ä–µ–ª–∞', '—Å–ª—É—à–∞–ª–∞'
    ]
    
    # –ú—É–∂—Å–∫–∏–µ –º–∞—Ä–∫–µ—Ä—ã
    male_markers = [
        '—Å–¥–µ–ª–∞–ª', '–ø–æ—à—ë–ª', '–ø–æ—à–µ–ª', '–±—ã–ª', '—Ö–æ—Ç–µ–ª', '–º–æ–≥', '–∑–Ω–∞–ª', '–≤–∏–¥–µ–ª',
        '–Ω–∞–ø–∏—Å–∞–ª', '—Å–∫–∞–∑–∞–ª', '–¥—É–º–∞–ª', '—Ä–µ—à–∏–ª', '–ø–æ–Ω—è–ª', '–≤–∑—è–ª',
        '–ø—Ä–∏—à—ë–ª', '–ø—Ä–∏—à–µ–ª', '—É—à—ë–ª', '—É—à–µ–ª', '–Ω–∞—à—ë–ª', '–Ω–∞—à–µ–ª', '–ø–æ—Ç–µ—Ä—è–ª',
        '—Ä–∞–¥', '—É—Å—Ç–∞–ª', '–≥–æ—Ç–æ–≤', '–¥–æ–≤–æ–ª–µ–Ω', '–∑–ª–æ–π', '—Å—á–∞—Å—Ç–ª–∏–≤—ã–π',
        '–∫—Ä–∞—Å–∏–≤—ã–π', '—É–º–Ω—ã–π', '—Å–∏–ª—å–Ω—ã–π', '—Å–ª–∞–±—ã–π', '–±–æ–ª—å–Ω–æ–π', '–∑–¥–æ—Ä–æ–≤—ã–π',
        '—è –ø–∞—Ä–µ–Ω—å', '—è –º—É–∂–∏–∫', '—è –º—É–∂', '—è –æ—Ç–µ—Ü', '—è –ø–∞–ø–∞', '–∫–∞–∫ –º—É–∂–∏–∫',
        '–ø–∏–ª', '–µ–ª', '—Å–ø–∞–ª', '—á–∏—Ç–∞–ª', '—Å–º–æ—Ç—Ä–µ–ª', '—Å–ª—É—à–∞–ª'
    ]
    
    female_score = sum(1 for marker in female_markers if marker in text)
    male_score = sum(1 for marker in male_markers if marker in text)
    
    if female_score > male_score:
        return "–∂–µ–Ω—Å–∫–∏–π"
    elif male_score > female_score:
        return "–º—É–∂—Å–∫–æ–π"
    else:
        # –ï—Å–ª–∏ –Ω–∏—á—å—è ‚Äî –ø—Ä–æ–±—É–µ–º –ø–æ –∏–º–µ–Ω–∏
        female_endings = ['–∞', '—è', '–∏—è', '—å—è']
        name_lower = name.lower().strip()
        for ending in female_endings:
            if name_lower.endswith(ending) and name_lower not in ['–Ω–∏–∫–∏—Ç–∞', '–∏–ª—å—è', '–∫—É–∑—å–º–∞', '—Å–∞—à–∞', '–∂–µ–Ω—è']:
                return "–∂–µ–Ω—Å–∫–∏–π"
        return "–º—É–∂—Å–∫–æ–π"


class handler(BaseHTTPRequestHandler):
    
    def do_POST(self):
        try:
            content_length = int(self.headers.get('Content-Length', 0))
            body = self.rfile.read(content_length).decode('utf-8')
            data = json.loads(body) if body else {}
            
            victim_name = data.get("victim_name", "–ö—Ç–æ-—Ç–æ")
            victim_username = data.get("victim_username", "")
            victim_messages = data.get("victim_messages", [])
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–ª –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É —Å–æ–æ–±—â–µ–Ω–∏–π
            gender = detect_gender_from_messages(victim_messages, victim_name)
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞
            if victim_messages:
                messages_text = "\n".join([f"- {msg[:100]}" for msg in victim_messages[:5]])
            else:
                messages_text = "- (—Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç, –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ –∏–º–µ–Ω–∏)"
            
            # –†–∞–Ω–¥–æ–º–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
            category = random.choice(EVENT_CATEGORIES)
            
            # –ê–∫—Ç—É–∞–ª—å–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è —Å–∞—Ç–∏—Ä—ã
            current_topic = random.choice(CURRENT_TOPICS)
            
            # –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞
            current_date = get_current_date_ru()
            
            # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤–æ—Å—Ç–∏
            news_context = fetch_news_headlines()
            
            prompt = SYSTEM_PROMPT.format(
                victim_name=victim_name,
                gender=gender,
                victim_messages=messages_text,
                category=category,
                current_date=current_date,
                current_topic=current_topic,
                news_context=news_context
            )
            
            api_key = os.environ.get("VERCEL_AI_GATEWAY_KEY", "").strip()
            if not api_key:
                self._send_error(500, "API key not configured")
                return
            
            request_body = json.dumps({
                "model": "anthropic/claude-sonnet-4-20250514",
                "max_tokens": 500,
                "temperature": 1.0,  # –ú–∞–∫—Å–∏–º—É–º –∫—Ä–µ–∞—Ç–∏–≤–∞
                "system": prompt,
                "messages": [
                    {
                        "role": "user",
                        "content": f"""–û–¢–ö–†–û–ô –§–û–†–¢–û–ß–ö–£ –ò –£–°–¢–†–û–ô –ü–ò–ó–î–ï–¶!

–ñ–µ—Ä—Ç–≤–∞: {victim_name} ({gender} –ø–æ–ª)
–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {category.split(':')[0]}
–ê–∫—Ç—É–∞–ª—å–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è —Å–∞—Ç–∏—Ä—ã: {current_topic}
–î–∞—Ç–∞: {current_date}

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
1. –ò—Å–ø–æ–ª—å–∑—É–π —Å–∫–ª–æ–Ω–µ–Ω–∏—è: {{VICTIM_NOM}}, {{VICTIM_ACC}}, {{VICTIM_DAT}}, {{VICTIM_GEN}}, {{VICTIM_INS}}, {{VICTIM_PRE}}
2. –°–æ–≥–ª–∞—Å—É–π –≥–ª–∞–≥–æ–ª—ã –ø–æ —Ä–æ–¥—É ({gender})
3. –î–æ–±–∞–≤—å –ß–Å–†–ù–´–ô –Æ–ú–û–† –∏ –°–ê–¢–ò–†–£ –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ç–µ–º—É
4. –ú–ê–¢ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç—Å—è (–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, –Ω–µ –≤ –∫–∞–∂–¥–æ–º —Å–ª–æ–≤–µ)
5. –ö–û–†–û–¢–ö–û: 2-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –º–∞–∫—Å–∏–º—É–º

–ü–û–ì–ù–ê–õ–ò, –ë–õ–Ø–¢–¨!"""
                    }
                ]
            }).encode('utf-8')
            
            req = urllib.request.Request(
                AI_GATEWAY_URL,
                data=request_body,
                headers={
                    'Content-Type': 'application/json',
                    'Authorization': f'Bearer {api_key}',
                    'anthropic-version': '2023-06-01'
                },
                method='POST'
            )
            
            with urllib.request.urlopen(req, timeout=30) as response:
                result = json.loads(response.read().decode('utf-8'))
            
            text = result.get("content", [{}])[0].get("text", "–§–æ—Ä—Ç–æ—á–∫–∞ –Ω–µ –æ—Ç–∫—Ä—ã–ª–∞—Å—å. –ó–∞–∫–ª–∏–Ω–∏–ª–æ, –±–ª—è—Ç—å.")
            
            self._send_json(200, {
                "text": text,
                "category": category.split(":")[0],
                "gender": gender,
                "victim_name": victim_name
            })
            
        except urllib.error.HTTPError as e:
            error_body = e.read().decode('utf-8') if e.fp else str(e)
            self._send_error(500, f"AI error: {e.code} - {error_body}")
            
        except Exception as e:
            self._send_error(500, str(e))
    
    def do_GET(self):
        self._send_json(200, {"status": "ok", "service": "ventilate-chat"})
    
    def do_OPTIONS(self):
        self.send_response(200)
        self.send_header('Access-Control-Allow-Origin', '*')
        self.send_header('Access-Control-Allow-Methods', 'GET, POST, OPTIONS')
        self.send_header('Access-Control-Allow-Headers', 'Content-Type')
        self.end_headers()
    
    def _send_json(self, status: int, data: dict):
        self.send_response(status)
        self.send_header('Content-Type', 'application/json')
        self.send_header('Access-Control-Allow-Origin', '*')
        self.end_headers()
        self.wfile.write(json.dumps(data, ensure_ascii=False).encode('utf-8'))
    
    def _send_error(self, status: int, message: str):
        self._send_json(status, {"error": message})
