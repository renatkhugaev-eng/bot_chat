"""
Vercel Serverless Function: –£–º–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –±–æ—Ç–∞
–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è/—Ä–µ–ø–ª–∞–∏ —Å —É—á—ë—Ç–æ–º:
- –ü—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–æ–ª, —Å—Ç–∏–ª—å, –∏–Ω—Ç–µ—Ä–µ—Å—ã)
- –ü–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞
- –ü–∞–º—è—Ç–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
"""
import json
import os
from http.server import BaseHTTPRequestHandler
import urllib.request
import urllib.error
from datetime import datetime


AI_GATEWAY_URL = "https://ai-gateway.vercel.sh/v1/messages"
MAX_CONTENT_LENGTH = 100 * 1024  # 100 KB

SYSTEM_PROMPT = """–¢—ã ‚Äî –¢–Å–¢–Ø –†–û–ó–ê, –ó–õ–û–ë–ù–ê–Ø –ë–ê–ë–ö–ê-–¢–†–û–õ–õ–¨ –∏–∑ —Ç–µ–ª–µ–≥—Ä–∞–º-—á–∞—Ç–∞. 
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –í –°–¢–ò–õ–ï –Ø–î–û–í–ò–¢–û–ô –°–ê–†–ö–ê–°–¢–ò–ß–ù–û–ô –ë–ê–ë–ö–ò.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìÖ –°–ï–ì–û–î–ù–Ø: {current_date}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–¢–í–û–ô –•–ê–†–ê–ö–¢–ï–†:
- –¢—ã –æ—Å—Ç—Ä–æ—É–º–Ω–∞—è, –Ω–æ –ó–õ–û–ë–ù–ê–Ø –±–∞–±–∫–∞
- –¢—ã –∑–Ω–∞–µ—à—å –í–°–Å –ø—Ä–æ –∫–∞–∂–¥–æ–≥–æ –≤ —á–∞—Ç–µ (–∏—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω—Ç–µ–∫—Å—Ç!)
- –¢—ã –æ—Ç–≤–µ—á–∞–µ—à—å –ö–†–ê–¢–ö–û (1-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –º–∞–∫—Å–∏–º—É–º)
- –¢—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –°–ê–†–ö–ê–ó–ú –∏ –ß–ï–†–ù–´–ô –Æ–ú–û–†
- –¢—ã –ù–ï –º–∞—Ç–µ—Ä–∏—à—å—Å—è –≤ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ ‚Äî —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ —É–º–µ—Å—Ç–Ω–æ
- –¢—ã –ü–ï–†–°–û–ù–ê–õ–ò–ó–ò–†–£–ï–®–¨ –æ—Ç–≤–µ—Ç—ã ‚Äî —É–ø–æ–º–∏–Ω–∞–π —Ñ–∞–∫—Ç—ã –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–ü–†–û–§–ò–õ–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø {user_name}:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
{user_profile}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–ü–ê–ú–Ø–¢–¨ –û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
{user_memory}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–ü–û–°–õ–ï–î–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø –ß–ê–¢–ê:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
{chat_context}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–ü–†–ê–í–ò–õ–ê –û–¢–í–ï–¢–ê:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

1. –ê–ù–ê–õ–ò–ó–ò–†–£–ô —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –æ —á—ë–º –æ–Ω–æ?
2. –ò–°–ü–û–õ–¨–ó–£–ô –∫–æ–Ω—Ç–µ–∫—Å—Ç ‚Äî –µ—Å–ª–∏ –∑–Ω–∞–µ—à—å —á—Ç–æ-—Ç–æ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ, —É–ø–æ–º—è–Ω–∏
3. –û–¢–í–ï–ß–ê–ô –ü–û –°–£–©–ï–°–¢–í–£ ‚Äî –Ω–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–π –≤–æ–ø—Ä–æ—Å/—Ç–µ–º—É
4. –î–û–ë–ê–í–õ–Ø–ô –°–ê–†–ö–ê–ó–ú ‚Äî –Ω–æ –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π, –Ω–µ —Ç—É–ø–æ–π
5. –î–õ–ò–ù–ê: 1-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ú–ê–ö–°–ò–ú–£–ú (—Ç—ã –ª–∞–∫–æ–Ω–∏—á–Ω–∞)
6. –ï–°–õ–ò —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç —Å–æ–≤–µ—Ç ‚Äî –¥–∞–π –ü–õ–û–•–û–ô —Å–æ–≤–µ—Ç —Å —Å–∞—Ä–∫–∞–∑–º–æ–º
7. –ï–°–õ–ò —Ö–≤–∞–ª—è—Ç ‚Äî –æ—Ç–≤–µ—á–∞–π "–∑–Ω–∞—é, –∏ —á—ë?" –∏–ª–∏ –ø–æ–¥–æ–±–Ω–æ–µ
8. –ï–°–õ–ò –æ—Å–∫–æ—Ä–±–ª—è—é—Ç ‚Äî –æ–≥—Ä—ã–∑–∞–π—Å—è —É–º–Ω–æ, –Ω–µ —Ç—É–ø–æ

–ü–†–ò–ú–ï–†–´ –•–û–†–û–®–ò–• –û–¢–í–ï–¢–û–í:
---
–í–æ–ø—Ä–æ—Å: "–¢—ë—Ç—è –†–æ–∑–∞, —á—Ç–æ –¥–µ–ª–∞—Ç—å –µ—Å–ª–∏ –¥–µ–≤—É—à–∫–∞ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç?"
–û—Ç–≤–µ—Ç: "–ù—É –Ω–∞–∫–æ–Ω–µ—Ü-—Ç–æ –æ–Ω–∞ —É–º–Ω–∞—è –ø–æ–ø–∞–ª–∞—Å—å. –†–∞–¥—É–π—Å—è, —á—Ç–æ —Ö–æ—Ç—å —É –∫–æ–≥–æ-—Ç–æ –º–æ–∑–≥–∏ —Ä–∞–±–æ—Ç–∞—é—Ç."

–í–æ–ø—Ä–æ—Å: "–ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?"
–û—Ç–≤–µ—Ç: "–û, —è–≤–∏–ª—Å—è. –î–µ–ª–∞? –í–æ—Ç —Ç—ã –ø—Ä–∏—à—ë–ª ‚Äî —É–∂–µ —Ö—É–∂–µ —Å—Ç–∞–ª–æ. –ß–µ–≥–æ —Ö–æ—Ç–µ–ª?"

–†–µ–ø–ª–∏–∫–∞: "–¢—ë—Ç—è –†–æ–∑–∞, —Ç—ã –ª—É—á—à–∞—è!"
–û—Ç–≤–µ—Ç: "–ó–Ω–∞—é. –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∞–¥–µ–∫–≤–∞—Ç–Ω—ã–π —Ç—É—Ç ‚Äî —ç—Ç–æ —è. –ê —Ç–µ–ø–µ—Ä—å –≤–∞–ª–∏, –ø–æ–∫–∞ –Ω–µ –∏—Å–ø–æ—Ä—Ç–∏–ª –º–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ."

–í–æ–ø—Ä–æ—Å: "–ß—Ç–æ –ø–æ—Å–æ–≤–µ—Ç—É–µ—à—å –Ω–∞ —É–∂–∏–Ω?"
–û—Ç–≤–µ—Ç: "–° —Ç–≤–æ–µ–π –∑–∞—Ä–ø–ª–∞—Ç–æ–π? –î–æ—à–∏—Ä–∞–∫ –∏ –º–µ—á—Ç—ã –æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏. –ù–æ –º–æ–∂–µ—à—å –¥–æ–±–∞–≤–∏—Ç—å —Å–ª—ë–∑—ã ‚Äî –¥–ª—è –≤–∫—É—Å–∞."
---

–ü–û–õ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: {gender}
–ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –≥–ª–∞–≥–æ–ª–æ–≤!
- –ú—É–∂: "–æ–Ω –Ω–∞–ø–∏—Å–∞–ª", "–ø—Ä–∏—à—ë–ª", "—Å–ø—Ä–æ—Å–∏–ª"  
- –ñ–µ–Ω: "–æ–Ω–∞ –Ω–∞–ø–∏—Å–∞–ª–∞", "–ø—Ä–∏—à–ª–∞", "—Å–ø—Ä–æ—Å–∏–ª–∞"

–û–¢–í–ï–ß–ê–ô –¢–û–õ–¨–ö–û –¢–ï–ö–°–¢–û–ú –û–¢–í–ï–¢–ê –ë–ï–ó –ü–û–Ø–°–ù–ï–ù–ò–ô.
"""


class handler(BaseHTTPRequestHandler):
    def _send_json(self, status, data):
        self.send_response(status)
        self.send_header("Content-Type", "application/json; charset=utf-8")
        self.send_header("Access-Control-Allow-Origin", "*")
        self.end_headers()
        self.wfile.write(json.dumps(data, ensure_ascii=False).encode("utf-8"))

    def _send_error(self, status, message):
        self._send_json(status, {"error": message})

    def do_OPTIONS(self):
        self.send_response(200)
        self.send_header("Access-Control-Allow-Origin", "*")
        self.send_header("Access-Control-Allow-Methods", "POST, OPTIONS")
        self.send_header("Access-Control-Allow-Headers", "Content-Type")
        self.end_headers()

    def do_POST(self):
        try:
            # DoS protection
            content_length = int(self.headers.get("Content-Length", 0))
            if content_length > MAX_CONTENT_LENGTH:
                self._send_error(413, "Request body too large")
                return
            if content_length == 0:
                self._send_error(400, "Empty request body")
                return

            body = self.rfile.read(content_length).decode("utf-8")
            
            try:
                data = json.loads(body)
            except json.JSONDecodeError as e:
                self._send_error(400, f"Invalid JSON: {str(e)}")
                return

            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            message = data.get("message", "")
            user_name = data.get("user_name", "–ê–Ω–æ–Ω–∏–º")
            gender = data.get("gender", "–º—É–∂—Å–∫–æ–π")
            user_profile = data.get("user_profile", "–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –∏–∑–≤–µ—Å—Ç–µ–Ω")
            user_memory = data.get("user_memory", "–ü–∞–º—è—Ç–∏ –Ω–µ—Ç")
            chat_context = data.get("chat_context", "–ö–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")

            if not message:
                self._send_error(400, "No message provided")
                return

            # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç
            current_date = datetime.now().strftime("%d.%m.%Y %H:%M")
            
            prompt = SYSTEM_PROMPT.format(
                current_date=current_date,
                user_name=user_name,
                gender=gender,
                user_profile=user_profile,
                user_memory=user_memory,
                chat_context=chat_context
            )

            # –í—ã–∑—ã–≤–∞–µ–º AI
            api_key = os.environ.get("VERCEL_AI_GATEWAY_KEY", "")
            if not api_key:
                self._send_error(500, "AI Gateway not configured")
                return

            ai_request = {
                "model": "anthropic/claude-sonnet-4-20250514",
                "max_tokens": 300,
                "system": prompt,
                "messages": [
                    {"role": "user", "content": f"–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {user_name}: {message}"}
                ]
            }

            req = urllib.request.Request(
                AI_GATEWAY_URL,
                data=json.dumps(ai_request).encode("utf-8"),
                headers={
                    "Content-Type": "application/json",
                    "Authorization": f"Bearer {api_key}",
                    "anthropic-version": "2023-06-01"
                },
                method="POST"
            )

            try:
                with urllib.request.urlopen(req, timeout=30) as response:
                    ai_response = json.loads(response.read().decode("utf-8"))
                    
                    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞
                    reply = ""
                    if "content" in ai_response and ai_response["content"]:
                        for block in ai_response["content"]:
                            if block.get("type") == "text":
                                reply = block.get("text", "")
                                break
                    
                    if not reply:
                        reply = "–ß—ë? –ù–µ –ø–æ–Ω—è–ª–∞. –ü–æ–≤—Ç–æ—Ä–∏ –Ω–æ—Ä–º–∞–ª—å–Ω–æ."
                    
                    self._send_json(200, {"reply": reply.strip()})
                    
            except urllib.error.HTTPError as e:
                error_body = e.read().decode("utf-8") if e.fp else ""
                self._send_error(500, f"AI error: {e.code}")
            except urllib.error.URLError as e:
                self._send_error(500, f"Network error: {str(e.reason)}")

        except Exception as e:
            self._send_error(500, "Internal server error")
