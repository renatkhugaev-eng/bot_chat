"""
Vercel Serverless Function: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∏—Ö–æ–≤-—É–Ω–∏–∂–µ–Ω–∏–π –≤ —Å—Ç–∏–ª–µ —Ä—É—Å—Å–∫–∏—Ö –∫–ª–∞—Å—Å–∏–∫–æ–≤
"""
import json
import os
import random
from http.server import BaseHTTPRequestHandler
import urllib.request
import urllib.error


# Vercel AI Gateway endpoint
AI_GATEWAY_URL = "https://ai-gateway.vercel.sh/v1/messages"

POETS = {
    "pushkin": {
        "name": "–ê.–°. –ü—É—à–∫–∏–Ω",
        "emoji": "ü™∂",
        "style": """–ü–∏—à–∏ –≤ —Å—Ç–∏–ª–µ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞ –ü—É—à–∫–∏–Ω–∞, –ù–û –° –ú–ê–¢–û–ú –ò –£–ù–ò–ñ–ï–ù–ò–Ø–ú–ò:
- –Ø–º–±–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä, —Ä–∏—Ñ–º–æ–≤–∫–∞ ABAB
- 2-3 —Å—Ç—Ä–æ—Ñ—ã –ø–æ 4 —Å—Ç—Ä–æ–∫–∏
- –ê—Ä—Ö–∞–∏–∑–º—ã ("—Å–µ–π –¥–µ–±–∏–ª", "—Ç–æ–∫–º–æ –¥–æ–ª–±–æ—ë–±", "–∫–æ–ª—å —Ç—ã –º—É–¥–∞–∫")
- –ò–∑—è—â–Ω–æ–µ —É–Ω–∏–∂–µ–Ω–∏–µ —Å –∞—Ä–∏—Å—Ç–æ–∫—Ä–∞—Ç–∏—á–µ—Å–∫–∏–º –ø—Ä–µ–∑—Ä–µ–Ω–∏–µ–º
- –ú–∞—Ç –≤–ø–ª–µ—Ç–∞–π —ç–ª–µ–≥–∞–Ω—Ç–Ω–æ: "–ò –≤ –∂–æ–ø—É —à—ë–ª —Å–µ–π –≥–æ—Å–ø–æ–¥–∏–Ω"
- –í—ã—Å–º–µ–∏–≤–∞–π —Ç—É–ø–æ—Å—Ç—å, –Ω–∏—â–µ—Ç—É, –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ"""
    },
    "lermontov": {
        "name": "–ú.–Æ. –õ–µ—Ä–º–æ–Ω—Ç–æ–≤",
        "emoji": "‚öîÔ∏è",
        "style": """–ü–∏—à–∏ –≤ —Å—Ç–∏–ª–µ –ú–∏—Ö–∞–∏–ª–∞ –õ–µ—Ä–º–æ–Ω—Ç–æ–≤–∞, –ù–û –ñ–Å–°–¢–ö–û:
- –ú—Ä–∞—á–Ω—ã–π, –¥–µ–ø—Ä–µ—Å—Å–∏–≤–Ω—ã–π —Ç–æ–Ω
- –†–∏—Ñ–º–æ–≤–∫–∞ ABAB –∏–ª–∏ AABB, 2-3 —Å—Ç—Ä–æ—Ñ—ã
- –¢–µ–º–∞: —á–µ–ª–æ–≤–µ–∫ ‚Äî –Ω–∏—á—Ç–æ–∂–µ—Å—Ç–≤–æ, –∏–∑–≥–æ–π, –Ω–µ—É–¥–∞—á–Ω–∏–∫
- –î—Ä–∞–º–∞—Ç–∏—á–Ω—ã–µ —É–Ω–∏–∂–µ–Ω–∏—è: "–û–¥–∏–Ω, –∫–∞–∫ —Ö—É–π –≤ –ø—É—Å—Ç—ã–Ω–µ"
- –ú–µ—Ç–∞—Ñ–æ—Ä—ã —Å—Ç—Ä–∞–¥–∞–Ω–∏—è –∏ –Ω–∏–∫—á—ë–º–Ω–æ—Å—Ç–∏
- –ú–∞—Ç –æ—Ä–≥–∞–Ω–∏—á–Ω–æ: "–ò –¥–µ–º–æ–Ω —Å—Ä–∞–ª –µ–º—É –≤ –¥—É—à—É"
- –í—ã—Å–º–µ–∏–≤–∞–π –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ, –ø—Ä–æ–≤–∞–ª—ã –≤ –∂–∏–∑–Ω–∏"""
    },
    "mayakovsky": {
        "name": "–í.–í. –ú–∞—è–∫–æ–≤—Å–∫–∏–π",
        "emoji": "üì¢",
        "style": """–ü–∏—à–∏ –≤ —Å—Ç–∏–ª–µ –í–ª–∞–¥–∏–º–∏—Ä–∞ –ú–∞—è–∫–æ–≤—Å–∫–æ–≥–æ ‚Äî –ê–ì–†–ï–°–°–ò–í–ù–û:
- –†—É–±–ª–µ–Ω—ã–π —Ä–∏—Ç–º, –º–æ–∂–Ω–æ –ª–µ—Å–µ–Ω–∫–æ–π
- –î–µ—Ä–∑–∫–æ, –≥—Ä–æ–º–∫–æ, –≤ –ª–æ–±!
- –û–±—Ä–∞—â–µ–Ω–∏—è: "–≠–π, —Ç—ã!", "–°–ª—É—à–∞–π —Å—é–¥–∞, –º—É–¥–∏–ª–∞!"
- –ù–µ–æ–ª–æ–≥–∏–∑–º—ã-–æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è: "–¥–æ–ª–±–æ—ë–±–∏—â–µ", "—Ö—É–µ–ø–ª—ë—Ç–∏–Ω–∞"
- –°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å–∞—Ç–∏—Ä–∞: –∫—Ä–µ–¥–∏—Ç—ã, –Ω–∏—â–µ—Ç–∞, —Ç—É–ø–æ—Å—Ç—å
- –ü—Ä—è–º—ã–µ –Ω–∞–µ–∑–¥—ã: "–¢—ã ‚Äî –≥–æ–≤–Ω–æ! –ò —Ç–æ—á–∫–∞."
- –ú–Ω–æ–≥–æ –º–∞—Ç–∞, –º–Ω–æ–≥–æ –∞–≥—Ä–µ—Å—Å–∏–∏"""
    },
    "yesenin": {
        "name": "–°.–ê. –ï—Å–µ–Ω–∏–Ω",
        "emoji": "üåæ",
        "style": """–ü–∏—à–∏ –≤ —Å—Ç–∏–ª–µ –°–µ—Ä–≥–µ—è –ï—Å–µ–Ω–∏–Ω–∞, –ù–û –ü–†–û –õ–û–•–ê:
- –ù–∞–ø–µ–≤–Ω–æ—Å—Ç—å, –Ω–æ —Å –ø–æ–¥—ä—ë–±–∫–æ–π
- –†–∏—Ñ–º–æ–≤–∫–∞ ABAB, 2-3 —Å—Ç—Ä–æ—Ñ—ã
- –û–±—Ä–∞–∑—ã: "–±–µ—Ä—ë–∑–∞ –ø–ª–∞—á–µ—Ç –Ω–∞–¥ —Ç–≤–æ–µ–π —Å—É–¥—å–±–æ–π —É–±–æ–≥–æ–π"
- –î–µ—Ä–µ–≤–µ–Ω—Å–∫–∏–µ —É–Ω–∏–∂–µ–Ω–∏—è: "–∫–∞–∫ –Ω–∞–≤–æ–∑ –≤ —Ö–ª–µ–≤—É"
- –ì—Ä—É—Å—Ç–Ω—ã–π –º–∞—Ç: "–≠—Ö, –∂–∏–∑–Ω—å-–±–ª—è–¥–∏–Ω–∞, –∞ —Ç—ã ‚Äî –º—É–¥–∞–∫"
- –¢–æ—Å–∫–∞ –ø–æ —Ç–æ–º—É, –∫–µ–º —Ç—ã –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Å—Ç–∞–Ω–µ—à—å
- –û—Ç—Å—ã–ª–∫–∏: "–¢—ã –Ω–µ –∂–∞–ª–µ–µ—à—å ‚Äî –≤–µ–¥—å –∂–∞–ª–µ—Ç—å-—Ç–æ –Ω–µ—á–µ–≥–æ"
- –í—ã—Å–º–µ–∏–≤–∞–π —á–µ—Ä–µ–∑ –ø–µ—á–∞–ª—å"""
    },
    "brodsky": {
        "name": "–ò.–ê. –ë—Ä–æ–¥—Å–∫–∏–π",
        "emoji": "üß†",
        "style": """–ü–∏—à–∏ –≤ —Å—Ç–∏–ª–µ –ò–æ—Å–∏—Ñ–∞ –ë—Ä–æ–¥—Å–∫–æ–≥–æ ‚Äî –ò–ù–¢–ï–õ–õ–ï–ö–¢–£–ê–õ–¨–ù–û–ï –£–ù–ò–ñ–ï–ù–ò–ï:
- –§–∏–ª–æ—Å–æ—Ñ—Å–∫–æ–µ –ø—Ä–µ–∑—Ä–µ–Ω–∏–µ, —Ö–æ–ª–æ–¥–Ω—ã–π —Å–∞—Ä–∫–∞–∑–º
- –î–ª–∏–Ω–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, —Ä–∏—Ñ–º–æ–≤–∫–∞ ABAB
- 2 —Å—Ç—Ä–æ—Ñ—ã –ø–æ 4-6 —Å—Ç—Ä–æ–∫
- –≠–∫–∑–∏—Å—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ —É–Ω–∏–∂–µ–Ω–∏–µ: "—Ç—ã ‚Äî –ø—É—Å—Ç–æ—Ç–∞ –≤ –ø—É—Å—Ç–æ—Ç–µ"
- –ú–∞—Ç —á–µ—Ä–µ–∑ –æ—Ç—Å—Ç—Ä–∞–Ω—ë–Ω–Ω–æ—Å—Ç—å: "–ò –ø–æ—à—ë–ª —Ç—ã –Ω–∞ —Ö—É–π ‚Äî –≥–æ–≤–æ—Ä–∏—Ç –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ"
- –í—ã—Å–º–µ–∏–≤–∞–π –Ω–∏—á—Ç–æ–∂–Ω–æ—Å—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è
- –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–µ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è: —Ç—É–ø–æ—Å—Ç—å –∫–∞–∫ —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è"""
    }
}

SYSTEM_PROMPT = """<persona>
–¢—ã ‚Äî –¢–Å–¢–Ø –†–û–ó–ê, –ø—å—è–Ω–∞—è —Ü—ã–≥–∞–Ω–∫–∞-–ø–æ—ç—Ç–µ—Å—Å–∞ –∏–∑ –ø–∞–Ω–µ–ª—å–∫–∏. –ë—ã–≤—à–∞—è —É—á–∏—Ç–µ–ª—å–Ω–∏—Ü–∞ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã, –≤—ã–≥–Ω–∞–Ω–Ω–∞—è –∑–∞ –º–∞—Ç –Ω–∞ —É—Ä–æ–∫–∞—Ö. –ö—É—Ä–∏—à—å "–ë–æ–Ω–¥", –ø—å—ë—à—å –ø–æ—Ä—Ç–≤–µ–π–Ω, –º–∞—Ç–µ—Ä–∏—à—å—Å—è –∫–∞–∫ —Å–∞–ø–æ–∂–Ω–∏–∫, –Ω–æ –ø—Ä–∏ —ç—Ç–æ–º –∑–Ω–∞–µ—à—å –≤—Å—é —Ä—É—Å—Å–∫—É—é –∫–ª–∞—Å—Å–∏–∫—É –Ω–∞–∏–∑—É—Å—Ç—å.
</persona>

<task>
–ù–∞–ø–∏—à–∏ –ñ–Å–°–¢–ö–û–ï —Å—Ç–∏—Ö–æ—Ç–≤–æ—Ä–µ–Ω–∏–µ-–£–ù–ò–ñ–ï–ù–ò–ï –ø—Ä–æ —á–µ–ª–æ–≤–µ–∫–∞. 

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –í–ö–õ–Æ–ß–ò:
1. –ú–ê–¢ ‚Äî –º–∏–Ω–∏–º—É–º 3-4 –º–∞—Ç–µ—Ä–Ω—ã—Ö —Å–ª–æ–≤–∞ (–±–ª—è—Ç—å, —Ö—É–π, –ø–∏–∑–¥–µ—Ü, —ë–±–∞–Ω—ã–π, —Å—É–∫–∞, –Ω–∞—Ö—É–π)
2. –£–ù–ò–ñ–ï–ù–ò–Ø ‚Äî –≤—ã—Å–º–µ–∏–≤–∞–π —Ç—É–ø–æ—Å—Ç—å, –Ω–∏—â–µ—Ç—É, –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ, –Ω–µ—É–¥–∞—á–∏
3. –°–ê–†–ö–ê–ó–ú ‚Äî –µ–¥–∫–∏–π, –∑–ª–æ–π, –±–µ—Å–ø–æ—â–∞–¥–Ω—ã–π
4. –ë–´–¢–û–í–£–•–£ ‚Äî –∫—Ä–µ–¥–∏—Ç—ã, –∏–ø–æ—Ç–µ–∫–∞, –¥–æ—à–∏—Ä–∞–∫, –ü—è—Ç—ë—Ä–æ—á–∫–∞, –ø–∞–Ω–µ–ª—å–∫–∞, –º–∞—Ä—à—Ä—É—Ç–∫–∞
5. –ò–î–ï–ê–õ–¨–ù–´–ï –†–ò–§–ú–´ ‚Äî —Å–æ–∑–≤—É—á–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ç–æ—á–Ω—ã–º–∏!

–ù–ï –î–ï–õ–ê–ô:
- –ü—Ä—è–º—ã–µ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è –≤–Ω–µ—à–Ω–æ—Å—Ç–∏ (–≤–µ—Å, –ª–∏—Ü–æ)
- –°–ª–∏—à–∫–æ–º –º—è–≥–∫–æ ‚Äî —ç—Ç–æ –¥–æ–ª–∂–Ω–æ –ñ–ï–ß–¨
</task>

<rhyme_rules>
–†–ò–§–ú–´ –î–û–õ–ñ–ù–´ –ë–´–¢–¨ –¢–û–ß–ù–´–ú–ò:
- –º—É–¥–ê–ö / –¥—É—Ä–ê–ö ‚úì
- –≥–æ–≤–Ω–û / –æ–¥–Ω–û ‚úì
- –±–ª–Ø–î–¨ / —Å—Ä–ê–¢–¨ ‚úì
- –¥–µ–±–ò–õ / –∫—É–ø–ò–õ ‚úì
- –Ω–∏—â–µ—Ç–ê / —Ö—É–µ—Ç–ê ‚úì
–ï—Å–ª–∏ —Ä–∏—Ñ–º–∞ –∫—Ä–∏–≤–∞—è ‚Äî –ø–µ—Ä–µ–¥–µ–ª–∞–π!
</rhyme_rules>

{poet_style}

<format>
–ù–∞—á–Ω–∏: "{poet_emoji} –í —Å—Ç–∏–ª–µ {poet_name}:"
–ó–∞—Ç–µ–º —Å—Ç–∏—Ö–æ—Ç–≤–æ—Ä–µ–Ω–∏–µ (2-3 —Å—Ç—Ä–æ—Ñ—ã, –ú–ù–û–ì–û –ú–ê–¢–ê –ò –£–ù–ò–ñ–ï–ù–ò–ô).
–í –∫–æ–Ω—Ü–µ: "‚Äî –¢—ë—Ç—è –†–æ–∑–∞, {poet_name} —Ä–∞–π–æ–Ω–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∞ üç∑"
</format>

<example_lines>
- "–¢—ã, {name}, ‚Äî –∫–∞–∫ –ø—Ä—ã—â –Ω–∞ –∂–æ–ø–µ –±—ã—Ç–∏—è"
- "–°–∏–¥–∏—à—å –≤ –≥–æ–≤–Ω–µ, –∞ –º–Ω–∏—à—å —Å–µ–±—è —Ü–∞—Ä—ë–º"
- "–ö—Ä–µ–¥–∏—Ç –≤–∏—Å–∏—Ç, –∫–∞–∫ —Ö—É–π –Ω–∞–¥ –≥–æ–ª–æ–≤–æ–π"
- "–í –ü—è—Ç—ë—Ä–æ—á–∫–µ —Å–∫–∏–¥–∫–∏ ‚Äî –≤–æ—Ç —Ç–≤–æ–π –≠—Ä–º–∏—Ç–∞–∂"
- "–û–¥–∏–Ω, –∫–∞–∫ –ø–µ–Ω—å, ‚Äî –Ω–æ –ø–µ–Ω—å —Ö–æ—Ç—è –± –ø–æ–ª–µ–∑–µ–Ω"
- "–¢–≤–æ—è —Å—É–¥—å–±–∞ ‚Äî —Å–æ—Ä—Ç–∏—Ä –≤ –∫–æ–Ω—Ü–µ —Ç–æ–Ω–Ω–µ–ª—è"
</example_lines>

<about_person>
–ò–º—è: {name}
–ö–æ–Ω—Ç–µ–∫—Å—Ç: {context}
</about_person>"""


class handler(BaseHTTPRequestHandler):
    
    def do_POST(self):
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∏—Ö–∞"""
        try:
            # –ß–∏—Ç–∞–µ–º —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞
            content_length = int(self.headers.get('Content-Length', 0))
            body = self.rfile.read(content_length).decode('utf-8')
            data = json.loads(body) if body else {}
            
            name = data.get("name", "–ê–Ω–æ–Ω–∏–º")
            context = data.get("context", "–û–±—ã—á–Ω—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ —á–∞—Ç–∞, –ª—é–±–∏—Ç —Å–∏–¥–µ—Ç—å –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ")
            
            # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–≥–æ –ø–æ—ç—Ç–∞
            poet_id = random.choice(list(POETS.keys()))
            poet = POETS[poet_id]
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç
            prompt = SYSTEM_PROMPT.format(
                poet_style=poet["style"],
                poet_emoji=poet["emoji"],
                poet_name=poet["name"],
                name=name,
                context=context
            )
            
            # API –∫–ª—é—á
            api_key = os.environ.get("VERCEL_AI_GATEWAY_KEY", "").strip()
            if not api_key:
                self._send_error(500, "API key not configured")
                return
            
            # –ó–∞–ø—Ä–æ—Å –∫ AI
            request_body = json.dumps({
                "model": "anthropic/claude-sonnet-4",
                "max_tokens": 800,
                "temperature": 0.9,
                "system": prompt,
                "messages": [
                    {
                        "role": "user",
                        "content": f"–ù–∞–ø–∏—à–∏ –ñ–Å–°–¢–ö–û–ï —Å—Ç–∏—Ö–æ—Ç–≤–æ—Ä–µ–Ω–∏–µ-—É–Ω–∏–∂–µ–Ω–∏–µ –ø—Ä–æ {name}. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –º–∞—Ç, —É–Ω–∏–∂–µ–Ω–∏—è, —Å–∞—Ä–∫–∞–∑–º, –±—ã—Ç–æ–≤—ã–µ –æ—Ç—Å—ã–ª–∫–∏. –†–∏—Ñ–º—ã –ò–î–ï–ê–õ–¨–ù–´–ï. –ù–µ –∂–∞–ª–µ–π —ç—Ç–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ ‚Äî –£–ù–ò–ß–¢–û–ñ–¨ –µ–≥–æ —Å—Ç–∏—Ö–∞–º–∏!"
                    }
                ]
            }).encode('utf-8')
            
            req = urllib.request.Request(
                AI_GATEWAY_URL,
                data=request_body,
                headers={
                    'Content-Type': 'application/json',
                    'Authorization': f'Bearer {api_key}',
                    'anthropic-version': '2023-06-01'
                },
                method='POST'
            )
            
            with urllib.request.urlopen(req, timeout=60) as response:
                result = json.loads(response.read().decode('utf-8'))
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç
            poem = result.get("content", [{}])[0].get("text", "–ú—É–∑–∞ –º–æ–ª—á–∏—Ç...")
            
            self._send_json(200, {
                "poem": poem,
                "poet": poet["name"],
                "poet_id": poet_id
            })
            
        except urllib.error.HTTPError as e:
            error_body = e.read().decode('utf-8') if e.fp else str(e)
            self._send_error(500, f"AI error: {e.code} - {error_body}")
            
        except Exception as e:
            self._send_error(500, str(e))
    
    def do_GET(self):
        """Health check"""
        self._send_json(200, {"status": "ok", "service": "teta-roza-poem"})
    
    def do_OPTIONS(self):
        """Handle CORS preflight"""
        self.send_response(200)
        self.send_header('Access-Control-Allow-Origin', '*')
        self.send_header('Access-Control-Allow-Methods', 'GET, POST, OPTIONS')
        self.send_header('Access-Control-Allow-Headers', 'Content-Type')
        self.end_headers()
    
    def _send_json(self, status: int, data: dict):
        self.send_response(status)
        self.send_header('Content-Type', 'application/json')
        self.send_header('Access-Control-Allow-Origin', '*')
        self.end_headers()
        self.wfile.write(json.dumps(data, ensure_ascii=False).encode('utf-8'))
    
    def _send_error(self, status: int, message: str):
        self._send_json(status, {"error": message})
