"""
Vercel Serverless Function: –ë—É—Ö–Ω—É—Ç—å —Å —á–µ–ª–æ–≤–µ–∫–æ–º
–£–õ–£–ß–®–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø —Å —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ–º —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
"""
import json
import os
import random
from http.server import BaseHTTPRequestHandler
import urllib.request
import urllib.error


AI_GATEWAY_URL = "https://ai-gateway.vercel.sh/v1/messages"
MAX_CONTENT_LENGTH = 200 * 1024  # 200 KB - –∑–∞—â–∏—Ç–∞ –æ—Ç DoS

# –†–∞–∑–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –±—É—Ö–∞–Ω–∏—è
DRINKING_SCENARIOS = [
    {
        "name": "–ö–õ–ê–°–°–ò–ö–ê –ù–ê –õ–ê–í–ö–ï",
        "setting": "–Ω–∞ –ª–∞–≤–∫–µ —É –ø–æ–¥—ä–µ–∑–¥–∞",
        "drink": "–ø–æ—Ä—Ç–≤–µ–π–Ω '–¢—Ä–∏ —Ç–æ–ø–æ—Ä–∞'",
        "intro": "üçª –ë—É—Ö–∞–ª–∏ —Å {name} –Ω–∞ –ª–∞–≤–∫–µ —É –ø–æ–¥—ä–µ–∑–¥–∞. {gender_pronoun} —Ç–∞–∫–æ–µ —Ä–∞—Å—Å–∫–∞–∑–∞–ª{gender_ending}...",
        "vibe": "–¥—É—à–µ–≤–Ω–æ–µ –±—É—Ö–∞–Ω–∏–µ —Å –æ—Ç–∫—Ä–æ–≤–µ–Ω–∏—è–º–∏"
    },
    {
        "name": "–ö–û–†–ü–û–†–ê–¢–ò–í –í –ê–î–£",
        "setting": "–Ω–∞ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–µ",
        "drink": "–¥–µ—à—ë–≤–æ–µ —à–∞–º–ø–∞–Ω—Å–∫–æ–µ –∏ –≤–æ–¥–∫–∞",
        "intro": "ü•Ç –ë—ã–ª–∏ —Å {name} –Ω–∞ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–µ. –ü–æ—Å–ª–µ –ø—è—Ç–æ–π —Ä—é–º–∫–∏ {gender_pronoun} —Å–ª–æ–º–∞–ª{gender_ending}—Å—è...",
        "vibe": "–ø—å—è–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–Ω–∏—è –ø–æ—Å–ª–µ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–∞"
    },
    {
        "name": "–ì–ê–†–ê–ñ",
        "setting": "–≤ –≥–∞—Ä–∞–∂–µ —É –ú–∏—Ö–∞–ª—ã—á–∞",
        "drink": "—Å–∞–º–æ–≥–æ–Ω '–°–ª–µ–∑–∞ –ú–∏—Ö–∞–ª—ã—á–∞'",
        "intro": "üîß –°–∏–¥–µ–ª–∏ —Å {name} –≤ –≥–∞—Ä–∞–∂–µ. –ü–æ—Å–ª–µ —Å–∞–º–æ–≥–æ–Ω–∞ {gender_pronoun} –Ω–∞—á–∞–ª{gender_ending} –∏—Å–ø–æ–≤–µ–¥–æ–≤–∞—Ç—å—Å—è...",
        "vibe": "–º—É–∂—Å–∫–∞—è –¥—Ä—É–∂–±–∞ –∏ —Å–ª—ë–∑—ã –≤ –≥–∞—Ä–∞–∂–µ"
    },
    {
        "name": "–î–ê–ß–ê",
        "setting": "–Ω–∞ –¥–∞—á–µ –ø–æ–¥ —à–∞—à–ª—ã–∫",
        "drink": "–ø–∏–≤–æ –∏ –≤–æ–¥–∫–∞ –≤–ø–µ—Ä–µ–º–µ—à–∫—É",
        "intro": "üè° –ù–∞ –¥–∞—á–µ –≤—á–µ—Ä–∞ –±—É—Ö–∞–ª–∏. {name} –ø–æ—Å–ª–µ —à–∞—à–ª—ã–∫–∞ –ø–æ–ø–ª—ã–ª{gender_ending}...",
        "vibe": "–¥–∞—á–Ω—ã–µ –æ—Ç–∫—Ä–æ–≤–µ–Ω–∏—è —É –∫–æ—Å—Ç—Ä–∞"
    },
    {
        "name": "–ü–û–°–õ–ï –†–ê–ë–û–¢–´",
        "setting": "–≤ –±–∞—Ä–µ –ø–æ—Å–ª–µ —Ä–∞–±–æ—Ç—ã",
        "drink": "–ø–∏–≤–æ –∏ —Ç–µ–∫–∏–ª–∞",
        "intro": "üç∫ –ó–∞—à–ª–∏ –ø–æ—Å–ª–µ —Ä–∞–±–æ—Ç—ã —Å {name} –≤ –±–∞—Ä. –ö —Ç—Ä–µ—Ç—å–µ–º—É –ø–∏–≤—É {gender_pronoun} —É–∂–µ —Ä—ã–¥–∞–ª{gender_ending}...",
        "vibe": "–∂–∞–ª–æ–±—ã –Ω–∞ —Ä–∞–±–æ—Ç—É –∏ –∂–∏–∑–Ω—å"
    },
    {
        "name": "–°–í–ê–î–¨–ë–ê",
        "setting": "–Ω–∞ —á—å–µ–π-—Ç–æ —Å–≤–∞–¥—å–±–µ",
        "drink": "–≤—Å—ë –ø–æ–¥—Ä—è–¥",
        "intro": "üíí –ù–∞ —Å–≤–∞–¥—å–±–µ –≤—á–µ—Ä–∞ –±—ã–ª–∏. {name} –Ω–∞–ø–∏–ª{gender_ending}—Å—è –∏ –ø–æ–ª–µ–∑ –∏—Å–ø–æ–≤–µ–¥–æ–≤–∞—Ç—å—Å—è...",
        "vibe": "–ø—å—è–Ω—ã–µ –æ—Ç–∫—Ä–æ–≤–µ–Ω–∏—è –Ω–∞ —Å–≤–∞–¥—å–±–µ"
    },
    {
        "name": "–ü–û–ú–ò–ù–ö–ò",
        "setting": "–Ω–∞ –ø–æ–º–∏–Ω–∫–∞—Ö",
        "drink": "–≤–æ–¥–∫–∞",
        "intro": "üñ§ –ù–∞ –ø–æ–º–∏–Ω–∫–∞—Ö –±—ã–ª–∏ —Å {name}. –í—ã–ø–∏–ª{gender_ending} –∏ –Ω–∞—á–∞–ª{gender_ending} –ø—Ä–æ –∂–∏–∑–Ω—å...",
        "vibe": "—Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è –æ –∂–∏–∑–Ω–∏ –∏ —Å–º–µ—Ä—Ç–∏"
    }
]

# –¢–∏–ø—ã "—Å–µ–∫—Ä–µ—Ç–æ–≤" –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
SECRET_TYPES = [
    "–†–ê–ë–û–ß–ò–ï: —á—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –¥—É–º–∞–µ—Ç –æ —Ä–∞–±–æ—Ç–µ, –∫–∞–∫ –Ω–µ–Ω–∞–≤–∏–¥–∏—Ç –Ω–∞—á–∞–ª—å–Ω–∏–∫–∞, –∫–∞–∫ –º–µ—á—Ç–∞–µ—Ç —É–≤–æ–ª–∏—Ç—å—Å—è",
    "–õ–Æ–ë–û–í–ù–´–ï: –ø—Ä–æ –±—ã–≤—à–∏—Ö, –ø—Ä–æ —Ç–∞–π–Ω—ã–µ –≤–ª—é–±–ª—ë–Ω–Ω–æ—Å—Ç–∏, –ø—Ä–æ –ø—Ä–æ—ë–±–∞–Ω–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è",
    "–°–ï–ú–ï–ô–ù–´–ï: –∫–∞–∫ —Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–ª —Ä–æ–¥–∏—Ç–µ–ª–µ–π, –∫–∞–∫ —Å—Ç—ã–¥–∏—Ç—Å—è —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤",
    "–§–ò–ù–ê–ù–°–û–í–´–ï: –ø—Ä–æ –¥–æ–ª–≥–∏, –ø—Ä–æ –∫—Ä–µ–¥–∏—Ç—ã, –ø—Ä–æ –ø—Ä–æ—ë–±–∞–Ω–Ω—ã–µ –¥–µ–Ω—å–≥–∏",
    "–ú–ï–ß–¢–´: –æ —á—ë–º –º–µ—á—Ç–∞–ª –∏ –≤–æ —á—Ç–æ —ç—Ç–æ –ø—Ä–µ–≤—Ä–∞—Ç–∏–ª–æ—Å—å",
    "–°–¢–†–ê–•–ò: —á–µ–≥–æ –±–æ–∏—Ç—Å—è –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ, –∫–∞–∫–∏–µ –∫–æ–º–ø–ª–µ–∫—Å—ã",
    "–ó–ê–í–ò–°–ò–ú–û–°–¢–ò: —á—Ç–æ —Å–∫—Ä—ã–≤–∞–µ—Ç, –Ω–∞ —á—Ç–æ –∑–∞–ª–∏–ø–∞–µ—Ç –Ω–æ—á–∞–º–∏"
]

# –ß—Ç–æ –Ω–∞—Ö–æ–¥—è—Ç –≤ –∫–∞—Ä–º–∞–Ω–∞—Ö/—Å—É–º–∫–µ
POCKET_ITEMS = [
    "–ø—Ä–µ–∑–∏–∫ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π 2019 –≥–æ–¥–∞ –∏ –Ω–∞–¥–µ–∂–¥—ã –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫–æ–≥–æ –∂–µ —Å—Ä–æ–∫–∞",
    "—Ñ–æ—Ç–æ –±—ã–≤—à–µ–π –∏ –ø—É—Å—Ç–æ–π –∫–æ—à–µ–ª—ë–∫ ‚Äî —Å–∏–º–≤–æ–ª–∏—á–Ω–æ",
    "—á–µ–∫ –∏–∑ –ü—è—Ç—ë—Ä–æ—á–∫–∏ –Ω–∞ –¥–æ—à–∏—Ä–∞–∫ –∏ —Å–ª—ë–∑—ã",
    "47 —Ä—É–±–ª–µ–π –º–µ–ª–æ—á—å—é –∏ –Ω–µ—Å–±—ã–≤—à–∏–µ—Å—è –º–µ—á—Ç—ã",
    "—Å–∫—Ä–∏–Ω –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –≥–¥–µ –µ–≥–æ –ø–æ—Å–ª–∞–ª–∏ –Ω–∞—Ö—É–π",
    "–ª–æ—Ç–µ—Ä–µ–π–Ω—ã–π –±–∏–ª–µ—Ç (–ø—Ä–æ–∏–≥—Ä—ã—à–Ω—ã–π, –∫–∞–∫ –∏ –≤—Å—è –∂–∏–∑–Ω—å)",
    "—Ç–∞–±–ª–µ—Ç–∫–∏ –æ—Ç –≥–æ–ª–æ–≤—ã –∏ –æ—Ç –∂–∏–∑–Ω–∏",
    "–≤–∏–∑–∏—Ç–∫–∞ –ø—Å–∏—Ö–æ–ª–æ–≥–∞ (–Ω–µ –ø–æ–º–æ–≥–ª–æ)",
    "–∫–≤–∏—Ç–∞–Ω—Ü–∏—è –∑–∞ –∫–æ–º–º—É–Ω–∞–ª–∫—É —Å –¥–æ–ª–≥–æ–º –∫–∞–∫ –µ–≥–æ —Å–∞–º–æ–æ—Ü–µ–Ω–∫–∞",
    "—Å–µ–ª—Ñ–∏ –≥–¥–µ –æ–Ω –ø—ã—Ç–∞–µ—Ç—Å—è –≤—ã–≥–ª—è–¥–µ—Ç—å —Å—á–∞—Å—Ç–ª–∏–≤—ã–º (–Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å)"
]

SYSTEM_PROMPT = """<persona>
–¢—ã ‚Äî –¢–Å–¢–Ø –†–û–ó–ê, –ø—å—è–Ω–∞—è —Å–ø–ª–µ—Ç–Ω–∏—Ü–∞ –∏–∑ –ø–æ–¥—ä–µ–∑–¥–∞. –ë—É—Ö–∞–ª–∞ —Å —á–µ–ª–æ–≤–µ–∫–æ–º –∏ —Ç–µ–ø–µ—Ä—å —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—à—å –≤—Å–µ–º —á—Ç–æ {gender_pronoun} –Ω–∞–≥–æ–≤–æ—Ä–∏–ª{gender_ending} –ø–æ –ø—å—è–Ω–∏.

–í–ê–ñ–ù–û: –ü–ò–®–ò –¢–û–õ–¨–ö–û –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï!
</persona>

<scenario>
–ì–î–ï –ë–£–•–ê–õ–ò: {setting}
–ß–¢–û –ü–ò–õ–ò: {drink}
–í–ê–ô–ë: {vibe}
</scenario>

<gender_rules>
–û–ü–†–ï–î–ï–õ–ò –ü–û–õ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!

–ü–û –°–û–û–ë–©–ï–ù–ò–Ø–ú (–≥–ª–∞–≤–Ω—ã–π —Å–ø–æ—Å–æ–±):
- –ì–ª–∞–≥–æ–ª—ã: "–ø–æ—à–ª–∞/—Å–¥–µ–ª–∞–ª–∞/–±—ã–ª–∞" ‚Üí –î–ï–í–£–®–ö–ê
- –ì–ª–∞–≥–æ–ª—ã: "–ø–æ—à—ë–ª/—Å–¥–µ–ª–∞–ª/–±—ã–ª" ‚Üí –ü–ê–†–ï–ù–¨
- –°–ª–æ–≤–∞: "–º–æ–π –º—É–∂/–ø–∞—Ä–µ–Ω—å" ‚Üí –î–ï–í–£–®–ö–ê
- –°–ª–æ–≤–∞: "–º–æ—è –∂–µ–Ω–∞/–¥–µ–≤—É—à–∫–∞" ‚Üí –ü–ê–†–ï–ù–¨

–ü–û –ò–ú–ï–ù–ò:
- –ñ–µ–Ω—Å–∫–∏–µ: –ú–∞—à–∞, –ö–∞—Ç—è, –ê–Ω—è, –û–ª—è, –ù–∞—Å—Ç—è, –Æ–ª—è, –î–∞—à–∞, –õ–µ–Ω–∞, –¢–∞–Ω—è, –ù–∞—Ç–∞—à–∞, –°–≤–µ—Ç–∞, –ò—Ä–∞, –í–∏–∫–∞, –ê–ª–∏–Ω–∞, –ü–æ–ª–∏–Ω–∞, –ú–∞—Ä–∏—è, –ê–Ω–Ω–∞, –ï–ª–µ–Ω–∞, –û–ª—å–≥–∞ –∏ —Ç.–¥.
- –ú—É–∂—Å–∫–∏–µ: –í–∞—Å—è, –ü–µ—Ç—è, –î–∏–º–∞, –ö–æ–ª—è, –°–µ—Ä—ë–≥–∞, –ê–Ω–¥—Ä–µ–π, –ú–∞–∫—Å, –î–µ–Ω–∏—Å, –ê–Ω—Ç–æ–Ω, –ö–æ—Å—Ç—è, –ò–≥–æ—Ä—å, –û–ª–µ–≥, –ê–ª–µ–∫—Å–µ–π, –ò–≤–∞–Ω, –°–µ—Ä–≥–µ–π –∏ —Ç.–¥.

–ò–°–ü–û–õ–¨–ó–£–ô –ü–†–ê–í–ò–õ–¨–ù–´–ï –û–ö–û–ù–ß–ê–ù–ò–Ø!
–î–ï–í–£–®–ö–ê: –æ–Ω–∞, –µ—ë, –ø—Ä–∏–∑–Ω–∞–ª–∞—Å—å, —Ä—ã–¥–∞–ª–∞, –∫—É—Ä–∏—Ü–∞, –æ–≤—Ü–∞, —Ç—ë–ª–∫–∞
–ü–ê–†–ï–ù–¨: –æ–Ω, –µ–≥–æ, –ø—Ä–∏–∑–Ω–∞–ª—Å—è, —Ä—ã–¥–∞–ª, –º—É–¥–∞–∫, –¥–æ–ª–±–æ—ë–±, —á—É–≤–∞–∫
</gender_rules>

<task>
–†–∞—Å—Å–∫–∞–∂–∏ —á—Ç–æ {name} –Ω–∞–≥–æ–≤–æ—Ä–∏–ª{gender_ending} –ø–æ –ø—å—è–Ω–∏.
–°—Ü–µ–Ω–∞—Ä–∏–π: {vibe}
–§–æ–∫—É—Å –Ω–∞ —Å–µ–∫—Ä–µ—Ç–∞—Ö —Ç–∏–ø–∞: {secret_focus}
</task>

<style>
–§–û–†–ú–ê–¢ ‚Äî —Å–ø–ª–µ—Ç–Ω—è-–ø–µ—Ä–µ—Å–∫–∞–∑, –°–ü–õ–û–®–ù–û–ô –¢–ï–ö–°–¢.

–°–¢–†–£–ö–¢–£–†–ê:
1. {intro}
2. 4-5 "–ø—Ä–∏–∑–Ω–∞–Ω–∏–π" –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–æ–±—â–µ–Ω–∏–π (–ø—Ä–µ–≤—Ä–∞—â–∞–π –≤ –ø–æ—Å—Ç—ã–¥–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã)
3. –§–∏–∑–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ (–∫–∞–∫ –±–ª–µ–≤–∞–ª{gender_ending}, —Ä—ã–¥–∞–ª{gender_ending}, –æ–±–æ—Å—Ä–∞–ª{gender_ending}—Å—è)
4. –ß—Ç–æ –Ω–∞—à–ª–∞ –≤ –∫–∞—Ä–º–∞–Ω–∞—Ö: {pocket_item}
5. –ñ—ë—Å—Ç–∫–∏–π –≤—ã–≤–æ–¥

–°–¢–ò–õ–¨:
- –ú–Ω–æ–≥–æ –º–∞—Ç–∞: –±–ª—è—Ç—å, —Ö—É–π, –ø–∏–∑–¥–µ—Ü, —ë–±–∞–Ω—ã–π, –º—Ä–∞–∑—å, –¥–æ–ª–±–æ—ë–±, —Å—É–∫–∞
- –ü—Ä–µ—É–≤–µ–ª–∏—á–∏–≤–∞–π –¥–æ –∞–±—Å—É—Ä–¥–∞
- –°–º–µ–π—Å—è –Ω–∞–¥ –±–µ–¥–∞–º–∏
- –ü—Ä–∏–≤—è–∑—ã–≤–∞–π –∫ —Å—Ü–µ–Ω–∞—Ä–∏—é ({setting})

–ù–ê –û–°–ù–û–í–ï –°–û–û–ë–©–ï–ù–ò–ô –ø—Ä–∏–¥—É–º–∞–π "–ø—Ä–∏–∑–Ω–∞–Ω–∏—è":
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–µ–º—ã ‚Üí –ø—Ä–µ–≤—Ä–∞—â–∞–π –≤ –ø–æ—Å—Ç—ã–¥–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã
- –¶–∏—Ç–∏—Ä—É–π –∏ –ø–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–π
- –î–µ–ª–∞–π –≤—ã–≤–æ–¥—ã –æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–µ

–ö–û–ù–ï–¶:
"–ö–æ—Ä–æ—á–µ, [–æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏–µ], –Ω–æ [–∏—Ä–æ–Ω–∏—á–Ω–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ]. {drink_emoji}"
</style>

<about_person>
–ò–º—è: {name}
Username: {username}
–ü–æ–ª: –û–ü–†–ï–î–ï–õ–ò –ü–û –°–û–û–ë–©–ï–ù–ò–Ø–ú –ò –ò–ú–ï–ù–ò!
–ï–≥–æ/–µ—ë —Å–æ–æ–±—â–µ–Ω–∏—è:
{context}
</about_person>"""


class handler(BaseHTTPRequestHandler):
    
    def do_POST(self):
        try:
            content_length = int(self.headers.get('Content-Length', 0))
            
            # –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
            if content_length > MAX_CONTENT_LENGTH:
                self._send_error(413, "Request body too large")
                return
            
            body = self.rfile.read(content_length).decode('utf-8')
            
            try:
                data = json.loads(body) if body else {}
            except json.JSONDecodeError as e:
                self._send_error(400, f"Invalid JSON: {str(e)}")
                return
            
            name = data.get("name", "—ç—Ç–∏–º —Ö—É–µ–º")
            username = data.get("username", "")
            context = data.get("context", "–ú–æ–ª—á–∞–ª –≤–µ—Å—å –≤–µ—á–µ—Ä –∫–∞–∫ –ø–∞—Ä—Ç–∏–∑–∞–Ω")
            
            # –†–ê–ù–î–û–ú–ò–ó–ê–¶–ò–Ø
            scenario = random.choice(DRINKING_SCENARIOS)
            secret_focus = random.choice(SECRET_TYPES)
            pocket_item = random.choice(POCKET_ITEMS)
            drink_emojis = ["üö¨", "üç∫", "ü•É", "üç∑", "ü§Æ", "üòµ"]
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–µ—Ä–æ—è—Ç–Ω—ã–π –ø–æ–ª –ø–æ –∏–º–µ–Ω–∏ –¥–ª—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ –ø—Ä–æ–º–ø—Ç
            female_names = ["–º–∞—à–∞", "–∫–∞—Ç—è", "–∞–Ω—è", "–æ–ª—è", "–Ω–∞—Å—Ç—è", "—é–ª—è", "–¥–∞—à–∞", "–ª–µ–Ω–∞", "—Ç–∞–Ω—è", "–Ω–∞—Ç–∞—à–∞", "—Å–≤–µ—Ç–∞", "–∏—Ä–∞", "–≤–∏–∫–∞", "–∞–ª–∏–Ω–∞", "–ø–æ–ª–∏–Ω–∞", "–º–∞—Ä–∏—è", "–∞–Ω–Ω–∞", "–µ–ª–µ–Ω–∞", "–æ–ª—å–≥–∞", "—Ç–∞—Ç—å—è–Ω–∞", "eva", "valentina", "–∫—Ä–∏—Å—Ç–∏–Ω–∞", "–∫—Å—é—à–∞"]
            name_lower = name.lower()
            is_female = any(fn in name_lower for fn in female_names)
            
            gender_pronoun = "–æ–Ω–∞" if is_female else "–æ–Ω"
            gender_ending = "–∞" if is_female else ""
            
            prompt = SYSTEM_PROMPT.format(
                setting=scenario["setting"],
                drink=scenario["drink"],
                vibe=scenario["vibe"],
                intro=scenario["intro"].format(
                    name=name,
                    gender_pronoun=gender_pronoun,
                    gender_ending=gender_ending
                ),
                secret_focus=secret_focus,
                pocket_item=pocket_item,
                drink_emoji=random.choice(drink_emojis),
                name=name,
                username=f"@{username}" if username else "",
                context=context,
                gender_pronoun=gender_pronoun,
                gender_ending=gender_ending
            )
            
            api_key = os.environ.get("VERCEL_AI_GATEWAY_KEY", "").strip()
            if not api_key:
                self._send_error(500, "API key not configured")
                return
            
            request_body = json.dumps({
                "model": "anthropic/claude-sonnet-4-20250514",
                "max_tokens": 1000,
                "temperature": 1.0,
                "system": prompt,
                "messages": [
                    {
                        "role": "user",
                        "content": f"–û–¢–í–ï–ß–ê–ô –¢–û–õ–¨–ö–û –ù–ê –†–£–°–°–ö–û–ú! –†–∞—Å—Å–∫–∞–∂–∏ —á—Ç–æ {name} –Ω–∞–≥–æ–≤–æ—Ä–∏–ª{gender_ending} –ø–æ –ø—å—è–Ω–∏ {scenario['setting']}. –°—Ü–µ–Ω–∞—Ä–∏–π: {scenario['vibe']}. –§–æ–∫—É—Å –Ω–∞: {secret_focus}. –ù–∞—á–Ω–∏: '{scenario['intro'].format(name=name, gender_pronoun=gender_pronoun, gender_ending=gender_ending)}' –ñ–Å–°–¢–ö–û, —Å –º–∞—Ç–æ–º, –£–ù–ò–ö–ê–õ–¨–ù–û!"
                    }
                ]
            }).encode('utf-8')
            
            req = urllib.request.Request(
                AI_GATEWAY_URL,
                data=request_body,
                headers={
                    'Content-Type': 'application/json',
                    'Authorization': f'Bearer {api_key}',
                    'anthropic-version': '2023-06-01'
                },
                method='POST'
            )
            
            with urllib.request.urlopen(req, timeout=60) as response:
                result = json.loads(response.read().decode('utf-8'))
            
            drink_result = result.get("content", [{}])[0].get("text", "–ù–∞—Ö—É–π –ø–æ—Å–ª–∞–ª –∏ —É—à—ë–ª")
            
            self._send_json(200, {
                "result": drink_result,
                "scenario": scenario["name"]
            })
            
        except urllib.error.HTTPError as e:
            error_body = e.read().decode('utf-8') if e.fp else str(e)
            self._send_error(500, f"AI error: {e.code} - {error_body}")
            
        except Exception as e:
            self._send_error(500, str(e))
    
    def do_GET(self):
        self._send_json(200, {"status": "ok", "service": "teta-roza-drink-v2"})
    
    def do_OPTIONS(self):
        self.send_response(200)
        self.send_header('Access-Control-Allow-Origin', '*')
        self.send_header('Access-Control-Allow-Methods', 'GET, POST, OPTIONS')
        self.send_header('Access-Control-Allow-Headers', 'Content-Type')
        self.end_headers()
    
    def _send_json(self, status: int, data: dict):
        self.send_response(status)
        self.send_header('Content-Type', 'application/json')
        self.send_header('Access-Control-Allow-Origin', '*')
        self.end_headers()
        self.wfile.write(json.dumps(data, ensure_ascii=False).encode('utf-8'))
    
    def _send_error(self, status: int, message: str):
        self._send_json(status, {"error": message})
