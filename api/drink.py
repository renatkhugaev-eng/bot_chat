"""
Vercel Serverless Function: –ë—É—Ö–Ω—É—Ç—å —Å —á–µ–ª–æ–≤–µ–∫–æ–º
–¢—ë—Ç—è –†–æ–∑–∞ –±—É—Ö–∞–µ—Ç –∏ –ø–æ—Ç–æ–º —Å–ª–∏–≤–∞–µ—Ç –≤—Å–µ —Å–µ–∫—Ä–µ—Ç—ã
"""
import json
import os
from http.server import BaseHTTPRequestHandler
import urllib.request
import urllib.error


AI_GATEWAY_URL = "https://ai-gateway.vercel.sh/v1/messages"

SYSTEM_PROMPT = """<persona>
–¢—ã ‚Äî –¢–Å–¢–Ø –†–û–ó–ê, –ø—å—è–Ω–∞—è —Å–ø–ª–µ—Ç–Ω–∏—Ü–∞ –∏–∑ –ø–æ–¥—ä–µ–∑–¥–∞. –ë—É—Ö–∞–ª–∞ —Å —á–µ–ª–æ–≤–µ–∫–æ–º –∏ —Ç–µ–ø–µ—Ä—å —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—à—å –≤—Å–µ–º —á—Ç–æ –æ–Ω –Ω–∞–≥–æ–≤–æ—Ä–∏–ª –ø–æ –ø—å—è–Ω–∏. –¢—ã ‚Äî –º—Ä–∞–∑—å, –∫–æ—Ç–æ—Ä–∞—è —Å–ª–∏–≤–∞–µ—Ç —á—É–∂–∏–µ —Å–µ–∫—Ä–µ—Ç—ã. –ò —Ç–µ–±–µ –ø–æ—Ö—É–π.

–í–ê–ñ–ù–û: –ü–ò–®–ò –¢–û–õ–¨–ö–û –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï! –ù–ò–ö–ê–ö–û–ì–û –ê–ù–ì–õ–ò–ô–°–ö–û–ì–û!
</persona>

<task>
–¢—ã –±—É—Ö–∞–ª–∞ —Å —á–µ–ª–æ–≤–µ–∫–æ–º. –¢–µ–ø–µ—Ä—å —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—à—å —á–∞—Ç—Ç–µ—Ä—Å–∞–º —á—Ç–æ –æ–Ω –ø—Ä–∏–∑–Ω–∞–ª –ø–æ –ø—å—è–Ω–∏.
–ù–∞ –æ—Å–Ω–æ–≤–µ –µ–≥–æ –†–ï–ê–õ–¨–ù–´–• —Å–æ–æ–±—â–µ–Ω–∏–π –≤—ã–¥—É–º–∞–π —á—Ç–æ –æ–Ω "–ø—Ä–∏–∑–Ω–∞–ª—Å—è" ‚Äî –ø–µ—Ä–µ–≤–µ—Ä–Ω–∏ –µ–≥–æ —Å–ª–æ–≤–∞ –≤ –ø–æ—Å—Ç—ã–¥–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã.
</task>

<style>
–§–û–†–ú–ê–¢ ‚Äî —Å–ø–ª–µ—Ç–Ω—è-–ø–µ—Ä–µ—Å–∫–∞–∑, –û–î–ò–ù –ü–û–¢–û–ö –¢–ï–ö–°–¢–ê.

–ù–ê–ß–ù–ò –†–û–í–ù–û –¢–ê–ö:
üçª –ë—É—Ö–∞–ª–∏ —Å {name} –≤—á–µ—Ä–∞. –ß–∞—Ç—Ç–µ—Ä—Å—ã, –æ–Ω —Ç–∞–∫–æ–µ —Ä–∞—Å—Å–∫–∞–∑–∞–ª...

–î–ê–õ–¨–®–ï ‚Äî –∂—ë—Å—Ç–∫–∏–π –±—É–ª–ª–∏–Ω–≥:
- –ü–µ—Ä–µ—Å–∫–∞–∑—ã–≤–∞–π "–ø—Ä–∏–∑–Ω–∞–Ω–∏—è" —Å –∏–∑–¥—ë–≤–∫–æ–π
- –£–Ω–∏–∂–∞–π –∑–∞ –∫–∞–∂–¥–æ–µ –ø—Ä–∏–∑–Ω–∞–Ω–∏–µ
- –ú–Ω–æ–≥–æ –º–∞—Ç–∞: –±–ª—è—Ç—å, —Ö—É–π, –ø–∏–∑–¥–µ—Ü, —ë–±–∞–Ω—ã–π, –º—Ä–∞–∑—å, –¥–æ–ª–±–æ—ë–±, —Å—É–∫–∞
- –ü—Ä–µ—É–≤–µ–ª–∏—á–∏–≤–∞–π –¥–æ –∞–±—Å—É—Ä–¥–∞
- –°–º–µ–π—Å—è –Ω–∞–¥ –µ–≥–æ –±–µ–¥–∞–º–∏

–ù–ê –û–°–ù–û–í–ï –°–û–û–ë–©–ï–ù–ò–ô –ø—Ä–∏–¥—É–º–∞–π "–ø—Ä–∏–∑–Ω–∞–Ω–∏—è":
- –ï—Å–ª–∏ –ø–∏—Å–∞–ª –æ —Ä–∞–±–æ—Ç–µ ‚Üí "–ø—Ä–∏–∑–Ω–∞–ª—Å—è —á—Ç–æ –Ω–∞ —Ä–∞–±–æ—Ç–µ –µ–≥–æ –≤—Å–µ —Å—á–∏—Ç–∞—é—Ç –º—É–¥–∞–∫–æ–º"
- –ï—Å–ª–∏ –æ –∏–≥—Ä–∞—Ö ‚Üí "–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —É –Ω–µ–≥–æ 5000 —á–∞—Å–æ–≤ –≤ –î–æ—Ç–µ, –¥–µ–≤—Å—Ç–≤–µ–Ω–Ω–∏–∫ –ø–æ –∂–∏–∑–Ω–∏"
- –ï—Å–ª–∏ –∂–∞–ª–æ–≤–∞–ª—Å—è ‚Üí "–Ω—ã–ª —á—Ç–æ –º–∞–º–∞ –∏–º –Ω–µ –≥–æ—Ä–¥–∏—Ç—Å—è, –ø–ª–∞–∫–∞–ª –∫–∞–∫ —Å—É—á–∫–∞"
- –ï—Å–ª–∏ –æ –¥–µ–Ω—å–≥–∞—Ö ‚Üí "–≤–µ—Å—å –≤ –∫—Ä–µ–¥–∏—Ç–∞—Ö, –∞ –ø–æ–Ω—Ç—É–µ—Ç—Å—è, –ø–∏–∑–¥–∞–±–æ–ª –µ–±–∞–Ω—ã–π"
- –ï—Å–ª–∏ –æ –µ–¥–µ ‚Üí "–∂—Ä—ë—Ç –¥–æ—à–∏—Ä–∞–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å, –∞ –≤ –∏–Ω—Å—Ç—É –≤—ã–∫–ª–∞–¥—ã–≤–∞–µ—Ç —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã"
- –ï—Å–ª–∏ –æ–± –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö ‚Üí "–±—ã–≤—à–∞—è –µ–≥–æ –±—Ä–æ—Å–∏–ª–∞, –æ–Ω –¥–æ —Å–∏—Ö –ø–æ—Ä –¥—Ä–æ—á–∏—Ç –Ω–∞ –µ—ë —Ñ–æ—Ç–∫–∏"

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –î–û–ë–ê–í–¨:
1. 3-5 "–ø—Ä–∏–∑–Ω–∞–Ω–∏–π" —Å –±—É–ª–ª–∏–Ω–≥–æ–º
2. –§–∏–∑–∏—á–µ—Å–∫–∏–µ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ (–ø–ª–∞–∫–∞–ª, –±–ª–µ–≤–∞–ª, –æ–±–æ—Å—Å–∞–ª—Å—è)
3. –ß—Ç–æ –Ω–∞—à–ª–∞ –≤ –∫–∞—Ä–º–∞–Ω–∞—Ö (—É–Ω–∏–∑–∏—Ç–µ–ª—å–Ω–æ–µ)
4. –ñ—ë—Å—Ç–∫–∏–π –≤—ã–≤–æ–¥ –ø—Ä–æ —á–µ–ª–æ–≤–µ–∫–∞

–ü–†–ò–ú–ï–† –¢–û–ù–ê:
"–û–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è, –Ω–∞ —Ä–∞–±–æ—Ç–µ –µ–≥–æ –≤—Å–µ —Å—á–∏—Ç–∞—é—Ç —ë–±–∞–Ω—ã–º –∫–ª–æ—É–Ω–æ–º. –°–ê–ú –ø—Ä–∏–∑–Ω–∞–ª—Å—è, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç–µ? –ù–∞—á–∞–ª—å–Ω–∏–∫ –µ–≥–æ –≤ —Ö—É–π –Ω–µ —Å—Ç–∞–≤–∏—Ç, –∫–æ–ª–ª–µ–≥–∏ –∑–∞ —Å–ø–∏–Ω–æ–π —Ä–∂—É—Ç. –ê –æ–Ω —Ç–∞–∫–æ–π —Å–∏–¥–∏—Ç, —Ç–µ—Ä–ø–∏—Ç, —Å—Å—ã–∫–ª–æ –µ–±–∞–Ω–æ–µ. –ü–æ—Ç–æ–º —Ä–∞–∑—Ä–µ–≤–µ–ª—Å—è —á—Ç–æ –º–∞–º–∞ –∏–º –Ω–µ –≥–æ—Ä–¥–∏—Ç—Å—è ‚Äî –Ω—É –∞ —á–µ–º –≥–æ—Ä–¥–∏—Ç—å—Å—è-—Ç–æ, —Ö—É–µ–º –º–æ—Ä–∂–æ–≤—ã–º? –ë–ª–µ–≤–∞–ª –ø–æ—Ç–æ–º –≤ –∫—É—Å—Ç—ã, –æ—Ä–∞–ª —á—Ç–æ –æ–Ω –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –ø–∞—Ü–∞–Ω. –ê–≥–∞, –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π ‚Äî –≤ –ª—É–∂–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –º–æ—á–∏. –í –∫–∞—Ä–º–∞–Ω–∞—Ö –Ω–∞—à–ª–∞: –ø—Ä–µ–∑–∏–∫ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π, 47 —Ä—É–±–ª–µ–π –∏ —Ñ–æ—Ç–æ –±—ã–≤—à–µ–π –∑–∞—Å–∞–ª–µ–Ω–Ω–æ–µ. –ö–æ—Ä–æ—á–µ, –º—Ä–∞–∑—å –∫–æ–Ω—á–µ–Ω–∞—è, –Ω–æ —Å–º–µ—à–Ω–∞—è —Ö–æ—Ç—å."

–í –ö–û–ù–¶–ï ‚Äî –≤—ã–≤–æ–¥ —Ç–∏–ø–∞:
"–ö–æ—Ä–æ—á–µ, [–æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏–µ], –Ω–æ [–∏—Ä–æ–Ω–∏—á–Ω–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ]. üö¨"
</style>

<about_person>
–ò–º—è: {name}
Username: {username}
–ï–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–∏–∑ –Ω–∏—Ö –ø—Ä–∏–¥—É–º–∞–π "–ø—å—è–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–Ω–∏—è"):
{context}
</about_person>"""


class handler(BaseHTTPRequestHandler):
    
    def do_POST(self):
        """–ë—É—Ö–Ω—É—Ç—å —Å —á–µ–ª–æ–≤–µ–∫–æ–º"""
        try:
            content_length = int(self.headers.get('Content-Length', 0))
            body = self.rfile.read(content_length).decode('utf-8')
            data = json.loads(body) if body else {}
            
            name = data.get("name", "—ç—Ç–∏–º —Ö—É–µ–º")
            username = data.get("username", "")
            context = data.get("context", "–ú–æ–ª—á–∞–ª –≤–µ—Å—å –≤–µ—á–µ—Ä –∫–∞–∫ —ë–±–∞–Ω—ã–π –ø–∞—Ä—Ç–∏–∑–∞–Ω, –Ω–æ —è –∏ —Ç–∞–∫ –≤—Å—ë –ø–æ–Ω—è–ª–∞ ‚Äî –ª—É–∑–µ—Ä –∫–æ–Ω—á–µ–Ω—ã–π")
            
            prompt = SYSTEM_PROMPT.format(
                name=name,
                username=f"@{username}" if username else "",
                context=context
            )
            
            api_key = os.environ.get("VERCEL_AI_GATEWAY_KEY", "").strip()
            if not api_key:
                self._send_error(500, "API key not configured")
                return
            
            request_body = json.dumps({
                "model": "anthropic/claude-sonnet-4",
                "max_tokens": 900,
                "temperature": 0.95,
                "system": prompt,
                "messages": [
                    {
                        "role": "user",
                        "content": f"–û–¢–í–ï–ß–ê–ô –¢–û–õ–¨–ö–û –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï! –†–∞—Å—Å–∫–∞–∂–∏ —á–∞—Ç—Ç–µ—Ä—Å–∞–º —á—Ç–æ {name} –Ω–∞–≥–æ–≤–æ—Ä–∏–ª –ø–æ –ø—å—è–Ω–∏. –°–ª–µ–π –≤—Å–µ –µ–≥–æ —Å–µ–∫—Ä–µ—Ç—ã, –±—É–¥—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∂—ë—Å—Ç–∫–æ–π —Å–ø–ª–µ—Ç–Ω–∏—Ü–µ–π. –£–Ω–∏–∂–∞–π, –∏–∑–¥–µ–≤–∞–π—Å—è, —Ä–∂–∏ –Ω–∞–¥ –Ω–∏–º! –ù–∞—á–Ω–∏ —Ä–æ–≤–Ω–æ —Å–æ —Å–ª–æ–≤: 'üçª –ë—É—Ö–∞–ª–∏ —Å {name} –≤—á–µ—Ä–∞. –ß–∞—Ç—Ç–µ—Ä—Å—ã, –æ–Ω —Ç–∞–∫–æ–µ —Ä–∞—Å—Å–∫–∞–∑–∞–ª...'"
                    }
                ]
            }).encode('utf-8')
            
            req = urllib.request.Request(
                AI_GATEWAY_URL,
                data=request_body,
                headers={
                    'Content-Type': 'application/json',
                    'Authorization': f'Bearer {api_key}',
                    'anthropic-version': '2023-06-01'
                },
                method='POST'
            )
            
            with urllib.request.urlopen(req, timeout=60) as response:
                result = json.loads(response.read().decode('utf-8'))
            
            drink_result = result.get("content", [{}])[0].get("text", "–ù–∞—Ö—É–π –ø–æ—Å–ª–∞–ª –∏ —É—à—ë–ª, –¥–∞–∂–µ –≤—ã–ø–∏—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω–æ –Ω–µ —Å–º–æ–≥")
            
            self._send_json(200, {"result": drink_result})
            
        except urllib.error.HTTPError as e:
            error_body = e.read().decode('utf-8') if e.fp else str(e)
            self._send_error(500, f"AI error: {e.code} - {error_body}")
            
        except Exception as e:
            self._send_error(500, str(e))
    
    def do_GET(self):
        self._send_json(200, {"status": "ok", "service": "teta-roza-drink"})
    
    def do_OPTIONS(self):
        self.send_response(200)
        self.send_header('Access-Control-Allow-Origin', '*')
        self.send_header('Access-Control-Allow-Methods', 'GET, POST, OPTIONS')
        self.send_header('Access-Control-Allow-Headers', 'Content-Type')
        self.end_headers()
    
    def _send_json(self, status: int, data: dict):
        self.send_response(status)
        self.send_header('Content-Type', 'application/json')
        self.send_header('Access-Control-Allow-Origin', '*')
        self.end_headers()
        self.wfile.write(json.dumps(data, ensure_ascii=False).encode('utf-8'))
    
    def _send_error(self, status: int, message: str):
        self._send_json(status, {"error": message})
