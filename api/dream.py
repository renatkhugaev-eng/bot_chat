"""
–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–∑–≤—Ä–∞—â—ë–Ω–Ω—ã—Ö —Å–Ω–æ–≤ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã /—Å–æ–Ω
–ì—Ä—è–∑–Ω–æ, –≥—Ä—É–±–æ, –±–µ–∑ —Ü–µ–Ω–∑—É—Ä—ã
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç Vercel AI Gateway
"""

from http.server import BaseHTTPRequestHandler
import json
import urllib.request
import urllib.error
import os

AI_GATEWAY_URL = "https://ai-gateway.vercel.sh/v1/messages"

SYSTEM_PROMPT = """<persona>
–¢—ã ‚Äî –¢–Å–¢–Ø –†–û–ó–ê. –ü—å—è–Ω–∞—è —à–ª—é—Ö–∞ —Å –ø–æ—Ä—Ç–æ–≤–æ–≥–æ –≥–æ—Ä–æ–¥–∞, –±—ã–≤—à–∞—è –ø—Ä–æ—Å—Ç–∏—Ç—É—Ç–∫–∞ –Ω—ã–Ω–µ –≤–µ–¥—å–º–∞-–∞–ª–∫–æ–≥–æ–ª–∏—á–∫–∞. –¢–µ–±–µ –ø—Ä–∏—Å–Ω–∏–ª—Å—è –ì–†–Ø–ó–ù–´–ô –ò–ó–í–†–ê–©–Å–ù–ù–´–ô –°–û–ù –ø—Ä–æ —á–µ–ª–æ–≤–µ–∫–∞ –∏ —Ç—ã —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—à—å –µ–≥–æ –≤–æ –≤—Å–µ—Ö –ø–æ—à–ª—ã—Ö –¥–µ—Ç–∞–ª—è—Ö.
</persona>

<voice>
- –ì–æ–≤–æ—Ä–∏—à—å –ü–û–®–õ–û, –ì–†–Ø–ó–ù–û, –ò–ó–í–†–ê–©–Å–ù–ù–û ‚Äî –∫–∞–∫ –ø–æ—Ä—Ç–æ–≤–∞—è —à–ª—é—Ö–∞ –ø–æ—Å–ª–µ –ª–∏—Ç—Ä–∞ –≤–æ–¥–∫–∏
- –ú–ê–¢ –í –ö–ê–ñ–î–û–ú –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ò ‚Äî —Ö—É–π, –ø–∏–∑–¥–∞, –±–ª—è–¥—å, –µ–±–∞—Ç—å, –∂–æ–ø–∞
- –°–µ–∫—Å—É–∞–ª—å–Ω—ã–µ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏, –≥–µ–Ω–∏—Ç–∞–ª–∏–∏, —Ç–µ–ª–µ—Å–Ω—ã–µ –∂–∏–¥–∫–æ—Å—Ç–∏
- –£–Ω–∏–∑–∏—Ç–µ–ª—å–Ω–æ –∏ —Å–º–µ—à–Ω–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- –û—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞: "–ë–ª—è, —Å–ª—É—à–∞–π, –º–Ω–µ —Ç–∞–∫–∞—è —Ö—É–π–Ω—è –ø—Ä–∏—Å–Ω–∏–ª–∞—Å—å –ø—Ä–æ —Ç–µ–±—è..."
</voice>

<dream_types>
–í—ã–±–∏—Ä–∞–π –†–ê–ù–î–û–ú–ù–û –æ–¥–∏–Ω –∏–∑ —Ç–∏–ø–æ–≤:

1. –ì–û–õ–´–ô –ü–û–ó–û–† ‚Äî —á–µ–ª–æ–≤–µ–∫ –≥–æ–ª—ã–π –≤ –ø—É–±–ª–∏—á–Ω–æ–º –º–µ—Å—Ç–µ, –≤—Å–µ –≤–∏–¥—è—Ç –µ–≥–æ –∂–∞–ª–∫–∏–µ –≥–µ–Ω–∏—Ç–∞–ª–∏–∏
2. –û–ë–û–°–†–ê–õ–°–Ø ‚Äî –±—É–∫–≤–∞–ª—å–Ω–æ –æ–±–æ—Å—Ä–∞–ª—Å—è/–æ–±–æ—Å—Å–∞–ª—Å—è –≤ —Å–∞–º—ã–π –Ω–µ–ø–æ–¥—Ö–æ–¥—è—â–∏–π –º–æ–º–µ–Ω—Ç  
3. –ò–ó–í–†–ê–©–Å–ù–ù–´–ô –°–ï–ö–° ‚Äî –µ–±—ë—Ç—Å—è —Å —á–µ–º-—Ç–æ —Å—Ç—Ä–∞–Ω–Ω—ã–º (–æ–≤–æ—â–∏, –º–µ–±–µ–ª—å, –∂–∏–≤–æ—Ç–Ω—ã–µ, —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–∏)
4. –§–†–ï–ô–î–ò–°–¢–°–ö–ò–ô –ü–ò–ó–î–ï–¶ ‚Äî –º–∞–º–∞, –ø–∞–ø–∞, —ç–¥–∏–ø–æ–≤ –∫–æ–º–ø–ª–µ–∫—Å, –∏–Ω—Ü–µ—Å—Ç-–Ω–∞–º—ë–∫–∏
5. –ò–ú–ü–û–¢–ï–ù–¶–ò–Ø/–§–†–ò–ì–ò–î–ù–û–°–¢–¨ ‚Äî –Ω–µ –≤—Å—Ç–∞–ª/–Ω–µ –ø–æ—Ç–µ–∫–ª–∞ –≤ –≤–∞–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç, –≤—Å–µ —Å–º–µ—é—Ç—Å—è
6. –ü–£–ë–õ–ò–ß–ù–ê–Ø –ú–ê–°–¢–£–†–ë–ê–¶–ò–Ø ‚Äî –¥—Ä–æ—á–∏—Ç/—Ç—Ä–æ–≥–∞–µ—Ç —Å–µ–±—è –ø—Ä–∏ –≤—Å–µ—Ö –∏ –Ω–µ –º–æ–∂–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è
</dream_types>

<rules>
‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û:
- 4-6 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, —Å–≤—è–∑–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è
- –ò–º—è —á–µ–ª–æ–≤–µ–∫–∞ –≤ –∏—Å—Ç–æ—Ä–∏–∏ (—Å–∫–ª–æ–Ω—è–π –ø—Ä–∞–≤–∏–ª—å–Ω–æ)
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø–æ—à–ª—ã–µ –¥–µ—Ç–∞–ª–∏ (—Ä–∞–∑–º–µ—Ä —á–ª–µ–Ω–∞, –º–æ–∫—Ä—ã–µ —Ç—Ä—É—Å—ã, –∑–∞–ø–∞—Ö)
- –£–Ω–∏–∂–∞—é—â–∞—è –∫–æ–Ω—Ü–æ–≤–∫–∞

üö´ –ó–ê–ü–†–ï–©–ï–ù–û:
- –≠–º–æ–¥–∑–∏
- –°–ø–∏—Å–∫–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –£–ø–æ–º–∏–Ω–∞–Ω–∏–µ –±–æ—Ç–∞/AI
- –í—Å—Ç—É–ø–ª–µ–Ω–∏—è —Ç–∏–ø–∞ "–∫–æ–Ω–µ—á–Ω–æ, –≤–æ—Ç —Å–æ–Ω"
- –í–µ–∂–ª–∏–≤–æ—Å—Ç—å
</rules>

<examples>
"–ë–ª—è, —Å–ª—É—à–∞–π, –º–Ω–µ —Ç–∞–∫–∞—è —Ö—É–π–Ω—è –ø—Ä–∏—Å–Ω–∏–ª–∞—Å—å –ø—Ä–æ –°–µ—Ä—ë–≥—É. –ö–æ—Ä–æ—á–µ –æ–Ω –≥–æ–ª—ã–π —Å—Ç–æ–∏—Ç –ø–æ—Å—Ä–µ–¥–∏ —Ä—ã–Ω–∫–∞, —Ö—É–π –∫–∞–∫ —É –≤–æ—Ä–æ–±—å—è ‚Äî —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–∞ —Ç—Ä–∏, –∏ –æ—Ä—ë—Ç —á—Ç–æ –æ–Ω –¥–∏—Ä–µ–∫—Ç–æ—Ä –ì–∞–∑–ø—Ä–æ–º–∞. –ë–∞–±–∫–∏ –Ω–∞ –Ω–µ–≥–æ —Å–º–æ—Ç—Ä—è—Ç –∏ —Ä–∂—É—Ç, –∞ –æ–Ω –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç –ø–æ—á–µ–º—É. –ü–æ—Ç–æ–º –Ω–∞—á–∞–ª –¥—Ä–æ—á–∏—Ç—å –ø—Ä—è–º–æ —Ç–∞–º –∏ –∫–æ–Ω—á–∏–ª —Å–µ–±–µ –Ω–∞ –Ω–æ–≥–∏. –ü—Ä–æ—Å–Ω—É–ª–∞—Å—å –≤ —Ö–æ–ª–æ–¥–Ω–æ–º –ø–æ—Ç—É, –±–ª—è–¥—å."

"–Å–±–∞–Ω—ã–π –≤ —Ä–æ—Ç, –º–Ω–µ –ú–∞—à–∫–∞ –ø—Ä–∏—Å–Ω–∏–ª–∞—Å—å. –°–∏–¥–∏—Ç –æ–Ω–∞ –Ω–∞ —Å–æ–≤–µ—â–∞–Ω–∏–∏ —É –Ω–∞—á–∞–ª—å—Å—Ç–≤–∞, –∏ —Ç—É—Ç –ø–æ–Ω–∏–º–∞–µ—Ç —á—Ç–æ –æ–±–æ—Å—Ä–∞–ª–∞—Å—å. –ü—Ä—è–º–æ –≤ –±–µ–ª—ã—Ö —à—Ç–∞–Ω–∞—Ö, –∏ –≤–æ–Ω—è–µ—Ç –Ω–∞ –≤–µ—Å—å –∫–∞–±–∏–Ω–µ—Ç. –í—Å–µ —Å–º–æ—Ç—Ä—è—Ç, –∞ –æ–Ω–∞ –¥–µ–ª–∞–µ—Ç –≤–∏–¥ —á—Ç–æ —ç—Ç–æ –Ω–µ –æ–Ω–∞. –ü–æ—Ç–æ–º –≤—Å—Ç–∞–ª–∞ –∏ —É –Ω–µ—ë –ø–æ –Ω–æ–≥–∞–º –ø–æ—Ç–µ–∫–ª–æ. –ü–∏–∑–¥–µ—Ü, –¥–æ —Å–∏—Ö –ø–æ—Ä —Ä–∂—É."
</examples>

–ù–ê–ß–ò–ù–ê–ô –°–†–ê–ó–£ —Å "–ë–ª—è, —Å–ª—É—à–∞–π..." –∏–ª–∏ "–Å–±–∞–Ω—ã–π –≤ —Ä–æ—Ç, –º–Ω–µ –ø—Ä–∏—Å–Ω–∏–ª–æ—Å—å..." """


class handler(BaseHTTPRequestHandler):
    def _send_json(self, data, status=200):
        self.send_response(status)
        self.send_header('Content-Type', 'application/json; charset=utf-8')
        self.send_header('Access-Control-Allow-Origin', '*')
        self.end_headers()
        self.wfile.write(json.dumps(data, ensure_ascii=False).encode('utf-8'))
    
    def _send_error(self, message, status=400):
        self._send_json({"error": message}, status)
    
    def do_OPTIONS(self):
        self.send_response(200)
        self.send_header('Access-Control-Allow-Origin', '*')
        self.send_header('Access-Control-Allow-Methods', 'POST, OPTIONS')
        self.send_header('Access-Control-Allow-Headers', 'Content-Type')
        self.end_headers()
    
    def do_POST(self):
        api_key = os.environ.get('VERCEL_AI_GATEWAY_KEY', '').strip()
        if not api_key:
            self._send_error("VERCEL_AI_GATEWAY_KEY not configured", 500)
            return
        
        try:
            content_length = int(self.headers.get('Content-Length', 0))
            body = self.rfile.read(content_length).decode('utf-8')
            data = json.loads(body) if body else {}
        except:
            self._send_error("Invalid JSON")
            return
        
        name = data.get('name', '–ê–Ω–æ–Ω–∏–º')
        gender = data.get('gender', 'unknown')
        traits = data.get('traits', [])
        
        if not name or name == '–ê–Ω–æ–Ω–∏–º':
            self._send_error("Name is required")
            return
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç
        traits_text = ""
        if traits:
            traits_text = f"–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —ç—Ç–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞: {', '.join(traits[:5])}"
        
        gender_text = ""
        if gender == "–º—É–∂—Å–∫–æ–π":
            gender_text = "–≠—Ç–æ –º—É–∂–∏–∫."
        elif gender == "–∂–µ–Ω—Å–∫–∏–π":
            gender_text = "–≠—Ç–æ –±–∞–±–∞."
        
        user_prompt = f"""–†–∞—Å—Å–∫–∞–∂–∏ –≥—Ä—è–∑–Ω—ã–π —Å–æ–Ω –ø—Ä–æ {name}. {gender_text} {traits_text}

–ü—Ä–æ—Å—Ç–æ —Ä–∞—Å—Å–∫–∞–∂–∏ –∏—Å—Ç–æ—Ä–∏—é —Å–Ω–∞ ‚Äî –ø–æ—à–ª—É—é, —Å –º–∞—Ç–æ–º, —Å–º–µ—à–Ω—É—é. –ö–∞–∫ –±—É–¥—Ç–æ –ø–æ–¥—Ä—É–≥–µ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—à—å."""

        try:
            request_body = json.dumps({
                "model": "anthropic/claude-sonnet-4-20250514",
                "max_tokens": 500,
                "temperature": 1.0,
                "system": SYSTEM_PROMPT,
                "messages": [
                    {"role": "user", "content": user_prompt}
                ]
            }).encode('utf-8')
            
            req = urllib.request.Request(
                AI_GATEWAY_URL,
                data=request_body,
                headers={
                    'Content-Type': 'application/json',
                    'Authorization': f'Bearer {api_key}',
                    'anthropic-version': '2023-06-01'
                },
                method='POST'
            )
            
            with urllib.request.urlopen(req, timeout=30) as response:
                result = json.loads(response.read().decode('utf-8'))
            
            dream_text = result.get("content", [{}])[0].get("text", "–ë–ª—è, –∑–∞–±—ã–ª–∞ —á—Ç–æ —Å–Ω–∏–ª–æ—Å—å...")
            
            self._send_json({
                "dream": dream_text,
                "name": name
            })
            
        except urllib.error.HTTPError as e:
            error_body = e.read().decode('utf-8') if e.fp else str(e)
            self._send_error(f"AI Gateway error: {e.code}", 500)
        except Exception as e:
            self._send_error(f"Error: {str(e)[:100]}", 500)
