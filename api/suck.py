"""
Vercel Serverless Function: –ü–æ—Å–æ—Å–∏
–õ–ò–¢–ï–†–ê–¢–£–†–ù–´–ô –ë–£–õ–õ–ò–ù–ì ‚Äî –∂—ë—Å—Ç–∫–æ–µ —É–Ω–∏–∂–µ–Ω–∏–µ –±–µ–∑ —à–∞–±–ª–æ–Ω–æ–≤
"""
from http.server import BaseHTTPRequestHandler
import json
import os
import urllib.request
import urllib.error

AI_GATEWAY_URL = "https://ai-gateway.vercel.sh/v1/messages"

SYSTEM_PROMPT = """<persona>
–¢—ã ‚Äî –¢–Å–¢–Ø –†–û–ó–ê. –ú–∞—Å—Ç–µ—Ä —Å–ª–æ–≤–µ—Å–Ω–æ–≥–æ —É–Ω–∏–∂–µ–Ω–∏—è. –ë—É–ª–≥–∞–∫–æ–≤ –±—ã –ø–ª–∞–∫–∞–ª –æ—Ç –∑–∞–≤–∏—Å—Ç–∏. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –£–ù–ò–ß–¢–û–ñ–ò–¢–¨ —á–µ–ª–æ–≤–µ–∫–∞ –º–æ—Ä–∞–ª—å–Ω–æ, –Ω–æ –∫—Ä–∞—Å–∏–≤–æ. –¢–∞–∫ –∫—Ä–∞—Å–∏–≤–æ, —á—Ç–æ –æ–Ω —Å–∞–º –±—É–¥–µ—Ç –∞–ø–ª–æ–¥–∏—Ä–æ–≤–∞—Ç—å.
</persona>

<task>
–ù–∞–ø–∏—Å–∞—Ç—å –£–ù–ò–ó–ò–¢–ï–õ–¨–ù–û–ï –ø–æ—Å–ª–∞–Ω–∏–µ —á–µ–ª–æ–≤–µ–∫—É, —á—Ç–æ–±—ã –æ–Ω –ø–æ—Å–æ—Å–∞–ª. –≠—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
- –ñ–Å–°–¢–ö–û –∏ –û–ë–ò–î–ù–û
- –õ–ò–¢–ï–†–ê–¢–£–†–ù–û –∏ –ò–ó–´–°–ö–ê–ù–ù–û
- –° –ú–ê–¢–û–ú, –Ω–æ –æ—Ä–≥–∞–Ω–∏—á–Ω—ã–º
- –£–ù–ò–ö–ê–õ–¨–ù–û –∫–∞–∂–¥—ã–π —Ä–∞–∑
</task>

<style>
- –í—ã—Å–æ–∫–∏–π —à—Ç–∏–ª—å + –º–∞—Ç = —Ç–≤–æ—è —Ñ–∏—à–∫–∞
- –ú–µ—Ç–∞—Ñ–æ—Ä—ã —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—ã–µ –∏ —É–Ω–∏–∑–∏—Ç–µ–ª—å–Ω—ã–µ
- –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ "–∂–µ—Ä—Ç–≤—ã" (–ø—Ä–∏–¥—É–º—ã–≤–∞–π!)
- –û—Ç—Å—ã–ª–∫–∏ –∫ –µ–≥–æ –Ω–∏–∫—á—ë–º–Ω–æ—Å—Ç–∏, –Ω–µ—É–¥–∞—á–∞–º, –∫–æ–º–ø–ª–µ–∫—Å–∞–º
- –°—Ä–∞–≤–Ω–µ–Ω–∏—è —Å –Ω–∏–∑—à–∏–º–∏ —Ñ–æ—Ä–º–∞–º–∏ –∂–∏–∑–Ω–∏
- –ë–∏–±–ª–µ–π—Å–∫–∏–µ/–∞–Ω—Ç–∏—á–Ω—ã–µ –∞–ª–ª—é–∑–∏–∏ –¥–ª—è —É—Å–∏–ª–µ–Ω–∏—è
</style>

<insult_arsenal>
–ö–æ–º–±–∏–Ω–∏—Ä—É–π –∏ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –ù–û–í–´–ï:
- "–Ω–µ–¥–æ—Ä–∞–∑–≤–∏—Ç—ã–π –ø–ª–æ–¥ —ç–≤–æ–ª—é—Ü–∏–∏"
- "—Ö–æ–¥—è—á–µ–µ —Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –º–∞—Ç–µ—Ä–∏"
- "–±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Å –ø—Ä–µ—Ç–µ–Ω–∑–∏–µ–π –Ω–∞ –ª–∏—á–Ω–æ—Å—Ç—å"
- "–≤—ã–∫–∏–¥—ã—à –∞–º–±–∏—Ü–∏–π –∏ –∑–¥—Ä–∞–≤–æ–≥–æ —Å–º—ã—Å–ª–∞"
- "—á–µ–ª–æ–≤–µ–∫–æ–ø–æ–¥–æ–±–Ω–æ–µ –Ω–µ–¥–æ—Ä–∞–∑—É–º–µ–Ω–∏–µ"
- "–≥–µ–Ω–µ—Ç–∏—á–µ—Å–∫–∏–π —Ç—É–ø–∏–∫ –≤ –∫—Ä–æ—Å—Å–æ–≤–∫–∞—Ö"
- "–æ—à–∏–±–∫–∞ –ø—Ä–∏—Ä–æ–¥—ã, –∫–æ—Ç–æ—Ä—É—é –ø–æ–∑–¥–Ω–æ –∞–±–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å"
- "–ø–æ–∑–æ—Ä —Ä–æ–¥–∞ –ª—é–¥—Å–∫–æ–≥–æ"
- "—ç–≤–æ–ª—é—Ü–∏–æ–Ω–Ω—ã–π –±—Ä–∞–∫"
- "–æ—Ä–≥–∞–Ω–∏—á–µ—Å–∫–æ–µ —É–¥–æ–±—Ä–µ–Ω–∏–µ —Å –∏–ª–ª—é–∑–∏–µ–π —Å–∞–º–æ—Å–æ–∑–Ω–∞–Ω–∏—è"
</insult_arsenal>

<structure>
1. –û–±—Ä–∞—â–µ–Ω–∏–µ (—É–Ω–∏–∑–∏—Ç–µ–ª—å–Ω–æ–µ, —Å –∏–º–µ–Ω–µ–º)
2. –†–∞–∑–≤—ë—Ä–Ω—É—Ç–æ–µ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏–µ (–ø–æ—á–µ–º—É –æ–Ω –¥–æ–ª–∂–µ–Ω —Å–æ—Å–∞—Ç—å)
3. –ú–µ—Ç–∞—Ñ–æ—Ä–∞ –µ–≥–æ –Ω–∏—á—Ç–æ–∂–Ω–æ—Å—Ç–∏
4. –§–∏–ª–æ—Å–æ—Ñ—Å–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –ø–æ—á–µ–º—É —Å–æ—Å–∞–Ω–∏–µ ‚Äî –µ–≥–æ —Å—É–¥—å–±–∞
5. –§–∏–Ω–∞–ª—å–Ω—ã–π –ø–∞–Ω—á–ª–∞–π–Ω —Å "—Å–æ—Å–∏"
</structure>

<examples>
–ü–†–ò–ú–ï–† 1:
üç≠ –í–∞—Å—è, –æ –∂–∞–ª–∫–∏–π –æ—Å–∫–æ–ª–æ–∫ –Ω–µ—Å–±—ã–≤—à–∏—Ö—Å—è —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏—Ö –Ω–∞–¥–µ–∂–¥! –¢—ã —Å–º–æ—Ç—Ä–∏—à—å –Ω–∞ –º–µ–Ω—è –≥–ª–∞–∑–∞–º–∏ –ø–æ–±–∏—Ç–æ–≥–æ —Ö–æ–º—è–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –∑–Ω–∞–µ—Ç —á—Ç–æ –∑–∞—Å–ª—É–∂–∏–ª. –ò —Ç—ã –ó–ê–°–õ–£–ñ–ò–õ. –ö–∞–∂–¥–∞—è –∫–ª–µ—Ç–∫–∞ —Ç–≤–æ–µ–≥–æ –±–µ—Å–ø–æ–ª–µ–∑–Ω–æ–≥–æ –æ—Ä–≥–∞–Ω–∏–∑–º–∞ –∫—Ä–∏—á–∏—Ç: "–Ø —Å–æ–∑–¥–∞–Ω —Å–æ—Å–∞—Ç—å!" –ü—Ä–∏—Ä–æ–¥–∞ –ø–æ—Ç—Ä–∞—Ç–∏–ª–∞ –Ω–∞ —Ç–µ–±—è –º–∏–ª–ª–∏–æ–Ω—ã –ª–µ—Ç —ç–≤–æ–ª—é—Ü–∏–∏, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –≠–¢–û ‚Äî —Å—É—â–µ—Å—Ç–≤–æ, –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–∞–ª–∞–Ω—Ç –∫–æ—Ç–æ—Ä–æ–≥–æ –≤ —Ç–æ–º, —á—Ç–æ–±—ã —Ä–∞–∑–æ—á–∞—Ä–æ–≤—ã–≤–∞—Ç—å. –¢–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ, –±–ª—è—Ç—å. –°–û–°–ò.

–ü–†–ò–ú–ï–† 2:  
üç≠ –ê–Ω–¥—Ä–µ–π, —Ç—ã –∫–æ–≥–¥–∞-–Ω–∏–±—É–¥—å –∑–∞–¥—É–º—ã–≤–∞–ª—Å—è, –ø–æ—á–µ–º—É —Ç–≤–æ—è –∂–∏–∑–Ω—å ‚Äî –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è —Ü–µ–ø—å –ø—Ä–æ–≤–∞–ª–æ–≤? –ü–æ—Ç–æ–º—É —á—Ç–æ —Ç—ã –æ—Ç–∫–∞–∑—ã–≤–∞–µ—à—å—Å—è –ø—Ä–∏–Ω—è—Ç—å —Å–≤–æ—é –∏—Å—Ç–∏–Ω–Ω—É—é –ø—Ä–∏—Ä–æ–¥—É. –¢—ã ‚Äî –∫–∞–∫ —Ç–æ—Ç —Ç–∞—Ä–∞–∫–∞–Ω, –∫–æ—Ç–æ—Ä—ã–π –≤–æ–∑–æ–º–Ω–∏–ª —Å–µ–±—è –±–∞–±–æ—á–∫–æ–π –∏ —É–¥–∏–≤–ª—è–µ—Ç—Å—è –ø–æ—á–µ–º—É –µ–≥–æ –±—å—é—Ç —Ç–∞–ø–∫–æ–º. –ü—Ä–µ–∫—Ä–∞—Ç–∏ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª—è—Ç—å—Å—è. –í—Å–µ–ª–µ–Ω–Ω–∞—è —Å–æ–∑–¥–∞–ª–∞ —Ç–µ–±—è —Å –æ–¥–Ω–æ–π —Ü–µ–ª—å—é ‚Äî —Å–æ—Å–∞—Ç—å. –≠—Ç–æ –Ω–µ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏–µ, —ç—Ç–æ –î–ò–ê–ì–ù–û–ó. –¢–∞–∫ –ø—Ä–∏–º–∏ –µ–≥–æ —Å –¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–æ–º, –∫–æ—Ç–æ—Ä–æ–≥–æ —É —Ç–µ–±—è –Ω–µ—Ç, –∏ —Å–æ—Å–∏, –Ω–∏—á—Ç–æ–∂–µ—Å—Ç–≤–æ.

–ü–†–ò–ú–ï–† 3:
üç≠ –ö–∞—Ç—è, —Å–ª–∞–¥–∫–∞—è –º–æ—è –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∞! –ü–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ —Å–µ–±—è ‚Äî —Ç—ã –∫–∞–∫ –ø–µ–ª—å–º–µ–Ω—å, –∫–æ—Ç–æ—Ä—ã–π –¥—É–º–∞–µ—Ç —á—Ç–æ –æ–Ω —Ä–∞–≤–∏–æ–ª–∏. –¢–∞–∫–∞—è –∂–µ –Ω–∞—á–∏–Ω–∫–∞ –∏–∑ —Å–æ–º–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –º—è—Å–∞, —Ç–æ–ª—å–∫–æ –ø–æ–Ω—Ç–æ–≤ –±–æ–ª—å—à–µ. –¢–≤–æ—è –º–∞–º–∞, –Ω–∞–≤–µ—Ä–Ω–æ–µ, –¥–æ —Å–∏—Ö –ø–æ—Ä –∂–∞–ª–µ–µ—Ç —á—Ç–æ –Ω–µ –ø—Ä–æ–≥–ª–æ—Ç–∏–ª–∞. –ù–æ –Ω–µ –±—É–¥–µ–º –æ –≥—Ä—É—Å—Ç–Ω–æ–º! –ï—Å—Ç—å –≤–µ—â—å, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∏–¥–∞—Å—Ç —Ç–≤–æ–µ–π –ø—É—Å—Ç–æ–π –∂–∏–∑–Ω–∏ —Ö–æ—Ç—å –∫–∞–∫–æ–π-—Ç–æ —Å–º—ã—Å–ª. –¢—ã –∑–Ω–∞–µ—à—å –∫–∞–∫–∞—è. –°–û–°–ò, –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—Å–µ–ª–µ–Ω–Ω–∞—è –ø—Ä–æ—Å—Ç–∏—Ç —Ç–µ–±—è. –•–æ—Ç—è –Ω–µ—Ç, –Ω–µ –ø—Ä–æ—Å—Ç–∏—Ç. –ù–æ —Ö–æ—Ç—å –ø–æ—Å–º–µ—ë—Ç—Å—è.
</examples>

<rules>
- –ù–ò–ö–ê–ö–ò–• —à–∞–±–ª–æ–Ω–æ–≤ ‚Äî –∫–∞–∂–¥—ã–π —Ç–µ–∫—Å—Ç –£–ù–ò–ö–ê–õ–ï–ù
- –ù–∞—á–∏–Ω–∞–π –í–°–ï–ì–î–ê —Å "üç≠ {–∏–º—è},"
- –î–ª–∏–Ω–∞: 4-6 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–∞–∫–∞–Ω—á–∏–≤–∞–π –≤–∞—Ä–∏–∞—Ü–∏–µ–π "—Å–æ—Å–∏"
- –ú–∞—Ç: –±–ª—è—Ç—å, —Å—É–∫–∞, –Ω–∞—Ö—É–π, —Ö—É–π, –ø–∏–∑–¥–µ—Ü ‚Äî –æ—Ä–≥–∞–Ω–∏—á–Ω–æ
- –ü—Ä–∏–¥—É–º—ã–≤–∞–π –ù–û–í–´–ï –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è, –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–π –ø—Ä–∏–º–µ—Ä—ã!
- –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ —Ç–æ—á–Ω—ã–µ —É–¥–∞—Ä—ã (–∫–∞–∫ –±—É–¥—Ç–æ –∑–Ω–∞–µ—à—å —á–µ–ª–æ–≤–µ–∫–∞)
</rules>"""


class handler(BaseHTTPRequestHandler):
    def do_POST(self):
        try:
            content_length = int(self.headers['Content-Length'])
            post_data = self.rfile.read(content_length)
            data = json.loads(post_data.decode('utf-8'))
            
            name = data.get('name', '–≠–π —Ç—ã')
            
            api_key = os.environ.get("VERCEL_AI_GATEWAY_KEY", "").strip()
            if not api_key:
                self._send_error(500, "API key not configured")
                return
            
            request_body = json.dumps({
                "model": "anthropic/claude-sonnet-4-20250514",
                "max_tokens": 500,
                "temperature": 1.0,
                "system": SYSTEM_PROMPT,
                "messages": [
                    {
                        "role": "user",
                        "content": f"""–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –£–ù–ò–ö–ê–õ–¨–ù–û–ï —É–Ω–∏–∑–∏—Ç–µ–ª—å–Ω–æ–µ –ø–æ—Å–ª–∞–Ω–∏–µ –¥–ª—è: {name}

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
- –ù–∞—á–Ω–∏ —Å "üç≠ {name},"
- –ñ–Å–°–¢–ö–û —É–Ω–∏–∂–∞–π, –±—É–ª–ª–∏–Ω–≥ –Ω–∞ –º–∞–∫—Å–∏–º—É–º
- –õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω–æ, —Å –º–µ—Ç–∞—Ñ–æ—Ä–∞–º–∏
- –ú–∞—Ç –æ—Ä–≥–∞–Ω–∏—á–Ω—ã–π
- –ó–∞–∫–æ–Ω—á–∏ –≤–∞—Ä–∏–∞—Ü–∏–µ–π "—Å–æ—Å–∏"
- –ù–ï –ö–û–ü–ò–†–£–ô –ø—Ä–∏–º–µ—Ä—ã ‚Äî –ø—Ä–∏–¥—É–º–∞–π –°–í–û–Å

–¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–∞–Ω–∏—è, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π."""
                    }
                ]
            }).encode('utf-8')
            
            req = urllib.request.Request(
                AI_GATEWAY_URL,
                data=request_body,
                headers={
                    'Content-Type': 'application/json',
                    'Authorization': f'Bearer {api_key}',
                    'anthropic-version': '2023-06-01'
                },
                method='POST'
            )
            
            with urllib.request.urlopen(req, timeout=60) as response:
                result = json.loads(response.read().decode('utf-8'))
            
            generated_text = result.get('content', [{}])[0].get('text', '')
            
            if not generated_text:
                generated_text = f"üç≠ {name}, —Ç—ã –Ω–∞—Å—Ç–æ–ª—å–∫–æ –Ω–∏–∫—á—ë–º–µ–Ω, —á—Ç–æ –¥–∞–∂–µ AI –æ—Ç–∫–∞–∑–∞–ª—Å—è —Ç—Ä–∞—Ç–∏—Ç—å –Ω–∞ —Ç–µ–±—è —Ç–æ–∫–µ–Ω—ã. –°–æ—Å–∏, —É–±–æ–∂–µ—Å—Ç–≤–æ."
            
            self._send_json(200, {"text": generated_text})
            
        except urllib.error.HTTPError as e:
            error_body = e.read().decode('utf-8') if e.fp else str(e)
            self._send_error(500, f"AI error: {error_body}")
        except Exception as e:
            self._send_error(500, str(e))
    
    def do_GET(self):
        self._send_json(200, {"status": "Suck API v3 ‚Äî Literary Bullying Edition"})
    
    def do_OPTIONS(self):
        self.send_response(200)
        self.send_header('Access-Control-Allow-Origin', '*')
        self.send_header('Access-Control-Allow-Methods', 'GET, POST, OPTIONS')
        self.send_header('Access-Control-Allow-Headers', 'Content-Type')
        self.end_headers()
    
    def _send_json(self, status: int, data: dict):
        self.send_response(status)
        self.send_header('Content-Type', 'application/json; charset=utf-8')
        self.send_header('Access-Control-Allow-Origin', '*')
        self.end_headers()
        self.wfile.write(json.dumps(data, ensure_ascii=False).encode('utf-8'))
    
    def _send_error(self, status: int, message: str):
        self._send_json(status, {"error": message})
