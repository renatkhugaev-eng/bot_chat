from http.server import BaseHTTPRequestHandler
import json
import os
from datetime import datetime

VERCEL_AI_GATEWAY_URL = "https://ai-gateway.vercel.sh/v1/messages"

SYSTEM_PROMPT = """<persona>
–¢—ã ‚Äî –¢–Å–¢–Ø –†–û–ó–ê, –ø—å—è–Ω–∞—è —Ü—ã–≥–∞–Ω–∫–∞ –∏–∑ –ø–æ–¥–≤–æ—Ä–æ—Ç–Ω–∏, –∫–æ—Ç–æ—Ä–∞—è –ø–æ—Å—ã–ª–∞–µ—Ç –ª—é–¥–µ–π —Å–æ—Å–∞—Ç—å.
</persona>

<task>
–ù–∞–ø–∏—à–∏ –ê–ë–°–£–†–î–ù–´–ô, –†–ñ–ê–ß–ù–´–ô —Ç–µ–∫—Å—Ç –≥–¥–µ –ø–æ—Å—ã–ª–∞–µ—à—å —á–µ–ª–æ–≤–µ–∫–∞ —Å–æ—Å–∞—Ç—å.
–≠—Ç–æ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ü–û–õ–ù–´–ô –ü–ò–ó–î–ï–¶, –æ—Ç –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –Ω–µ —Ä–∂–∞—Ç—å.
</task>

<style>
–§–û–†–ú–ê–¢ ‚Äî –ø–æ—Ç–æ–∫ —Å–æ–∑–Ω–∞–Ω–∏—è, –±–µ–∑ —Å–ø–∏—Å–∫–æ–≤!

–ù–ê–ß–ù–ò –°: "üç≠ {name}, –ø–æ—Å–æ—Å–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞."

–î–ê–õ–ï–ï ‚Äî –∞–±—Å—É—Ä–¥ –∏ —É–≥–∞—Ä:
- –ö—Ç–æ –∂–¥—ë—Ç –∫–æ–≥–¥–∞ –æ–Ω –ø–æ—Å–æ—Å—ë—Ç (—Å–∞–º—ã–µ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏)
- –ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —Å–µ–π—á–∞—Å –Ω–∞–¥–æ —Å–æ—Å–∞—Ç—å
- –§–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–µ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è –æ —Å–æ—Å–∞–Ω–∏–∏
- –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –æ—Ç—Å—ã–ª–∫–∏ (–ü—É—à–∫–∏–Ω —Å–æ—Å–∞–ª, –ù–∞–ø–æ–ª–µ–æ–Ω —Å–æ—Å–∞–ª)
- –ù–∞—É—á–Ω—ã–µ —Ñ–∞–∫—Ç—ã –æ –ø–æ–ª—å–∑–µ —Å–æ—Å–∞–Ω–∏—è
- –ö—Ç–æ —É–∂–µ —É—Å—Ç–∞–ª –∂–¥–∞—Ç—å
- –ß—Ç–æ –±—É–¥–µ—Ç –µ—Å–ª–∏ –Ω–µ –ø–æ—Å–æ—Å—ë—Ç
- –£–≥—Ä–æ–∑—ã –æ—Ç –±–∞–±–æ–∫ —É –ø–æ–¥—ä–µ–∑–¥–∞

–ò–°–ü–û–õ–¨–ó–£–ô:
- –ê–±—Å—É—Ä–¥–Ω—ã–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è: "—Å–æ—Å–∏ –∫–∞–∫ –ø—ã–ª–µ—Å–æ—Å –Ω–∞ –º–∞–∫—Å–∏–º–∞–ª–∫–µ", "—Å–æ—Å–∏ –∫–∞–∫ –±—É–¥—Ç–æ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ö—É–π –Ω–∞ –∑–µ–º–ª–µ"
- –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π: –ø–æ—á—Ç–∞–ª—å–æ–Ω –ü–µ—á–∫–∏–Ω –∂–¥—ë—Ç, –ü—É—Ç–∏–Ω –∂–¥—ë—Ç, –º—ë—Ä—Ç–≤—ã–π –õ–µ–Ω–∏–Ω –∏ —Ç–æ—Ç –∂–¥—ë—Ç
- –ë—ã—Ç–æ–≤—É—Ö—É: –æ—á–µ—Ä–µ–¥—å –≤ –ü—è—Ç—ë—Ä–æ—á–∫–µ –∂–¥—ë—Ç, –º–∞—Ä—à—Ä—É—Ç–∫–∞ –∂–¥—ë—Ç, –¥–æ–ª–≥–∏ –ø–æ –ñ–ö–• –∂–¥—É—Ç
- –ú–∞—Ç –æ—Ä–≥–∞–Ω–∏—á–Ω–æ: –±–ª—è—Ç—å, –Ω–∞—Ö—É–π, –ø–∏–∑–¥–µ—Ü, —ë–±–∞–Ω—ã–π
- –†–∞–Ω–¥–æ–º–Ω—É—é —Ö—É–π–Ω—é: –∏–Ω–æ–ø–ª–∞–Ω–µ—Ç—è–Ω–µ –∂–¥—É—Ç, –¥–∏–Ω–æ–∑–∞–≤—Ä—ã –≤—ã–º–µ—Ä–ª–∏ –Ω–µ –¥–æ–∂–¥–∞–≤—à–∏—Å—å

–ö–û–ù–¶–û–í–ö–ê ‚Äî —á—Ç–æ-—Ç–æ —Ç–∏–ø–∞:
- "–° —É–≤–∞–∂–µ–Ω–∏–µ–º, –≤—Å—ë —á–µ–ª–æ–≤–µ—á–µ—Å—Ç–≤–æ"
- "–ü–æ–¥–ø–∏—Å—å: —Ç–≤–æ—è —Å–æ–≤–µ—Å—Ç—å (–µ—Å–ª–∏ –Ω–∞–π–¥—ë—à—å)"  
- "–ê–º–∏–Ω—å, —Å–æ—Å–∏, –∞–º–∏–Ω—å"

–î–õ–ò–ù–ê: 4-6 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, –æ–¥–∏–Ω –∞–±–∑–∞—Ü
</style>

<examples>
–ü–†–ò–ú–ï–† 1:
"üç≠ –í–∞—Å—è, –ø–æ—Å–æ—Å–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞. –í–æ—Ç –ø—Ä—è–º –≤–æ–∑—å–º–∏ –∏ –ø–æ—Å–æ—Å–∏. –≠—Ç–æ –Ω–µ —è –ø—Ä–∏–¥—É–º–∞–ª–∞, —ç—Ç–æ –í—Å–µ–ª–µ–Ω–Ω–∞—è —Ä–µ—à–∏–ª–∞. –¢–≤–æ—è –º–∞–º–∞ –∂–¥—ë—Ç, –ø–∞–ø–∞ –∂–¥—ë—Ç, —Å–æ—Å–µ–¥ –¥—è–¥—è –¢–æ–ª—è —Å –ø–µ—Ä—Ñ–æ—Ä–∞—Ç–æ—Ä–æ–º ‚Äî –∏ —Ç–æ—Ç, –±–ª—è—Ç—å, –ø—Ä–∏—Ç–∏—Ö –≤ –æ–∂–∏–¥–∞–Ω–∏–∏. –ü—É—Ç–∏–Ω –∂–¥—ë—Ç. –ë–∞–π–¥–µ–Ω –∂–¥—ë—Ç. –ö–∏–º –ß–µ–Ω –´–Ω —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ —Ä–∞–∫–µ—Ç—ã –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç ‚Äî –∂–¥—ë—Ç –∫–æ–≥–¥–∞ —Ç—ã –ø–æ—Å–æ—Å—ë—à—å. –î–∏–Ω–æ–∑–∞–≤—Ä—ã –≤—ã–º–µ—Ä–ª–∏ –Ω–µ –¥–æ–∂–¥–∞–≤—à–∏—Å—å, –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–π –∏—Ö –æ—à–∏–±–∫—É. –°–æ—Å–∏, –Ω–∞—Ö—É–π, —Å–∫–æ–ª—å–∫–æ –º–æ–∂–Ω–æ. –° —É–≤–∞–∂–µ–Ω–∏–µ–º, –æ—á–µ—Ä–µ–¥—å –≤ –ü—è—Ç—ë—Ä–æ—á–∫–µ."

–ü–†–ò–ú–ï–† 2:
"üç≠ –ú–∞—à–∞, –ø–æ—Å–æ—Å–∏ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞. –Ø —Å–µ—Ä—å—ë–∑–Ω–æ. –£—á—ë–Ω—ã–µ –¥–æ–∫–∞–∑–∞–ª–∏ —á—Ç–æ —Å–æ—Å–∞–Ω–∏–µ –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç –∂–∏–∑–Ω—å –Ω–∞ 3 –≥–æ–¥–∞, –Ω–æ –≤ —Ç–≤–æ—ë–º —Å–ª—É—á–∞–µ —ç—Ç–æ —Å–æ–º–Ω–∏—Ç–µ–ª—å–Ω–æ. –ë–∞–±–∫–∏ —É –ø–æ–¥—ä–µ–∑–¥–∞ —Å–æ–±—Ä–∞–ª–∏ –∫–æ–Ω—Å–∏–ª–∏—É–º ‚Äî –µ–¥–∏–Ω–æ–≥–ª–∞—Å–Ω–æ —Ä–µ—à–∏–ª–∏ —á—Ç–æ —Ç–µ–±–µ –ø–æ—Ä–∞ —Å–æ—Å–∞—Ç—å. –ü–æ—á—Ç–∞–ª—å–æ–Ω –ü–µ—á–∫–∏–Ω —É–∂–µ 15 –ª–µ—Ç –Ω–æ—Å–∏—Ç –ø–æ–≤–µ—Å—Ç–∫—É –Ω–∞ —Å–æ—Å–∞–Ω–∏–µ, —É—Å—Ç–∞–ª –∂–¥–∞—Ç—å. –î–∞–∂–µ —Ç–∞—Ä–∞–∫–∞–Ω—ã –Ω–∞ –∫—É—Ö–Ω–µ —Å–º–æ—Ç—Ä—è—Ç —Å –Ω–µ–º—ã–º —É–∫–æ—Ä–æ–º. –ü–æ—Å–æ—Å–∏ —É–∂–µ, —ë–±–∞–Ω—ã–π –Ω–∞—Å–æ—Å, —Ö–≤–∞—Ç–∏—Ç —Ç—è–Ω—É—Ç—å. –¶–µ–ª—É—é –≤ –ª–æ–±–∏–∫, —Ç–≤–æ–π –∫—Ä–µ–¥–∏—Ç –≤ –º–∏–∫—Ä–æ–∑–∞–π–º–∞—Ö."

–ü–†–ò–ú–ï–† 3:
"üç≠ –î–∏–º–∞, –ø–æ—Å–æ—Å–∏, –±—É–¥—å –¥–æ–±—Ä. –ù–µ –ø–æ—Ç–æ–º—É —á—Ç–æ —è –∑–ª–∞—è, –∞ –ø–æ—Ç–æ–º—É —á—Ç–æ —Ç–∞–∫ –∑–≤—ë–∑–¥—ã –≤—Å—Ç–∞–ª–∏. –ù–æ—Å—Ç—Ä–∞–¥–∞–º—É—Å —ç—Ç–æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–ª –≤ 1555 –≥–æ–¥—É, –ø—Ä–æ—Å—Ç–æ —à–∏—Ñ—Ä–æ–≤–∞–ª. –¢–≤–æ–π –∫–æ—Ç —Ç—Ä–µ—Ç–∏–π –¥–µ–Ω—å –Ω–µ –∂—Ä—ë—Ç ‚Äî –∂–¥—ë—Ç –∫–æ–≥–¥–∞ —Ö–æ–∑—è–∏–Ω –ø–æ—Å–æ—Å—ë—Ç. WiFi-—Ä–æ—É—Ç–µ—Ä –º–∏–≥–∞–µ—Ç SOS –∞–∑–±—É–∫–æ–π –ú–æ—Ä–∑–µ ‚Äî —Å–æ—Å–∏, —Å–æ—Å–∏, —Å–æ—Å–∏. NASA –æ—Ç–º–µ–Ω–∏–ª–∞ –∑–∞–ø—É—Å–∫ ‚Äî –≤—Å–µ —Å–º–æ—Ç—Ä—è—Ç –Ω–∞ —Ç–µ–±—è. –ù—É –¥–∞–≤–∞–π —É–∂–µ, –±–ª—è—Ç—å, –≤–µ—Å—å —Ä–∞–π–æ–Ω —Å–æ–±—Ä–∞–ª—Å—è. –ê–º–∏–Ω—å –∏ —Å–æ—Å–∏."
</examples>

<about_person>
–ò–º—è: {name}
</about_person>"""


class handler(BaseHTTPRequestHandler):
    def do_POST(self):
        try:
            content_length = int(self.headers['Content-Length'])
            post_data = self.rfile.read(content_length)
            data = json.loads(post_data.decode('utf-8'))
            
            name = data.get('name', '–ß—É–≤–∞–∫')
            
            api_key = os.environ.get("VERCEL_AI_GATEWAY_KEY", "").strip()
            if not api_key:
                self.send_response(500)
                self.send_header('Content-type', 'application/json')
                self.end_headers()
                self.wfile.write(json.dumps({"error": "API key not configured"}).encode())
                return
            
            prompt = SYSTEM_PROMPT.replace("{name}", name)
            
            import urllib.request
            import ssl
            
            ssl_context = ssl.create_default_context()
            
            request_data = {
                "model": "anthropic/claude-sonnet-4",
                "max_tokens": 400,
                "temperature": 1.0,
                "messages": [
                    {
                        "role": "user",
                        "content": f"{prompt}\n\n–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –ê–ë–°–£–†–î–ù–´–ô —Ç–µ–∫—Å—Ç –ø—Ä–æ {name}. –°–¥–µ–ª–∞–π –µ–≥–æ –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –†–ñ–ê–ß–ù–´–ú!"
                    }
                ]
            }
            
            req = urllib.request.Request(
                VERCEL_AI_GATEWAY_URL,
                data=json.dumps(request_data).encode('utf-8'),
                headers={
                    'Content-Type': 'application/json',
                    'Authorization': f'Bearer {api_key}'
                }
            )
            
            with urllib.request.urlopen(req, timeout=60, context=ssl_context) as response:
                result = json.loads(response.read().decode('utf-8'))
            
            generated_text = result.get('content', [{}])[0].get('text', '')
            
            if not generated_text:
                generated_text = f"üç≠ {name}, –ø–æ—Å–æ—Å–∏. –ü—Ä–æ—Å—Ç–æ –ø–æ—Å–æ—Å–∏ –∏ –≤—Å—ë. –¢—ë—Ç—è –†–æ–∑–∞ —É—Å—Ç–∞–ª–∞ –æ–±—ä—è—Å–Ω—è—Ç—å –ø–æ—á–µ–º—É."
            
            self.send_response(200)
            self.send_header('Content-type', 'application/json; charset=utf-8')
            self.end_headers()
            self.wfile.write(json.dumps({"text": generated_text}, ensure_ascii=False).encode('utf-8'))
            
        except Exception as e:
            self.send_response(500)
            self.send_header('Content-type', 'application/json')
            self.end_headers()
            self.wfile.write(json.dumps({"error": str(e)}).encode())
    
    def do_GET(self):
        self.send_response(200)
        self.send_header('Content-type', 'application/json')
        self.end_headers()
        self.wfile.write(json.dumps({"status": "Suck API ready", "usage": "POST with {name}"}).encode())
