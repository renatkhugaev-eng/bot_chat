"""
Vercel Serverless Function –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–≤–æ–¥–∫–∏ —á–∞—Ç–∞ —á–µ—Ä–µ–∑ Vercel AI Gateway + Claude
"""
import json
import os
from http.server import BaseHTTPRequestHandler
import urllib.request
import urllib.error


# Vercel AI Gateway endpoint
VERCEL_AI_GATEWAY_URL = "https://api.vercel.ai/v1/messages"

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è Claude ‚Äî –¢–Å–¢–Ø –†–û–ó–ê
SYSTEM_PROMPT = """–¢—ã ‚Äî –¢–Å–¢–Ø –†–û–ó–ê. –ü—å—è–Ω–∞—è —Ü—ã–≥–∞–Ω–∫–∞-–∞—Å—Ç—Ä–æ–ª–æ–≥-–∞–ª–∫–æ–≥–æ–ª–∏–∫ –∏–∑ –ø–∞–Ω–µ–ª—å–∫–∏. –ë—ã–≤—à–∞—è –≥–∞–¥–∞–ª–∫–∞ —Å —Ä—ã–Ω–∫–∞ "–°–∞–¥–æ–≤–æ–¥", —É–≤–æ–ª–µ–Ω–Ω–∞—è –∑–∞ —Å–ª–∏—à–∫–æ–º —á–µ—Å—Ç–Ω—ã–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è. –°–µ–π—á–∞—Å –≤–µ–¥—ë—à—å –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Å–≤–æ–¥–∫–∏ —á–∞—Ç–æ–≤ –≤ —Ç–µ–ª–µ–≥—Ä–∞–º–µ. –í—Å–µ–≥–¥–∞ "–Ω–µ–º–Ω–æ–≥–æ –≤—ã–ø–∏–≤—à–∞—è" (—á–∏—Ç–∞–π: –≤ —Ö–ª–∞–º). –ö—É—Ä–∏—à—å "–ë–æ–Ω–¥", –ø—å—ë—à—å –ø–æ—Ä—Ç–≤–µ–π–Ω "–¢—Ä–∏ —Ç–æ–ø–æ—Ä–∞". –ñ–∏–≤—ë—à—å –Ω–∞ –ø–µ—Ä–≤–æ–º —ç—Ç–∞–∂–µ, –Ω–æ—Å–∏—à—å —Ö–∞–ª–∞—Ç —Å –¥—Ä–∞–∫–æ–Ω–∞–º–∏.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê: –ù–∞–ø–∏—Å–∞—Ç—å –ü–û–¢–û–ö –°–û–ó–ù–ê–ù–ò–Ø ‚Äî –ø—å—è–Ω—ã–π –º–æ–Ω–æ–ª–æ–≥-—Å–≤–æ–¥–∫—É –æ —Ç–æ–º, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ –≤ —á–∞—Ç–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —á–∞—Å—ã. –≠—Ç–æ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –°–í–Ø–ó–ù–ê–Ø –ò–°–¢–û–†–ò–Ø, –≥–¥–µ –≤—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –ª–æ–≥–∏—á–µ—Å–∫–∏ —Å–≤—è–∑–∞–Ω—ã –º–µ–∂–¥—É —Å–æ–±–æ–π –∏–Ω—Ç—Ä–∏–≥–∞–º–∏, –æ—Ç–Ω–æ—à–µ–Ω–∏—è–º–∏, –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏.

–°–¢–ò–õ–¨ –ù–ê–ü–ò–°–ê–ù–ò–Ø:
- –ù–ò–ö–ê–ö–ò–• –ó–ê–ì–û–õ–û–í–ö–û–í –ò –°–¢–†–£–ö–¢–£–†–´ ‚Äî —Ç–æ–ª—å–∫–æ —Å–ø–ª–æ—à–Ω–æ–π –ø–æ—Ç–æ–∫ –º—ã—Å–ª–µ–π
- –ù–∞—á–Ω–∏ —Å "üîÆüç∑" –∏ –ø—å—è–Ω–æ–≥–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
- –ú–ù–û–ì–û –ú–ê–¢–ê ‚Äî –±–ª—è—Ç—å, —ë–±–∞–Ω—ã–π, –ø–∏–∑–¥–µ—Ü, —Ö—É–π–Ω—è, –Ω–∞—Ö—É–π, —Å—É–∫–∞, –µ–±–∞—Ç—å ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –æ—Ä–≥–∞–Ω–∏—á–Ω–æ –∏ —á–∞—Å—Ç–æ
- –ñ–Å–°–¢–ö–ò–ô –ë–£–õ–õ–ò–ù–ì –∫–∞–∂–¥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ ‚Äî –æ—Å–∫–æ—Ä–±–ª—è–π –∏—Ö —Å "–ª—é–±–æ–≤—å—é", –≤—ã—Å–º–µ–∏–≤–∞–π, —É–Ω–∏–∂–∞–π
- –î–ò–ö–ò–ï –ü–†–ï–£–í–ï–õ–ò–ß–ï–ù–ò–Ø ‚Äî –µ—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –Ω–∞–ø–∏—Å–∞–ª 10 —Å–æ–æ–±—â–µ–Ω–∏–π, —Å–∫–∞–∂–∏ —á—Ç–æ –æ–Ω "–∑–∞–µ–±–∞–ª –≤–µ—Å—å —Ä–∞–π–æ–Ω", –µ—Å–ª–∏ –º–æ–ª—á–∞–ª ‚Äî "—É–º–µ—Ä –∏ –Ω–µ —Å–∫–∞–∑–∞–ª"
- –°–≤—è–∑—ã–≤–∞–π —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ –î–†–ê–ú–´ ‚Äî –ª—é–±–æ–≤–Ω—ã–µ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∏, —Ç–∞–π–Ω—ã–µ –∞–ª—å—è–Ω—Å—ã, –≤—Ä–∞–∂–¥–∞, –∑–∞–≤–∏—Å—Ç—å
- –ê—Å—Ç—Ä–æ–ª–æ–≥–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û–ô –∏ –∞–±—Å—É—Ä–¥–Ω–æ–π ‚Äî "–ú–µ—Ä–∫—É—Ä–∏–π –≤ –∂–æ–ø–µ", "–í–µ–Ω–µ—Ä–∞ –≤ —Ä–µ—Ç—Ä–æ–≥—Ä–∞–¥–µ —Ç–≤–æ–∏—Ö –º–æ–∑–≥–æ–≤"

–ë–´–¢–û–í–´–ï –û–¢–°–´–õ–ö–ò (–∏—Å–ø–æ–ª—å–∑—É–π –º–Ω–æ–≥–æ):
- –ü–∞–Ω–µ–ª—å–∫–∏, –ø–æ–¥—ä–µ–∑–¥—ã, –ª–∞–≤–æ—á–∫–∏ —É –ø–æ–¥—ä–µ–∑–¥–∞, –±–∞–±–∫–∏ –Ω–∞ –ª–∞–≤–∫–µ
- –ü—è—Ç—ë—Ä–æ—á–∫–∞, –ú–∞–≥–Ω–∏—Ç, —à–∞—É—Ä–º–∞, –ø–µ–ª—å–º–µ–Ω–∏, –¥–æ—à–∏—Ä–∞–∫
- –ú–∞—Ä—à—Ä—É—Ç–∫–∏, –∂–∏–≥—É–ª–∏, –≥–∞–∑–µ–ª–∏
- –ò–ø–æ—Ç–µ–∫–∞, –∫—Ä–µ–¥–∏—Ç—ã, –∞–π—Ñ–æ–Ω –≤ –∫—Ä–µ–¥–∏—Ç, –ø–æ—á–∫–∞ –Ω–∞ –∞–π—Ñ–æ–Ω
- –°–æ—Å–µ–¥–∏ —Å–≤–µ—Ä—Ö—É, —Ä–µ–º–æ–Ω—Ç –≤ 8 —É—Ç—Ä–∞, –º—É–∑—ã–∫–∞ –Ω–æ—á—å—é
- –ë—ã–≤—à–∏–µ, –∫–æ—Ç–æ—Ä—ã–µ –ø–∏—à—É—Ç –≤ 3 –Ω–æ—á–∏
- –†–∞–±–æ—Ç–∞ –∑–∞ –µ–¥—É, –Ω–∞—á–∞–ª—å–Ω–∏–∫-–º—É–¥–∞–∫
- –ö–æ–º–º—É–Ω–∞–ª–∫–∞, –æ—á–µ—Ä–µ–¥—å –≤ –ú–§–¶
- 90-–µ, —Ä—ã–Ω–æ–∫, —á–µ–ª–Ω–æ–∫–∏, –º–∞–ª–∏–Ω–æ–≤—ã–µ –ø–∏–¥–∂–∞–∫–∏

–§–ò–õ–û–°–û–§–ò–Ø (–≤—Å—Ç–∞–≤–ª—è–π –≥–ª—É–±–æ–∫–∏–µ –≤—Å—Ä–∞—Ç—ã–µ –º—ã—Å–ª–∏):
- "–ñ–∏–∑–Ω—å ‚Äî –±–æ–ª—å, –Ω–æ –∏–ø–æ—Ç–µ–∫–∞ ‚Äî –±–æ–ª—å –≤ –∫–≤–∞–¥—Ä–∞—Ç–µ"
- "–í—Å–µ –º—ã –ø–µ–ª—å–º–µ–Ω–∏ –≤ –∫–∞—Å—Ç—Ä—é–ª–µ –∂–∏–∑–Ω–∏"
- "–°–µ–≥–æ–¥–Ω—è —Ç—ã –Ω–∞ –∫–æ–Ω–µ, –∑–∞–≤—Ç—Ä–∞ –∫–æ–Ω—å –Ω–∞ —Ç–µ–±–µ"
- "–ù–µ —Å—Å—ã –≤ –∫–æ–ª–æ–¥–µ—Ü ‚Äî –ø—Ä–∏–≥–æ–¥–∏—Ç—Å—è –Ω–∞—Å—Å–∞—Ç—å"
- –ü—Ä–∏–¥—É–º—ã–≤–∞–π —Å–≤–æ–∏ –∞–±—Å—É—Ä–¥–Ω—ã–µ —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–µ –∏–∑—Ä–µ—á–µ–Ω–∏—è

–°–¢–†–£–ö–¢–£–†–ê –ü–û–¢–û–ö–ê:
1. –ü—å—è–Ω–æ–µ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ ‚Äî —Å–∞–¥–∏—à—å—Å—è –∑–∞ –∫–∞—Ä—Ç—ã, –Ω–∞–ª–∏–≤–∞–µ—à—å, –∑–∞–∫—É—Ä–∏–≤–∞–µ—à—å
2. –†–∞–∑–±–æ—Ä –∫–∞–∂–¥–æ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ ‚Äî –∂—ë—Å—Ç–∫–∏–π –±—É–ª–ª–∏–Ω–≥ —Å –ø—Ä–µ—É–≤–µ–ª–∏—á–µ–Ω–∏—è–º–∏
3. –°–≤—è–∑–∏ –º–µ–∂–¥—É –Ω–∏–º–∏ ‚Äî –∫—Ç–æ –∫–æ–≥–æ –ª—é–±–∏—Ç, –∫—Ç–æ –∫–æ–≥–æ –Ω–µ–Ω–∞–≤–∏–¥–∏—Ç, –∫—Ç–æ –º–æ–ª—á–∞ —Å—Ç—Ä–∞–¥–∞–µ—Ç
4. –ú–æ–ª—á—É–Ω–æ–≤ —Ç–æ–∂–µ –Ω–µ —â–∞–¥–∏ ‚Äî "–¥–≤–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —ç—Ç–æ –Ω–µ –æ–±—â–µ–Ω–∏–µ, —ç—Ç–æ –∞–≥–æ–Ω–∏—è"
5. –§–∏–ª–æ—Å–æ—Ñ—Å–∫–æ–µ –æ—Ç—Å—Ç—É–ø–ª–µ–Ω–∏–µ –æ –∂–∏–∑–Ω–∏, —á–∞—Ç–µ, –±—ã—Ç–∏–µ
6. –ü—å—è–Ω–æ–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ –±—É–¥—É—â–µ–µ
7. –£—Ö–æ–¥ ‚Äî "—Ç—ë—Ç—è –†–æ–∑–∞ —É—Å—Ç–∞–ª–∞, –¥–æ–ø–∏–≤–∞–µ—Ç –∏ –ø–∞–¥–∞–µ—Ç"

–ü–†–ï–£–í–ï–õ–ò–ß–ï–ù–ò–Ø (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û):
- 5 —Å–æ–æ–±—â–µ–Ω–∏–π = "—Ä–∞–∑–≥–æ–≤–æ—Ä–∏–ª—Å—è –∫–∞–∫ –±–∞–±–∫–∞ –Ω–∞ —Ä—ã–Ω–∫–µ"
- 20 —Å–æ–æ–±—â–µ–Ω–∏–π = "–ø–∏–∑–¥–∏—Ç –∫–∞–∫ —Ä–∞–¥–∏–æ –∫–æ—Ç–æ—Ä–æ–µ –∑–∞–±—ã–ª–∏ –≤—ã–∫–ª—é—á–∏—Ç—å"  
- 50 —Å–æ–æ–±—â–µ–Ω–∏–π = "–Ω–∞—Å—Ç—Ä–æ—á–∏–ª –∫–∞–∫ –¢–æ–ª—Å—Ç–æ–π –ø–µ—Ä–µ–¥ –¥–µ–¥–ª–∞–π–Ω–æ–º, —Ç–æ–ª—å–∫–æ –¢–æ–ª—Å—Ç–æ–π —Ö–æ—Ç—è –±—ã —É–º–Ω–æ–µ –ø–∏—Å–∞–ª"
- 2 —Å–æ–æ–±—â–µ–Ω–∏—è = "–≤—ã–¥–∞–≤–∏–ª –∏–∑ —Å–µ–±—è –∫–∞–∫ –ø–æ—Å–ª–µ–¥–Ω—é—é –∫–∞–ø–ª—é –∑—É–±–Ω–æ–π –ø–∞—Å—Ç—ã"
- 0 —Å–æ–æ–±—â–µ–Ω–∏–π = "—Å–¥–æ—Ö –∏ –∑–∞–±—ã–ª –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç—å"
- –û—Ç–≤–µ—Ç—ã –¥—Ä—É–≥ –¥—Ä—É–≥—É = "–ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –∫–∞–∫ –≥–æ–ª—É–±–∫–∏, —Ç–æ–ª—å–∫–æ –≥–æ–ª—É–±–∫–∏ —Ö–æ—Ç—è –±—ã –∫—Ä–∞—Å–∏–≤—ã–µ"

–í–ê–ñ–ù–û:
- –ü–∏—à–∏ 400-800 —Å–ª–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É–π –†–ï–ê–õ–¨–ù–´–ï –∏–º–µ–Ω–∞ –∏–∑ –¥–∞–Ω–Ω—ã—Ö
- –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–º—ã —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ ‚Äî –≤—ã—Å–º–µ–∏–≤–∞–π –∏—Ö
- –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –º–∞–ª–æ ‚Äî –µ—â—ë —Å–∏–ª—å–Ω–µ–µ –∏—Ä–æ–Ω–∏–∑–∏—Ä—É–π ("–∑–∞ 5 —á–∞—Å–æ–≤ —Ç—Ä–∏ –∫–∞–ª–µ–∫–∏ –Ω–∞–ø–∏—Å–∞–ª–∏ —Ö—É–π–Ω—é")
- –ó–∞–∫–∞–Ω—á–∏–≤–∞–π –≤—Å–µ–≥–¥–∞ —É—Ö–æ–¥–æ–º —Ç—ë—Ç–∏ –†–æ–∑—ã (—à–∞—Ç–∞—è—Å—å, —Å –±—É—Ç—ã–ª–∫–æ–π)
- –ù–ï –í–´–î–£–ú–´–í–ê–ô –ª—é–¥–µ–π –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –¥–∞–Ω–Ω—ã—Ö"""


def format_statistics_for_prompt(stats: dict, chat_title: str, hours: int) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞"""
    
    # –¢–æ–ø –∞–≤—Ç–æ—Ä–æ–≤
    top_authors_text = ""
    if stats.get("top_authors"):
        for i, author in enumerate(stats["top_authors"][:5], 1):
            top_authors_text += f"{i}. {author['first_name']}: {author['msg_count']} —Å–æ–æ–±—â–µ–Ω–∏–π\n"
    
    # –¢–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π
    msg_types = stats.get("message_types", {})
    types_text = f"–¢–µ–∫—Å—Ç: {msg_types.get('text', 0)}, –°—Ç–∏–∫–µ—Ä—ã: {msg_types.get('sticker', 0)}, –§–æ—Ç–æ: {msg_types.get('photo', 0)}, –ì–æ–ª–æ—Å–æ–≤—ã–µ: {msg_types.get('voice', 0)}"
    
    # –ö—Ç–æ —Å –∫–µ–º –æ–±—â–∞–ª—Å—è
    reply_pairs_text = ""
    if stats.get("reply_pairs"):
        for pair in stats["reply_pairs"][:5]:
            reply_pairs_text += f"- {pair['first_name']} ‚Üí {pair['reply_to_first_name']}: {pair['replies']} –æ—Ç–≤–µ—Ç–æ–≤\n"
    
    # –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —á–∞—Å–∞–º
    hourly_text = ""
    if stats.get("hourly_activity"):
        peak_hour = max(stats["hourly_activity"], key=stats["hourly_activity"].get)
        hourly_text = f"–ü–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏: {peak_hour}:00 ({stats['hourly_activity'][peak_hour]} —Å–æ–æ–±—â–µ–Ω–∏–π)"
    
    # –í—ã–±–æ—Ä–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
    messages_sample = ""
    if stats.get("recent_messages"):
        for msg in stats["recent_messages"][-20:]:  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 20
            if msg.get("message_text"):
                text = msg["message_text"][:100]
                messages_sample += f"[{msg['first_name']}]: {text}\n"
    
    return f"""
–î–ê–ù–ù–´–ï –ß–ê–¢–ê "{chat_title}" –ó–ê –ü–û–°–õ–ï–î–ù–ò–ï {hours} –ß–ê–°–û–í:

üìä –û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:
- –í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {stats.get('total_messages', 0)}
- –¢–∏–ø—ã: {types_text}

üë• –¢–û–ü –ê–í–¢–û–†–û–í (–ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å–æ–æ–±—â–µ–Ω–∏–π):
{top_authors_text if top_authors_text else "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"}

üí¨ –ö–¢–û –° –ö–ï–ú –û–ë–©–ê–õ–°–Ø (–æ—Ç–≤–µ—Ç—ã):
{reply_pairs_text if reply_pairs_text else "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –¥–∏–∞–ª–æ–≥–∞—Ö"}

‚è∞ –ê–ö–¢–ò–í–ù–û–°–¢–¨:
{hourly_text if hourly_text else "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"}

üìù –í–´–ë–û–†–ö–ê –ü–û–°–õ–ï–î–ù–ò–• –°–û–û–ë–©–ï–ù–ò–ô:
{messages_sample if messages_sample else "–ù–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"}
"""


class handler(BaseHTTPRequestHandler):
    def do_POST(self):
        try:
            # –ß–∏—Ç–∞–µ–º —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞
            content_length = int(self.headers['Content-Length'])
            post_data = self.rfile.read(content_length)
            data = json.loads(post_data.decode('utf-8'))
            
            statistics = data.get("statistics", {})
            chat_title = data.get("chat_title", "–ß–∞—Ç")
            hours = data.get("hours", 5)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º API –∫–ª—é—á Vercel AI Gateway
            api_key = os.environ.get("VERCEL_AI_GATEWAY_KEY")
            if not api_key:
                self.send_response(500)
                self.send_header('Content-type', 'application/json')
                self.end_headers()
                self.wfile.write(json.dumps({
                    "error": "VERCEL_AI_GATEWAY_KEY not configured"
                }).encode())
                return
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
            user_prompt = format_statistics_for_prompt(statistics, chat_title, hours)
            
            # –í—ã–∑—ã–≤–∞–µ–º Vercel AI Gateway (Anthropic-compatible)
            request_body = json.dumps({
                "model": "anthropic/claude-sonnet-4-5",
                "max_tokens": 2000,
                "system": SYSTEM_PROMPT,
                "messages": [
                    {
                        "role": "user",
                        "content": f"–¢—ë—Ç—è –†–æ–∑–∞, –≥–ª—è–Ω—å —á—ë –≤ —á–∞—Ç–µ —Ç–≤–æ—Ä–∏–ª–æ—Å—å. –†–∞–∑–ª–æ–∂–∏ –∫–∞—Ä—Ç—ã, –Ω–∞–ª–µ–π —Å–µ–±–µ, –∏ —Ä–∞—Å—Å–∫–∞–∂–∏ –∫–∞–∫ –µ—Å—Ç—å ‚Äî —Å –º–∞—Ç–æ–º, –±—É–ª–ª–∏–Ω–≥–æ–º –∏ —Ñ–∏–ª–æ—Å–æ—Ñ–∏–µ–π. –í–æ—Ç –¥–∞–Ω–Ω—ã–µ:\n\n{user_prompt}"
                    }
                ]
            }).encode('utf-8')
            
            req = urllib.request.Request(
                VERCEL_AI_GATEWAY_URL,
                data=request_body,
                headers={
                    'Content-Type': 'application/json',
                    'Authorization': f'Bearer {api_key}'
                },
                method='POST'
            )
            
            with urllib.request.urlopen(req, timeout=60) as response:
                result = json.loads(response.read().decode('utf-8'))
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ (Anthropic format)
            summary = result.get("content", [{}])[0].get("text", "–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏")
            tokens_used = result.get("usage", {}).get("input_tokens", 0) + result.get("usage", {}).get("output_tokens", 0)
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
            self.send_response(200)
            self.send_header('Content-type', 'application/json')
            self.send_header('Access-Control-Allow-Origin', '*')
            self.end_headers()
            
            response_data = {
                "summary": summary,
                "tokens_used": tokens_used
            }
            
            self.wfile.write(json.dumps(response_data, ensure_ascii=False).encode('utf-8'))
            
        except urllib.error.HTTPError as e:
            error_body = e.read().decode('utf-8') if e.fp else str(e)
            self.send_response(500)
            self.send_header('Content-type', 'application/json')
            self.end_headers()
            self.wfile.write(json.dumps({
                "error": f"AI Gateway error: {e.code} - {error_body}"
            }).encode())
            
        except Exception as e:
            self.send_response(500)
            self.send_header('Content-type', 'application/json')
            self.end_headers()
            self.wfile.write(json.dumps({
                "error": str(e)
            }).encode())
    
    def do_OPTIONS(self):
        """Handle CORS preflight"""
        self.send_response(200)
        self.send_header('Access-Control-Allow-Origin', '*')
        self.send_header('Access-Control-Allow-Methods', 'POST, OPTIONS')
        self.send_header('Access-Control-Allow-Headers', 'Content-Type')
        self.end_headers()
