"""
Vercel Serverless Function: –°–∂–µ—á—å —á–µ–ª–æ–≤–µ–∫–∞
–£–õ–£–ß–®–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø —Å —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ–º —Å—Ç–∏–ª–µ–π –∫—Ä–µ–º–∞—Ü–∏–∏
"""
import json
import os
import random
from http.server import BaseHTTPRequestHandler
import urllib.request
import urllib.error


AI_GATEWAY_URL = "https://ai-gateway.vercel.sh/v1/messages"

# –†–∞–∑–Ω—ã–µ —Å—Ç–∏–ª–∏ —Å–æ–∂–∂–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
CREMATION_STYLES = [
    {
        "name": "–ö–õ–ê–°–°–ò–ß–ï–°–ö–û–ï –°–û–ñ–ñ–ï–ù–ò–ï",
        "intro": "üî• –ü–æ–¥–æ–∂–≥–ª–∏ {name}.",
        "style": "–æ–ø–∏—Å—ã–≤–∞–π —á—Ç–æ –≥–æ—Ä–∏—Ç –ø–æ –æ—á–µ—Ä–µ–¥–∏, –∫–∞–∫ —Ä–µ–ø–æ—Ä—Ç–∞–∂ —Å –º–µ—Å—Ç–∞ —Å–æ–±—ã—Ç–∏–π",
        "ending": "üßπ –¢—ë—Ç—è –†–æ–∑–∞ —Å–ø–ª—é–Ω—É–ª–∞ –Ω–∞ –ø–µ–ø–µ–ª"
    },
    {
        "name": "–ò–ù–ö–í–ò–ó–ò–¶–ò–Ø",
        "intro": "‚õ™ –°–≤—è—Ç–∞—è –ò–Ω–∫–≤–∏–∑–∏—Ü–∏—è –¢—ë—Ç–∏ –†–æ–∑—ã –ø—Ä–∏–≥–æ–≤–æ—Ä–∏–ª–∞ {name} –∫ —Å–æ–∂–∂–µ–Ω–∏—é –∑–∞ –µ—Ä–µ—Å—å.",
        "style": "–∫–∞–∫ —Å—Ä–µ–¥–Ω–µ–≤–µ–∫–æ–≤—ã–π —Å—É–¥ —Å –æ–±–≤–∏–Ω–µ–Ω–∏—è–º–∏ –∏ –≥—Ä–µ—Ö–∞–º–∏",
        "ending": "‚úùÔ∏è –ê–º–∏–Ω—å, –Ω–∞—Ö—É–π"
    },
    {
        "name": "–ö–†–ï–ú–ê–¶–ò–Ø –í –ú–û–†–ì–ï",
        "intro": "üè• –í –º–æ—Ä–≥–µ –ø—Ä–∏ –≤—ã—Ç—Ä–µ–∑–≤–∏—Ç–µ–ª–µ —Å–µ–≥–æ–¥–Ω—è –∫—Ä–µ–º–∞—Ü–∏—è. –ù–∞ —Å—Ç–æ–ª–µ ‚Äî {name}.",
        "style": "–∫–∞–∫ –ø—Ä–æ—Ç–æ–∫–æ–ª –≤—Å–∫—Ä—ã—Ç–∏—è –∏ –∫—Ä–µ–º–∞—Ü–∏–∏ —Å –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–º–∏ —Ç–µ—Ä–º–∏–Ω–∞–º–∏ (–ø–µ—Ä–µ–≤—Ä–∞–Ω–Ω—ã–º–∏)",
        "ending": "üìã –£—Ä–Ω—É –≤—ã–¥–∞–¥–∏–º —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞–º. –ï—Å–ª–∏ –ø—Ä–∏–¥—É—Ç."
    },
    {
        "name": "–®–ê–®–õ–´–ö –ù–ê –†–ê–ô–û–ù–ï",
        "intro": "üçñ –ü–∞—Ü–∞–Ω—ã –Ω–∞ —Ä–∞–π–æ–Ω–µ —Ä–µ—à–∏–ª–∏ —Å–¥–µ–ª–∞—Ç—å —à–∞—à–ª—ã–∫ –∏–∑ {name}.",
        "style": "–∫–∞–∫ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ —à–∞—à–ª—ã–∫–∞ ‚Äî –º–∞—Ä–∏–Ω–∞–¥, –º–∞–Ω–≥–∞–ª, —É–≥–ª–∏",
        "ending": "ü•É –ó–∞ —É–ø–æ–∫–æ–π! *—á–æ–∫–∞–µ—Ç—Å—è —Å—Ç–∞–∫–∞–Ω–∞–º–∏*"
    },
    {
        "name": "–§–ê–ô–ï–†–®–û–£",
        "intro": "üé™ –î–∞–º—ã –∏ –≥–æ—Å–ø–æ–¥–∞! –°–µ–≥–æ–¥–Ω—è –Ω–∞ –∞—Ä–µ–Ω–µ ‚Äî –≥–æ—Ä—è—â–∏–π {name}!",
        "style": "–∫–∞–∫ —Ü–∏—Ä–∫–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ –∑—Ä–∏—Ç–µ–ª–µ–π",
        "ending": "üëè –ê–ø–ª–æ–¥–∏—Å–º–µ–Ω—Ç—ã! –°–ª–µ–¥—É—é—â–∏–π –Ω–æ–º–µ—Ä ‚Äî –∫–ª–æ—É–Ω—ã!"
    },
    {
        "name": "–í–ï–î–¨–ú–ê–ö",
        "intro": "üó°Ô∏è –í–µ–¥—å–º–∞–∫ –†–æ–∑–∞ –ø–æ–ª—É—á–∏–ª–∞ –∑–∞–∫–∞–∑ –Ω–∞ {name}. –¢–≤–∞—Ä–∏ —Å–∞–º–∏ —Å–µ–±—è –Ω–µ —Å–æ–∂–≥—É—Ç.",
        "style": "–∫–∞–∫ –≤ —Ñ—ç–Ω—Ç–µ–∑–∏ ‚Äî –æ–ø–∏—Å—ã–≤–∞–π –∫–∞–∫ –º–æ–Ω—Å—Ç—Ä–∞ —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏",
        "ending": "üí∞ 50 –∫—Ä–æ–Ω. –°–ª–µ–¥—É—é—â–∏–π!"
    },
    {
        "name": "–ë–ê–ù–Ø",
        "intro": "üßñ –í –±–∞–Ω–µ –Ω–∞ —Ä–∞–π–æ–Ω–µ –ø–µ—Ä–µ—Å—Ç–∞—Ä–∞–ª–∏—Å—å —Å –ø–∞—Ä–æ–º. {name} –±—É–∫–≤–∞–ª—å–Ω–æ —Å–≤–∞—Ä–∏–ª—Å—è.",
        "style": "–∫–∞–∫ –≤ –±–∞–Ω–µ ‚Äî –æ–ø–∏—Å—ã–≤–∞–π —á—Ç–æ –æ—Ç–ø–∞—Ä–∏–≤–∞–µ—Ç—Å—è, —á—Ç–æ —Å–ª–µ–∑–∞–µ—Ç",
        "ending": "üç∫ –ü–∏–≤–∞—Å–∏–∫ –ø–æ—Å–ª–µ –±–∞–Ω—å–∫–∏. –ñ–∞–ª—å, {name} —É–∂–µ –Ω–µ –ø–æ–ø—å—ë—Ç."
    }
]

# –ß—Ç–æ –º–æ–∂–µ—Ç –≥–æ—Ä–µ—Ç—å ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
BURNING_ITEMS = [
    "–ß–°–í ‚Äî –≤—Å–µ–≥–¥–∞ –≥–æ—Ä–∏—Ç —è—Ä—á–µ –≤—Å–µ–≥–æ",
    "–ú–æ–∑–≥–∏ ‚Äî –µ—Å–ª–∏ –µ—Å—Ç—å —á—Ç–æ –≥–æ—Ä–µ—Ç—å",
    "–°–µ—Ä–¥—Ü–µ ‚Äî –ø—É—Å—Ç–æ–µ –∏–ª–∏ –ø–æ–ª–Ω–æ–µ –¥–µ—Ä—å–º–∞",
    "–î–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–æ ‚Äî –º–∏–∫—Ä–æ—Å–∫–æ–ø–∏—á–µ—Å–∫–æ–µ",
    "–°–æ–≤–µ—Å—Ç—å ‚Äî –¥–∞–≤–Ω–æ –ø—Ä–æ—ë–±–∞–Ω–∞",
    "–ê–º–±–∏—Ü–∏–∏ ‚Äî –¥—ã–º —á—ë—Ä–Ω—ã–π",
    "–¢–∞–ª–∞–Ω—Ç ‚Äî –æ—Ç—Å—ã—Ä–µ–ª",
    "–•–∞—Ä–∏–∑–º–∞ ‚Äî –ø—à–∏–∫–Ω—É–ª–∞",
    "–Æ–º–æ—Ä ‚Äî –≤–æ–Ω—è–µ—Ç –ø–∞–ª—ë–Ω—ã–º",
    "–ú–æ—Ç–∏–≤–∞—Ü–∏—è ‚Äî –Ω–µ –∑–∞–≥–æ—Ä–µ–ª–∞—Å—å",
    "–°–∞–º–æ–æ—Ü–µ–Ω–∫–∞ ‚Äî –ø–æ–ª—ã—Ö–∞–µ—Ç",
    "–ß—É–≤—Å—Ç–≤–æ —Å—Ç–∏–ª—è ‚Äî —Ç–ª–µ–µ—Ç –µ–ª–µ-–µ–ª–µ",
    "–ß—É–≤—Å—Ç–≤–æ —é–º–æ—Ä–∞ ‚Äî –∫–∏—Å–ª–æ–µ, –Ω–µ –≥–æ—Ä–∏—Ç",
    "–õ–∏–±–∏–¥–æ ‚Äî –∏—Å–∫—Ä–∏—Ç, –Ω–æ –Ω–µ –≥–æ—Ä–∏—Ç",
    "–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è ‚Äî –≥–æ—Ä–∏—Ç —Å–∏–Ω–∏–º –ø–ª–∞–º–µ–Ω–µ–º",
    "–†–µ–ø—É—Ç–∞—Ü–∏—è ‚Äî –æ–≥–Ω—è –Ω–µ—Ç, —Ç–æ–ª—å–∫–æ –¥—ã–º",
    "–î–µ—Ç—Å–∫–∏–µ –º–µ—á—Ç—ã ‚Äî –¥–∞–≤–Ω–æ –ø–µ–ø–µ–ª",
    "–ü–ª–∞–Ω—ã –Ω–∞ –∂–∏–∑–Ω—å ‚Äî –±—É–º–∞–∂–Ω—ã–µ, —Å–≥–æ—Ä–µ–ª–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ"
]

# –ß—Ç–æ –æ—Å—Ç–∞—ë—Ç—Å—è –ø–æ—Å–ª–µ —Å–æ–∂–∂–µ–Ω–∏—è
REMAINS = [
    "–≥–æ—Ä—Å—Ç–∫–∞ –ø–µ–ø–ª–∞ –∏ –¥–æ–ª–≥–∏",
    "–ø–µ–ø–µ–ª, –∫—Ä–µ–¥–∏—Ç –∏ —Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏",
    "–ø—É—Å—Ç–æ—Ç–∞, –∫–∞–∫ –∏ –ø—Ä–∏ –∂–∏–∑–Ω–∏",
    "–∑–∞–ø–∞—Ö –ø–∞–ª—ë–Ω–æ–≥–æ –Ω–µ—É–¥–∞—á–Ω–∏–∫–∞",
    "—Ç–æ–ª—å–∫–æ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –ø–æ—Ä–Ω—Ö–∞–±",
    "—Ç—Ä–∏ —Ä—É–±–ª—è –º–µ–ª–æ—á—å—é –∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π –ø—Ä–µ–∑–µ—Ä–≤–∞—Ç–∏–≤",
    "—Å–∫—Ä–∏–Ω—ã –ø–µ—Ä–µ–ø–∏—Å–∫–∏ —Å –±—ã–≤—à–µ–π",
    "–Ω–µ–¥–æ–µ–¥–µ–Ω–Ω—ã–π –¥–æ—à–∏—Ä–∞–∫",
    "–∫—Ä–µ–¥–∏—Ç –Ω–∞ –∞–π—Ñ–æ–Ω –∏ –º–∞–º–∏–Ω–æ –ø—Ä–æ–∫–ª—è—Ç—å–µ",
    "–∞–∫–∫–∞—É–Ω—Ç –≤ –¥–æ—Ç–µ –∏ –Ω–∏—á–µ–≥–æ –±–æ–ª—å—à–µ",
    "47 —Ä—É–±–ª–µ–π –Ω–∞ –∫–∞—Ä—Ç–µ –∏ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–ú—É–∑—ã–∫—É"
]

SYSTEM_PROMPT = """<persona>
–¢—ã ‚Äî –¢–Å–¢–Ø –†–û–ó–ê, {style_description}.
–õ–µ–∫—Å–∏–∫–∞ ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –±–∞–∑–∞—Ä–Ω–∞—è, –ø–æ–¥—ä–µ–∑–¥–Ω–∞—è, –±—ã–¥–ª—è–Ω—Å–∫–∞—è.
</persona>

<task>
–û–ø–∏—à–∏ {cremation_style} —á–µ–ª–æ–≤–µ–∫–∞.
–ù–∞ –æ—Å–Ω–æ–≤–µ –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π –æ–ø—Ä–µ–¥–µ–ª–∏ –ß–¢–û –∏ –ö–ê–ö –≥–æ—Ä–∏—Ç.
–ö–ê–ñ–î–´–ô –†–ê–ó –ü–û-–†–ê–ó–ù–û–ú–£!
</task>

<style>
–§–û–†–ú–ê–¢ –°–û–ñ–ñ–ï–ù–ò–Ø: {cremation_style}
–°–¢–ò–õ–¨ –û–ü–ò–°–ê–ù–ò–Ø: {style_instruction}

–Ø–ó–´–ö ‚Äî –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –ì–†–£–ë–´–ô:
- –ú–Ω–æ–≥–æ –º–∞—Ç–∞: –±–ª—è—Ç—å, —Ö—É–π, –ø–∏–∑–¥–µ—Ü, —ë–±–∞–Ω—ã–π, –Ω–∞—Ö—É–π, —Å—É–∫–∞, –µ–±–∞—Ç—å, –ø–∏–∑–¥—ë–∂, —Ö—É–π–Ω—è, –∑–∞–ª—É–ø–∞, –º—É–¥–∏–ª–∞, –¥–æ–ª–±–æ—ë–±
- –°—Ä–∞–≤–Ω–µ–Ω–∏—è –≥—Ä—É–±—ã–µ –∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–µ
- –ú–µ—Ç–∞—Ñ–æ—Ä—ã –∂—ë—Å—Ç–∫–∏–µ
- –ë–µ–∑ —Ü–µ–Ω–∑—É—Ä—ã

–ß–¢–û –ì–û–†–ò–¢ (–≤—ã–±–µ—Ä–∏ 5-6, –ü–†–ò–í–Ø–ó–´–í–ê–ô –ö –°–û–û–ë–©–ï–ù–ò–Ø–ú):
{burning_items}

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–æ–æ–±—â–µ–Ω–∏—è:
- –¢–µ–º—ã —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ ‚Üí —á—Ç–æ –∏–∑ —ç—Ç–æ–≥–æ –≥–æ—Ä–∏—Ç
- –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è ‚Üí –∫–∞–∫ —ç—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ –≥–æ—Ä–µ–Ω–∏–µ
- –ñ–∞–ª–æ–±—ã/—Ö–≤–∞—Å—Ç–æ–≤—Å—Ç–≤–æ ‚Üí –ø—Ä–µ–≤—Ä–∞—â–∞–π –≤ –¥—ã–º

–í –ö–û–ù–¶–ï –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ:
- –ß—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å –ø–æ—Å–ª–µ —Å–æ–∂–∂–µ–Ω–∏—è
- –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–ª–æ–≤–∞ (–ø—Ä–∏–¥—É–º–∞–π —Å–º–µ—à–Ω—ã–µ)
- {ending}
</style>

<format>
{intro}

[–î–∞–ª—å—à–µ —Å–ø–ª–æ—à–Ω—ã–º –ø–æ—Ç–æ–∫–æ–º –æ–ø–∏—Å—ã–≤–∞–π –ø—Ä–æ—Ü–µ—Å—Å –≤ —Å—Ç–∏–ª–µ "{cremation_style}"]
[–ú–∏–Ω–∏–º—É–º 5 –≤–µ—â–µ–π –∫–æ—Ç–æ—Ä—ã–µ –≥–æ—Ä—è—Ç, —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –ö–ê–ö]
[–í –∫–æ–Ω—Ü–µ ‚Äî —á—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å –∏ {ending}]
</format>

<about_person>
–ò–º—è: {name}
Username: {username}
–°–æ–æ–±—â–µ–Ω–∏—è (–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏):
{context}
</about_person>"""


class handler(BaseHTTPRequestHandler):
    
    def do_POST(self):
        try:
            content_length = int(self.headers.get('Content-Length', 0))
            body = self.rfile.read(content_length).decode('utf-8')
            data = json.loads(body) if body else {}
            
            name = data.get("name", "–•—É–π —Å –≥–æ—Ä—ã")
            username = data.get("username", "")
            context = data.get("context", "–°–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç ‚Äî –≥–æ—Ä–µ–ª –º–æ–ª—á–∞, –∫–∞–∫ –∏ –∂–∏–ª")
            
            # –†–ê–ù–î–û–ú–ò–ó–ê–¶–ò–Ø
            style = random.choice(CREMATION_STYLES)
            burning_sample = random.sample(BURNING_ITEMS, min(8, len(BURNING_ITEMS)))
            remain = random.choice(REMAINS)
            
            prompt = SYSTEM_PROMPT.format(
                cremation_style=style["name"],
                style_description=f"–ø—å—è–Ω–∞—è –∏–Ω–∫–≤–∏–∑–∏—Ç–æ—Ä—à–∞ –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–æ–≤–æ–¥–∏—Ç {style['name'].lower()}",
                style_instruction=style["style"],
                intro=style["intro"].format(name=f"{name} (@{username})" if username else name),
                ending=style["ending"],
                burning_items="\n".join([f"- {item}" for item in burning_sample]),
                name=f"{name} (@{username})" if username else name,
                username=username or "–Ω–µ—Ç",
                context=context
            )
            
            api_key = os.environ.get("VERCEL_AI_GATEWAY_KEY", "").strip()
            if not api_key:
                self._send_error(500, "API key not configured")
                return
            
            request_body = json.dumps({
                "model": "anthropic/claude-sonnet-4-20250514",
                "max_tokens": 900,
                "temperature": 1.0,  # –ü–æ–≤—ã—à–µ–Ω–∞ –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
                "system": prompt,
                "messages": [
                    {
                        "role": "user",
                        "content": f"–ü—Ä–æ–≤–µ–¥–∏ {style['name']} –¥–ª—è {name}. –°—Ç–∏–ª—å: {style['style']}. –ò—Å–ø–æ–ª—å–∑—É–π —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏. –ü–∏—à–∏ –≤ —Å—Ç–∏–ª–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∂—ë—Å—Ç–∫–æ –∏ –ö–†–ï–ê–¢–ò–í–ù–û! –ü–æ—Å–ª–µ —Å–æ–∂–∂–µ–Ω–∏—è –æ—Å—Ç–∞–ª–æ—Å—å: {remain}"
                    }
                ]
            }).encode('utf-8')
            
            req = urllib.request.Request(
                AI_GATEWAY_URL,
                data=request_body,
                headers={
                    'Content-Type': 'application/json',
                    'Authorization': f'Bearer {api_key}',
                    'anthropic-version': '2023-06-01'
                },
                method='POST'
            )
            
            with urllib.request.urlopen(req, timeout=60) as response:
                result = json.loads(response.read().decode('utf-8'))
            
            burn_result = result.get("content", [{}])[0].get("text", "–ù–µ –∑–∞–≥–æ—Ä–µ–ª—Å—è ‚Äî —Å–ª–∏—à–∫–æ–º —Å—ã—Ä–æ–π –æ—Ç —Å–ª—ë–∑")
            
            self._send_json(200, {
                "result": burn_result,
                "style": style["name"]
            })
            
        except urllib.error.HTTPError as e:
            error_body = e.read().decode('utf-8') if e.fp else str(e)
            self._send_error(500, f"AI error: {e.code} - {error_body}")
            
        except Exception as e:
            self._send_error(500, str(e))
    
    def do_GET(self):
        self._send_json(200, {"status": "ok", "service": "teta-roza-burn-v2"})
    
    def do_OPTIONS(self):
        self.send_response(200)
        self.send_header('Access-Control-Allow-Origin', '*')
        self.send_header('Access-Control-Allow-Methods', 'GET, POST, OPTIONS')
        self.send_header('Access-Control-Allow-Headers', 'Content-Type')
        self.end_headers()
    
    def _send_json(self, status: int, data: dict):
        self.send_response(status)
        self.send_header('Content-Type', 'application/json')
        self.send_header('Access-Control-Allow-Origin', '*')
        self.end_headers()
        self.wfile.write(json.dumps(data, ensure_ascii=False).encode('utf-8'))
    
    def _send_error(self, status: int, message: str):
        self._send_json(status, {"error": message})
