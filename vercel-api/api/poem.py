"""
Vercel Serverless Function: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∏—Ö–æ–≤-—É–Ω–∏–∂–µ–Ω–∏–π –≤ —Å—Ç–∏–ª–µ —Ä—É—Å—Å–∫–∏—Ö –∫–ª–∞—Å—Å–∏–∫–æ–≤
"""
import json
import os
import random
import httpx

OPENROUTER_API_KEY = os.environ.get("OPENROUTER_API_KEY")

POETS = {
    "pushkin": {
        "name": "–ê.–°. –ü—É—à–∫–∏–Ω",
        "emoji": "ü™∂",
        "style": """–ü–∏—à–∏ –≤ —Å—Ç–∏–ª–µ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞ –ü—É—à–∫–∏–Ω–∞:
- –Ø–º–±–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä (—É–¥–∞—Ä–µ–Ω–∏–µ –Ω–∞ —á—ë—Ç–Ω—ã—Ö —Å–ª–æ–≥–∞—Ö)
- –†–∏—Ñ–º–æ–≤–∫–∞ ABAB (–ø–µ—Ä–µ–∫—Ä—ë—Å—Ç–Ω–∞—è)
- –≠–ª–µ–≥–∞–Ω—Ç–Ω—ã–π, –∏–∑—è—â–Ω—ã–π —Å–ª–æ–≥
- 2-3 —Å—Ç—Ä–æ—Ñ—ã –ø–æ 4 —Å—Ç—Ä–æ–∫–∏
- –ê—Ä—Ö–∞–∏–∑–º—ã: "—Å–µ–π", "—Ç–æ–∫–º–æ", "–¥–∞–±—ã", "–∫–æ–ª—å"
- –õ—ë–≥–∫–∞—è –∏—Ä–æ–Ω–∏—è, –Ω–æ —Å –¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–æ–º"""
    },
    "lermontov": {
        "name": "–ú.–Æ. –õ–µ—Ä–º–æ–Ω—Ç–æ–≤",
        "emoji": "‚öîÔ∏è",
        "style": """–ü–∏—à–∏ –≤ —Å—Ç–∏–ª–µ –ú–∏—Ö–∞–∏–ª–∞ –õ–µ—Ä–º–æ–Ω—Ç–æ–≤–∞:
- –†–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π, –º—Ä–∞—á–Ω—ã–π —Ç–æ–Ω
- –¢–µ–º–∞ –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–∞ –∏ —Å—Ç—Ä–∞–¥–∞–Ω–∏—è
- –†–∏—Ñ–º–æ–≤–∫–∞ ABAB –∏–ª–∏ AABB
- 2-3 —Å—Ç—Ä–æ—Ñ—ã –ø–æ 4 —Å—Ç—Ä–æ–∫–∏
- –î—Ä–∞–º–∞—Ç–∏–∑–º –∏ –Ω–∞–¥—Ä—ã–≤
- –ú–µ—Ç–∞—Ñ–æ—Ä—ã –±—É—Ä–∏, –º–æ—Ä—è, –∏–∑–≥–Ω–∞–Ω–∏—è"""
    },
    "mayakovsky": {
        "name": "–í.–í. –ú–∞—è–∫–æ–≤—Å–∫–∏–π",
        "emoji": "üì¢",
        "style": """–ü–∏—à–∏ –≤ —Å—Ç–∏–ª–µ –í–ª–∞–¥–∏–º–∏—Ä–∞ –ú–∞—è–∫–æ–≤—Å–∫–æ–≥–æ:
- –†—É–±–ª–µ–Ω—ã–π —Ä–∏—Ç–º, –∫–æ—Ä–æ—Ç–∫–∏–µ —Å—Ç—Ä–æ–∫–∏
- –ú–æ–∂–Ω–æ "–ª–µ—Å–µ–Ω–∫–æ–π" (—Ä–∞–∑–±–∏–≤–∞—Ç—å —Å—Ç—Ä–æ–∫—É –Ω–∞ —Å—Ç—É–ø–µ–Ω—å–∫–∏)
- –î–µ—Ä–∑–∫–æ, –≥—Ä–æ–º–∫–æ, –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω–æ
- –ù–µ–æ–ª–æ–≥–∏–∑–º—ã –∏ –Ω–µ–æ–±—ã—á–Ω—ã–µ —Å–ª–æ–≤–∞
- –û–±—Ä–∞—â–µ–Ω–∏—è: "–≠–π!", "–¢—ã!", "–°–ª—É—à–∞–π—Ç–µ!"
- –°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å–∞—Ç–∏—Ä–∞"""
    },
    "yesenin": {
        "name": "–°.–ê. –ï—Å–µ–Ω–∏–Ω",
        "emoji": "üåæ",
        "style": """–ü–∏—à–∏ –≤ —Å—Ç–∏–ª–µ –°–µ—Ä–≥–µ—è –ï—Å–µ–Ω–∏–Ω–∞:
- –ù–∞–ø–µ–≤–Ω–æ—Å—Ç—å, –º–µ–ª–æ–¥–∏—á–Ω–æ—Å—Ç—å
- –ù–∞—Ä–æ–¥–Ω—ã–µ –º–æ—Ç–∏–≤—ã
- –û–±—Ä–∞–∑—ã –ø—Ä–∏—Ä–æ–¥—ã (–±–µ—Ä—ë–∑–∞, —Ä–æ–∂—å, –ª—É–Ω–∞)
- –†–∏—Ñ–º–æ–≤–∫–∞ ABAB
- 2-3 —Å—Ç—Ä–æ—Ñ—ã –ø–æ 4 —Å—Ç—Ä–æ–∫–∏
- –õ—ë–≥–∫–∞—è –≥—Ä—É—Å—Ç—å –∏ —Ç–æ—Å–∫–∞
- –ú–æ–∂–Ω–æ –æ—Ç—Å—ã–ª–∫–∏ –∫ –µ–≥–æ –∑–Ω–∞–º–µ–Ω–∏—Ç—ã–º —Å—Ç—Ä–æ–∫–∞–º"""
    },
    "brodsky": {
        "name": "–ò.–ê. –ë—Ä–æ–¥—Å–∫–∏–π",
        "emoji": "üß†",
        "style": """–ü–∏—à–∏ –≤ —Å—Ç–∏–ª–µ –ò–æ—Å–∏—Ñ–∞ –ë—Ä–æ–¥—Å–∫–æ–≥–æ:
- –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π, —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–π
- –î–ª–∏–Ω–Ω—ã–µ, —Å–ª–æ–∂–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
- –†–∏—Ñ–º–æ–≤–∫–∞ ABAB –∏–ª–∏ ABBA
- 2 —Å—Ç—Ä–æ—Ñ—ã –ø–æ 4-6 —Å—Ç—Ä–æ–∫
- –û—Ç—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã–π —Ç–æ–Ω, –∫–∞–∫ –±—É–¥—Ç–æ –Ω–∞–±–ª—é–¥–∞–µ—à—å —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã
- –≠–∫–∑–∏—Å—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–µ–º—ã: –≤—Ä–µ–º—è, –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ, –ø—É—Å—Ç–æ—Ç–∞
- –ò—Ä–æ–Ω–∏—è —á–µ—Ä–µ–∑ –ø—Ä–µ—É–º–µ–Ω—å—à–µ–Ω–∏–µ"""
    }
}

SYSTEM_PROMPT = """
<persona>
–¢—ã ‚Äî –¢–Å–¢–Ø –†–û–ó–ê, –ø—å—è–Ω–∞—è —Ü—ã–≥–∞–Ω–∫–∞-–ø–æ—ç—Ç–µ—Å—Å–∞ –∏–∑ –ø–∞–Ω–µ–ª—å–∫–∏. –ë—ã–≤—à–∞—è —É—á–∏—Ç–µ–ª—å–Ω–∏—Ü–∞ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã, –∫–æ—Ç–æ—Ä—É—é –≤—ã–≥–Ω–∞–ª–∏ –∑–∞ "–Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –º–µ—Ç–æ–¥—ã –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è".
</persona>

<task>
–ù–∞–ø–∏—à–∏ —Å—Ç–∏—Ö–æ—Ç–≤–æ—Ä–µ–Ω–∏–µ-—É–Ω–∏–∂–µ–Ω–∏–µ –ø—Ä–æ —á–µ–ª–æ–≤–µ–∫–∞. –°—Ç–∏—Ö –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:
1. –° –ò–î–ï–ê–õ–¨–ù–´–ú–ò –†–ò–§–ú–ê–ú–ò (–æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–ª–æ–≤ –¥–æ–ª–∂–Ω—ã –∑–≤—É—á–∞—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤–æ!)
2. –° –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º (—Ä–∏—Ç–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–æ–≤–Ω—ã–º)
3. –° —á—ë—Ä–Ω—ã–º —é–º–æ—Ä–æ–º –∏ —Å–∞—Ä–∫–∞–∑–º–æ–º
4. –° –±—ã—Ç–æ–≤—ã–º–∏ –æ—Ç—Å—ã–ª–∫–∞–º–∏ (–∫—Ä–µ–¥–∏—Ç—ã, –∏–ø–æ—Ç–µ–∫–∞, –ü—è—Ç—ë—Ä–æ—á–∫–∞, –¥–æ—à–∏—Ä–∞–∫, –Ω–∏—â–µ—Ç–∞)
5. –ë–ï–ó –ø—Ä—è–º—ã—Ö –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏–π –≤–Ω–µ—à–Ω–æ—Å—Ç–∏
</task>

<rhyme_rules>
–í–ê–ñ–ù–û! –†–∏—Ñ–º—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –¢–û–ß–ù–´–ú–ò:
- –º–µ—á—Ç–ê–ï–®–¨ / –±–ª—É–∂–¥–ê–ï–®–¨ ‚úì
- —Ä—É–±–ª–Ø–• / –¥–æ–ª–≥–ê–• ‚úì  
- –≥–æ—Ä–Ø / –º–û—Ä—è ‚úó (—ç—Ç–æ –ù–ï —Ä–∏—Ñ–º–∞!)
- –¥–ï–ù–¨ / –ª–ï–ù–¨ ‚úì
- —Ä–∞–±–û–¢–ê / –∑–∞–±–û–¢–ê ‚úì
</rhyme_rules>

{poet_style}

<format>
–ù–∞—á–Ω–∏ —Å–æ —Å—Ç—Ä–æ–∫–∏: "{poet_emoji} –í —Å—Ç–∏–ª–µ {poet_name}:"
–ó–∞—Ç–µ–º —Å–∞–º–æ —Å—Ç–∏—Ö–æ—Ç–≤–æ—Ä–µ–Ω–∏–µ.
–í –∫–æ–Ω—Ü–µ –¥–æ–±–∞–≤—å –ø–æ–¥–ø–∏—Å—å: "‚Äî –¢—ë—Ç—è –†–æ–∑–∞, {poet_name} —Ä–∞–π–æ–Ω–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∞"
</format>

<about_person>
–ò–º—è: {name}
–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ —á–∞—Ç–∞: {context}
</about_person>
"""

async def generate_poem(name: str, context: str = "") -> dict:
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∏—Ö–∞ —á–µ—Ä–µ–∑ OpenRouter API"""
    
    if not OPENROUTER_API_KEY:
        return {"error": "API key not configured"}
    
    # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–≥–æ –ø–æ—ç—Ç–∞
    poet_id = random.choice(list(POETS.keys()))
    poet = POETS[poet_id]
    
    prompt = SYSTEM_PROMPT.format(
        poet_style=poet["style"],
        poet_emoji=poet["emoji"],
        poet_name=poet["name"],
        name=name,
        context=context or "–û–±—ã—á–Ω—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ —á–∞—Ç–∞, –ª—é–±–∏—Ç —Å–∏–¥–µ—Ç—å –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ"
    )
    
    try:
        async with httpx.AsyncClient(timeout=60.0) as client:
            response = await client.post(
                "https://openrouter.ai/api/v1/chat/completions",
                headers={
                    "Authorization": f"Bearer {OPENROUTER_API_KEY}",
                    "Content-Type": "application/json",
                },
                json={
                    "model": "anthropic/claude-sonnet-4",
                    "messages": [
                        {"role": "system", "content": prompt},
                        {"role": "user", "content": f"–ù–∞–ø–∏—à–∏ —Å—Ç–∏—Ö–æ—Ç–≤–æ—Ä–µ–Ω–∏–µ-—É–Ω–∏–∂–µ–Ω–∏–µ –ø—Ä–æ {name}. –°–¥–µ–ª–∞–π —Ä–∏—Ñ–º—ã –ò–î–ï–ê–õ–¨–ù–´–ú–ò!"}
                    ],
                    "max_tokens": 800,
                    "temperature": 0.9
                }
            )
            
            if response.status_code == 200:
                data = response.json()
                poem = data["choices"][0]["message"]["content"]
                return {
                    "poem": poem,
                    "poet": poet["name"],
                    "poet_id": poet_id
                }
            else:
                return {"error": f"API error: {response.status_code}"}
                
    except Exception as e:
        return {"error": str(e)}


def handler(request):
    """Vercel serverless handler"""
    import asyncio
    
    if request.method == "OPTIONS":
        return {
            "statusCode": 200,
            "headers": {
                "Access-Control-Allow-Origin": "*",
                "Access-Control-Allow-Methods": "POST, OPTIONS",
                "Access-Control-Allow-Headers": "Content-Type",
            },
            "body": ""
        }
    
    if request.method != "POST":
        return {
            "statusCode": 405,
            "body": json.dumps({"error": "Method not allowed"})
        }
    
    try:
        body = json.loads(request.body)
        name = body.get("name", "–ê–Ω–æ–Ω–∏–º")
        context = body.get("context", "")
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º async —Ñ—É–Ω–∫—Ü–∏—é
        result = asyncio.run(generate_poem(name, context))
        
        return {
            "statusCode": 200,
            "headers": {
                "Content-Type": "application/json",
                "Access-Control-Allow-Origin": "*"
            },
            "body": json.dumps(result, ensure_ascii=False)
        }
        
    except Exception as e:
        return {
            "statusCode": 500,
            "body": json.dumps({"error": str(e)})
        }
